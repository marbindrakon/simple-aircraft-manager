{% extends base_template %}
{% load static %}

{% block content %}
<div x-data="aircraftDetail('{{ aircraft_id }}', '{{ share_token|default:"" }}', '{{ privilege_level|default:"" }}')" @aircraft-updated.window="loadData()">
    <!-- Shared View Banner (public mode only) -->
    <div x-show="isPublicView" x-cloak class="pf-v5-c-alert pf-m-info pf-m-inline" style="margin-bottom: 1rem;">
        <div class="pf-v5-c-alert__icon"><i class="fas fa-info-circle"></i></div>
        <p class="pf-v5-c-alert__title">
            You are viewing a shared, read-only view of <strong x-text="aircraft?.tail_number || '...'"></strong>.
        </p>
    </div>

    <!-- Page Header -->
    <div class="pf-v5-c-page__main-section pf-m-light">
        <div class="pf-v5-c-content">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <h1 x-text="aircraft?.tail_number || 'Loading...'"></h1>
                            <!-- Aircraft Switcher -->
                            <div x-show="!isPublicView && (switcherAircraft.length > 0 || !switcherLoaded)" x-cloak
                                 class="aircraft-switcher" @click.outside="switcherOpen = false">
                                <button class="aircraft-switcher__toggle" @click="toggleSwitcher()"
                                        title="Switch aircraft">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <div class="aircraft-switcher__menu" x-show="switcherOpen" x-cloak>
                                    <template x-if="!switcherLoaded">
                                        <div class="aircraft-switcher__empty">Loading...</div>
                                    </template>
                                    <template x-if="switcherLoaded && switcherAircraft.length === 0">
                                        <div class="aircraft-switcher__empty">No other aircraft</div>
                                    </template>
                                    <template x-for="ac in switcherAircraft" :key="ac.id">
                                        <button class="aircraft-switcher__item" @click="navigateToAircraft(ac.id)">
                                            <span class="aircraft-switcher__status-dot"
                                                  :style="'background:' + (ac.airworthiness?.status === 'GREEN' ? 'var(--pf-v5-global--success-color--100)' : ac.airworthiness?.status === 'ORANGE' ? 'var(--pf-v5-global--warning-color--100)' : ac.airworthiness?.status === 'RED' ? 'var(--pf-v5-global--danger-color--100)' : 'var(--pf-v5-global--Color--200)')">
                                            </span>
                                            <span x-text="ac.tail_number" style="font-weight: 600;"></span>
                                            <span x-text="ac.make + ' ' + ac.model" style="color: var(--pf-v5-global--Color--200); font-size: 0.8rem;"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <p x-show="aircraft">
                            <span x-text="aircraft?.make"></span>
                            <span x-text="aircraft?.model"></span>
                        </p>
                    </div>
                    <!-- Airworthiness Status Badge -->
                    <div x-show="aircraft" x-cloak
                         class="airworthiness-badge"
                         :class="getAirworthinessClass()"
                         :title="getAirworthinessTooltip()">
                        <span class="status-icon">
                            <template x-if="aircraft?.airworthiness?.status === 'GREEN'">
                                <i class="fas fa-check-circle"></i>
                            </template>
                            <template x-if="aircraft?.airworthiness?.status === 'ORANGE'">
                                <i class="fas fa-exclamation-triangle"></i>
                            </template>
                            <template x-if="aircraft?.airworthiness?.status === 'RED'">
                                <i class="fas fa-times-circle"></i>
                            </template>
                        </span>
                        <span class="status-text" x-text="getAirworthinessText()"></span>
                    </div>
                    <!-- Current Hours -->
                    <div x-show="aircraft" x-cloak style="display: flex; align-items: baseline; gap: 0.4rem; margin-left: 0.5rem; color: var(--pf-v5-global--Color--200);">
                        <span style="font-size: 0.85rem;">Current Hours</span>
                        <span class="hours-display" style="font-size: 1.25rem;" x-text="formatHours(aircraft?.flight_time)"></span>
                    </div>
                </div>
                <div x-show="aircraft" x-cloak style="display: flex; gap: 0.5rem;">
                    <button class="pf-v5-c-button pf-m-primary"
                            x-show="canUpdateHours"
                            @click="openHoursModal()"
                            :disabled="aircraft?.airworthiness?.status === 'RED'">
                        Update Hours
                    </button>
                    <button class="pf-v5-c-button pf-m-secondary"
                            x-show="isOwner"
                            @click="openEditModal()">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="pf-v5-c-button pf-m-danger"
                            x-show="isOwner"
                            @click="openDeleteModal()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="pf-v5-c-page__main-section" x-show="loading" x-cloak>
        <div class="pf-v5-c-empty-state">
            <div class="pf-v5-c-empty-state__content">
                <div class="loading-spinner" style="width: 3rem; height: 3rem;"></div>
                <h2 class="pf-v5-c-title pf-m-lg">Loading aircraft data...</h2>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="pf-v5-c-page__main-section" x-show="!loading && aircraft" x-cloak>
        <div class="pf-v5-c-tabs pf-m-scrollable" role="region" x-data="tabScroller()">
            <button class="pf-v5-c-tabs__scroll-button" aria-label="Scroll tabs left"
                    :disabled="!canScrollLeft" @click="scrollTabsLeft()">
                <i class="fas fa-angle-left" aria-hidden="true"></i>
            </button>
            <ul class="pf-v5-c-tabs__list" x-ref="tabList">
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activePrimaryTab === 'overview' }">
                    <button class="pf-v5-c-tabs__link" @click="switchPrimaryTab('overview')">
                        <span class="pf-v5-c-tabs__item-text">Overview</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activePrimaryTab === 'components' }">
                    <button class="pf-v5-c-tabs__link" @click="switchPrimaryTab('components')">
                        <span class="pf-v5-c-tabs__item-text">Components</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activePrimaryTab === 'squawks' }">
                    <button class="pf-v5-c-tabs__link" @click="switchPrimaryTab('squawks')">
                        <span class="pf-v5-c-tabs__item-text">Squawks</span>
                        <template x-if="activeSquawks.length > 0">
                            <span class="pf-v5-c-badge pf-m-unread" style="margin-left: 0.5rem;" x-text="activeSquawks.length"></span>
                        </template>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activePrimaryTab === 'compliance' }">
                    <button class="pf-v5-c-tabs__link" @click="switchPrimaryTab('compliance')">
                        <span class="pf-v5-c-tabs__item-text">Compliance</span>
                        <template x-if="complianceIssueCount > 0">
                            <span class="pf-v5-c-badge pf-m-unread" style="margin-left: 0.5rem;" x-text="complianceIssueCount"></span>
                        </template>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" x-show="isMaintenance" :class="{ 'pf-m-current': activePrimaryTab === 'records' }">
                    <button class="pf-v5-c-tabs__link" @click="switchPrimaryTab('records')">
                        <span class="pf-v5-c-tabs__item-text">Records</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activePrimaryTab === 'consumables' }">
                    <button class="pf-v5-c-tabs__link" @click="switchPrimaryTab('consumables')">
                        <span class="pf-v5-c-tabs__item-text">Consumables</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activePrimaryTab === 'documents' }">
                    <button class="pf-v5-c-tabs__link" @click="switchPrimaryTab('documents')">
                        <span class="pf-v5-c-tabs__item-text">Documents</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" x-show="isOwner" :class="{ 'pf-m-current': activePrimaryTab === 'roles' }">
                    <button class="pf-v5-c-tabs__link" @click="switchPrimaryTab('roles')">
                        <span class="pf-v5-c-tabs__item-text">Sharing &amp; Access</span>
                    </button>
                </li>
            </ul>
            <button class="pf-v5-c-tabs__scroll-button" aria-label="Scroll tabs right"
                    :disabled="!canScrollRight" @click="scrollTabsRight()">
                <i class="fas fa-angle-right" aria-hidden="true"></i>
            </button>
        </div>

        <!-- Overview Tab -->
        <div x-show="activeTab === 'overview'" class="pf-v5-c-page__main-section">
            <div class="pf-l-gallery pf-m-gutter">
                <!-- Aircraft Info Card -->
                <div class="pf-v5-c-card">
                    <div class="pf-v5-c-card__title">
                        <h2>Aircraft Information</h2>
                    </div>
                    <div class="pf-v5-c-card__body">
                        <div class="aircraft-info-container">
                            <!-- Aircraft Image -->
                            <div x-show="aircraft?.picture" class="aircraft-image">
                                <img :src="aircraft?.picture"
                                     :alt="aircraft?.tail_number + ' photo'">
                            </div>
                            <!-- Aircraft Details -->
                            <div class="aircraft-details">
                                <dl>
                                    <dt>Tail Number:</dt>
                                    <dd x-text="aircraft?.tail_number"></dd>
                                    <dt>Make:</dt>
                                    <dd x-text="aircraft?.make"></dd>
                                    <dt>Model:</dt>
                                    <dd x-text="aircraft?.model"></dd>
                                    <dt>Status:</dt>
                                    <dd>
                                        <span class="pf-v5-c-label pf-m-blue" x-text="aircraft?.status"></span>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Card -->
                <div class="pf-v5-c-card">
                    <div class="pf-v5-c-card__header">
                        <div class="pf-v5-c-card__header-main">
                            <div class="pf-v5-c-card__title">
                                <h2>Notes</h2>
                            </div>
                        </div>
                        <div class="pf-v5-c-card__actions">
                            <button class="pf-v5-c-button pf-m-plain" x-show="canCreateNote" @click="openNoteModal()" title="Add Note">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pf-v5-c-card__body">
                        <template x-if="aircraftNotes.length === 0">
                            <p style="color: var(--pf-v5-global--Color--200);">No notes yet</p>
                        </template>
                        <template x-if="aircraftNotes.length > 0">
                            <div class="notes-list">
                                <template x-for="note in aircraftNotes.slice(0, 3)" :key="note.id">
                                    <div class="note-item" @click="isPublicView ? viewNote(note) : editNote(note)" :style="isPublicView ? '' : 'cursor: pointer;'">
                                        <p class="note-text" x-text="note.text"></p>
                                        <div class="note-meta">
                                            <span x-text="formatDate(note.added_timestamp)"></span>
                                            <template x-if="note.added_by_username">
                                                <span> - <span x-text="note.added_by_username"></span></span>
                                            </template>
                                            <template x-if="note.edited_timestamp">
                                                <span class="note-edited">(edited)</span>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="aircraftNotes.length > 3">
                                    <p style="text-align: center; margin-top: 0.5rem;">
                                        <a href="#" @click.prevent="showAllNotes = true" class="pf-v5-c-button pf-m-link pf-m-inline">
                                            View all <span x-text="aircraftNotes.length"></span> notes
                                        </a>
                                    </p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Recent Activity Card -->
                <div class="pf-v5-c-card" x-show="!isPublicView">
                    <div class="pf-v5-c-card__header">
                        <div class="pf-v5-c-card__header-main">
                            <div class="pf-v5-c-card__title">
                                <h2>Recent Activity</h2>
                            </div>
                        </div>
                        <div class="pf-v5-c-card__actions">
                            <button class="pf-v5-c-button pf-m-link pf-m-small" @click="openEventsHistory()">
                                View full history
                            </button>
                        </div>
                    </div>
                    <div class="pf-v5-c-card__body">
                        <template x-if="!eventsLoaded">
                            <div style="text-align: center; padding: 1rem;">
                                <span class="pf-v5-c-spinner pf-m-md" role="progressbar">
                                    <span class="pf-v5-c-spinner__clipper"></span>
                                    <span class="pf-v5-c-spinner__lead-ball"></span>
                                    <span class="pf-v5-c-spinner__tail-ball"></span>
                                </span>
                            </div>
                        </template>
                        <template x-if="eventsLoaded && recentEvents.length === 0">
                            <p style="color: var(--pf-v5-global--Color--200); text-align: center; padding: 1rem;">
                                No activity recorded yet.
                            </p>
                        </template>
                        <template x-if="eventsLoaded && recentEvents.length > 0">
                            <div>
                                <template x-for="event in recentEvents" :key="event.id">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem 0; border-bottom: 1px solid var(--pf-v5-global--BorderColor--100); font-size: 0.85em;">
                                        <span class="pf-v5-c-label pf-m-compact" :class="eventCategoryClass(event.category)">
                                            <span class="pf-v5-c-label__content" x-text="eventCategoryLabel(event.category)"></span>
                                        </span>
                                        <span x-text="event.event_name" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                                        <span style="color: var(--pf-v5-global--Color--200); white-space: nowrap;" x-text="formatEventTime(event.timestamp)"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Airworthiness Issues Section -->
            <template x-if="aircraft?.airworthiness?.issue_count > 0">
                <div class="pf-v5-c-card" style="margin-top: 1.5rem;"
                     :class="{ 'card-border-red': aircraft?.airworthiness?.status === 'RED', 'card-border-orange': aircraft?.airworthiness?.status === 'ORANGE' }">
                    <div class="pf-v5-c-card__header">
                        <div class="pf-v5-c-card__header-main">
                            <div class="pf-v5-c-card__title">
                                <h2>Airworthiness Issues</h2>
                            </div>
                        </div>
                        <div class="pf-v5-c-card__actions">
                            <template x-if="aircraft?.airworthiness?.red_count > 0">
                                <span class="pf-v5-c-label pf-m-red">
                                    <span x-text="aircraft.airworthiness.red_count + ' Grounding'"></span>
                                </span>
                            </template>
                            <template x-if="aircraft?.airworthiness?.orange_count > 0">
                                <span class="pf-v5-c-label pf-m-orange" style="margin-left: 0.5rem;">
                                    <span x-text="aircraft.airworthiness.orange_count + ' Upcoming'"></span>
                                </span>
                            </template>
                        </div>
                    </div>
                    <div class="pf-v5-c-card__body">
                        <div class="airworthiness-issues">
                            <template x-for="issue in aircraft?.airworthiness?.issues || []" :key="issue.item_id">
                                <div class="issue-item" :class="'issue-severity-' + issue.severity.toLowerCase()">
                                    <div class="issue-icon" :class="'icon-' + issue.severity.toLowerCase()">
                                        <template x-if="issue.severity === 'RED'">
                                            <i class="fas fa-times-circle"></i>
                                        </template>
                                        <template x-if="issue.severity === 'ORANGE'">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </template>
                                    </div>
                                    <div class="issue-content">
                                        <div class="issue-category" x-text="issue.category"></div>
                                        <div class="issue-title" x-text="issue.title"></div>
                                        <div class="issue-description" x-text="issue.description"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>

        </div>

        <!-- Events History Modal (hidden in public mode) -->
        <template x-if="!isPublicView && eventsHistoryOpen">
            <div class="pf-v5-c-backdrop">
                <div class="pf-v5-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-label="Activity History">
                    <div class="pf-v5-c-modal-box__close">
                        <button class="pf-v5-c-button pf-m-plain" @click="closeEventsHistory()" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <header class="pf-v5-c-modal-box__header">
                        <h1 class="pf-v5-c-modal-box__title">Activity History</h1>
                    </header>
                    <div class="pf-v5-c-modal-box__body" style="max-height: 60vh; overflow-y: auto;">
                        <div style="margin-bottom: 1rem;">
                            <select class="pf-v5-c-form-control"
                                    x-model="eventsHistoryCategory"
                                    @change="loadEventsHistory()"
                                    style="max-width: 200px;">
                                <option value="">All Categories</option>
                                <option value="hours">Hours</option>
                                <option value="component">Component</option>
                                <option value="squawk">Squawk</option>
                                <option value="note">Note</option>
                                <option value="oil">Oil</option>
                                <option value="fuel">Fuel</option>
                                <option value="logbook">Logbook</option>
                                <option value="ad">AD</option>
                                <option value="inspection">Inspection</option>
                                <option value="document">Document</option>
                            </select>
                            <span style="margin-left: 0.75rem; color: var(--pf-v5-global--Color--200);">
                                <span x-text="eventsHistoryTotal"></span> total events
                            </span>
                        </div>

                        <template x-if="eventsHistoryLoading">
                            <div style="text-align: center; padding: 2rem;">
                                <span class="pf-v5-c-spinner pf-m-lg" role="progressbar">
                                    <span class="pf-v5-c-spinner__clipper"></span>
                                    <span class="pf-v5-c-spinner__lead-ball"></span>
                                    <span class="pf-v5-c-spinner__tail-ball"></span>
                                </span>
                            </div>
                        </template>
                        <template x-if="!eventsHistoryLoading && eventsHistoryAll.length === 0">
                            <p style="text-align: center; padding: 2rem; color: var(--pf-v5-global--Color--200);">
                                No events found.
                            </p>
                        </template>
                        <template x-if="!eventsHistoryLoading && eventsHistoryAll.length > 0">
                            <div class="pf-v5-c-data-list" role="list">
                                <template x-for="event in eventsHistoryAll" :key="event.id">
                                    <div class="pf-v5-c-data-list__item" role="listitem">
                                        <div class="pf-v5-c-data-list__item-row" style="padding: 0.5rem 0;">
                                            <div class="pf-v5-c-data-list__item-content" style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                                <span class="pf-v5-c-label pf-m-compact" :class="eventCategoryClass(event.category)">
                                                    <span class="pf-v5-c-label__content" x-text="eventCategoryLabel(event.category)"></span>
                                                </span>
                                                <span x-text="event.event_name" style="flex: 1;"></span>
                                                <span x-show="event.user_display" style="color: var(--pf-v5-global--Color--200); font-size: 0.85em;" x-text="event.user_display"></span>
                                                <span style="color: var(--pf-v5-global--Color--200); font-size: 0.85em; white-space: nowrap;" x-text="formatEventTime(event.timestamp)"></span>
                                            </div>
                                            <template x-if="event.notes">
                                                <div style="padding-left: 5.5rem; color: var(--pf-v5-global--Color--200); font-size: 0.85em;" x-text="event.notes"></div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                    <footer class="pf-v5-c-modal-box__footer">
                        <button class="pf-v5-c-button pf-m-link" @click="closeEventsHistory()">Close</button>
                    </footer>
                </div>
            </div>
        </template>

        <!-- Components Tab -->
        <div x-show="activeTab === 'components'" class="pf-v5-c-page__main-section">
            <!-- Header with Add Button -->
            <div class="tab-section-header">
                <h2>Components</h2>
                <button class="pf-v5-c-button pf-m-primary" x-show="isOwner" @click="openComponentModal()">
                    <i class="fas fa-plus"></i> Add Component
                </button>
            </div>

            <table class="pf-v5-c-table pf-m-striped components-table">
                <thead>
                    <tr>
                        <th style="width: 2rem;"></th>
                        <th>Type</th>
                        <th>Manufacturer/Model</th>
                        <th>In Service</th>
                        <th>Since OH/SVC</th>
                        <th>Remaining</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-if="components.length === 0">
                        <tr>
                            <td colspan="8" style="text-align: center;">No components found</td>
                        </tr>
                    </template>
                </tbody>
                <template x-for="component in sortedComponents" :key="component.id">
                    <tbody class="component-row-group"
                           :class="{'component-child': getComponentDepth(component) > 0}"
                           :style="'--component-depth: ' + getComponentDepth(component)">
                        <tr>
                            <td class="pf-v5-c-table__toggle">
                                <button class="pf-v5-c-button pf-m-plain"
                                        @click="toggleComponentExpand(component.id)"
                                        :aria-expanded="isComponentExpanded(component.id).toString()">
                                    <i class="fas fa-angle-right"
                                       :style="isComponentExpanded(component.id) ? 'transform: rotate(90deg)' : ''"></i>
                                </button>
                            </td>
                            <td data-label="Type">
                                <div style="display: flex; align-items: center; gap: 0.25rem; flex-wrap: wrap;">
                                    <span :style="'padding-left: ' + (getComponentDepth(component) * 1.5) + 'rem'" class="component-type-indent">
                                        <template x-if="getComponentDepth(component) > 0">
                                            <i class="fas fa-level-up-alt fa-rotate-90" style="color: var(--pf-v5-global--Color--200); margin-right: 0.25rem; font-size: 0.75rem;"></i>
                                        </template>
                                        <span x-text="getComponentTypeName(component)"></span>
                                    </span>
                                    <template x-if="component.install_location">
                                        <span class="pf-v5-c-label pf-m-compact pf-m-grey"
                                              x-text="component.install_location"></span>
                                    </template>
                                    <template x-if="component.replacement_critical">
                                        <span class="pf-v5-c-label pf-m-compact pf-m-purple" title="Service Interval">
                                            <i class="fas fa-sync-alt"></i>
                                        </span>
                                    </template>
                                </div>
                                <div class="component-parent-breadcrumb"
                                     x-show="component.parent_component_id"
                                     x-text="getParentBreadcrumb(component)"></div>
                            </td>
                            <td data-label="Manufacturer/Model" x-text="`${component.manufacturer} ${component.model}`"></td>
                            <td data-label="In Service">
                                <div x-text="formatHours(component.hours_in_service || 0)"></div>
                                <div x-show="getCalendarTimeSince(component.date_in_service)"
                                     x-text="'(' + getCalendarTimeSince(component.date_in_service) + ')'"
                                     style="color: var(--pf-v5-global--Color--200); font-size: 0.85em;"></div>
                            </td>
                            <td data-label="Since OH/SVC">
                                <div x-text="(component.hours_since_overhaul > 0) ? formatHours(component.hours_since_overhaul) : '—'"></div>
                                <div x-show="component.overhaul_date && getCalendarTimeSince(component.overhaul_date)"
                                     x-text="'(' + getCalendarTimeSince(component.overhaul_date) + ')'"
                                     style="color: var(--pf-v5-global--Color--200); font-size: 0.85em;"></div>
                            </td>
                            <td data-label="Remaining" :class="getHoursRemainingClass(component)">
                                <!-- Desktop: hours remaining + label -->
                                <div class="component-remaining-desktop">
                                    <div x-text="getHoursRemainingDisplay(component)"></div>
                                    <div x-show="getRemainingLabel(component)"
                                         x-text="getRemainingLabel(component)"
                                         style="color: var(--pf-v5-global--Color--200); font-size: 0.85em;"></div>
                                </div>
                                <!-- Mobile: fraction + progress bar (hidden on desktop via CSS) -->
                                <div class="component-remaining-mobile">
                                    <template x-if="getIntervalFraction(component)">
                                        <div>
                                            <div class="component-fraction"
                                                 x-text="getFractionText(component)"></div>
                                            <div class="component-progress-track">
                                                <div class="component-progress-fill"
                                                     :class="getHoursRemainingClass(component)"
                                                     :style="'width: ' + getProgressPercent(component) + '%;'"></div>
                                            </div>
                                            <div x-show="getRemainingLabel(component)"
                                                 x-text="getRemainingLabel(component)"
                                                 class="component-fraction-sublabel"></div>
                                        </div>
                                    </template>
                                    <template x-if="!getIntervalFraction(component)">
                                        <div x-text="getHoursRemainingDisplay(component)"></div>
                                    </template>
                                </div>
                            </td>
                            <td data-label="Status">
                                <span class="pf-v5-c-label"
                                      :class="getStatusClass(component)"
                                      x-text="component.status"></span>
                            </td>
                            <td data-label="Actions">
                                <div x-show="isOwner" style="display: flex; gap: 0.25rem;">
                                    <button class="pf-v5-c-button pf-m-plain"
                                            @click="editComponent(component)"
                                            title="Edit component">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <template x-if="component.replacement_critical && component.status === 'IN-USE'">
                                        <button class="pf-v5-c-button pf-m-plain"
                                                @click="openServiceResetModal(component)"
                                                :title="'Reset ' + getComponentTypeName(component) + ' service time'">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    </template>
                                    <button class="pf-v5-c-button pf-m-plain pf-m-danger"
                                            @click="deleteComponent(component)"
                                            title="Delete component">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr x-show="isComponentExpanded(component.id)"
                            :class="{'pf-m-expanded': isComponentExpanded(component.id)}"
                            class="pf-v5-c-table__expandable-row">
                            <td></td>
                            <td colspan="7" style="padding: 0.75rem 1rem;">

                                <!-- Row 1: Serial Number | Notes -->
                                <div class="component-detail-grid" style="display: grid; grid-template-columns: auto 1fr; gap: 1.5rem; margin-bottom: 1rem; align-items: start;">
                                    <div>
                                        <div style="font-size: 0.75em; font-weight: 600; text-transform: uppercase; color: var(--pf-v5-global--Color--200); margin-bottom: 0.4rem;">Serial Number</div>
                                        <div x-show="component.serial_number" x-text="component.serial_number"></div>
                                        <div x-show="!component.serial_number" style="color: var(--pf-v5-global--Color--200);">—</div>
                                    </div>
                                    <div x-show="component.notes">
                                        <div style="font-size: 0.75em; font-weight: 600; text-transform: uppercase; color: var(--pf-v5-global--Color--200); margin-bottom: 0.4rem;">Notes</div>
                                        <div x-text="component.notes" style="white-space: pre-wrap;"></div>
                                    </div>
                                </div>

                                <!-- Row 2: In Service | Since OH/SVC | Calendar Remaining -->
                                <div class="component-detail-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;">
                                    <div>
                                        <div style="font-size: 0.75em; font-weight: 600; text-transform: uppercase; color: var(--pf-v5-global--Color--200); margin-bottom: 0.4rem;">In Service</div>
                                        <div style="font-size: 1.1em; font-weight: 600;" x-text="formatHours(component.hours_in_service || 0)"></div>
                                        <div x-show="getCalendarTimeSince(component.date_in_service)"
                                             x-text="getCalendarTimeSince(component.date_in_service)"></div>
                                        <div x-show="component.date_in_service"
                                             x-text="'Since ' + formatDate(component.date_in_service)"
                                             style="color: var(--pf-v5-global--Color--200); font-size: 0.85em;"></div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75em; font-weight: 600; text-transform: uppercase; color: var(--pf-v5-global--Color--200); margin-bottom: 0.4rem;">Since OH/SVC</div>
                                        <template x-if="component.hours_since_overhaul > 0 || component.overhaul_date">
                                            <div>
                                                <div style="font-size: 1.1em; font-weight: 600;" x-text="formatHours(component.hours_since_overhaul || 0)"></div>
                                                <div x-show="component.overhaul_date && getCalendarTimeSince(component.overhaul_date)"
                                                     x-text="getCalendarTimeSince(component.overhaul_date)"></div>
                                                <div x-show="component.overhaul_date"
                                                     x-text="'Since ' + formatDate(component.overhaul_date)"
                                                     style="color: var(--pf-v5-global--Color--200); font-size: 0.85em;"></div>
                                            </div>
                                        </template>
                                        <template x-if="!(component.hours_since_overhaul > 0 || component.overhaul_date)">
                                            <div style="color: var(--pf-v5-global--Color--200);">Not recorded</div>
                                        </template>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75em; font-weight: 600; text-transform: uppercase; color: var(--pf-v5-global--Color--200); margin-bottom: 0.4rem;">Calendar Remaining</div>
                                        <template x-if="getCalendarDaysRemaining(component) !== null">
                                            <div>
                                                <div style="font-size: 1.1em; font-weight: 600;"
                                                     :class="getCalendarRemainingClass(component)"
                                                     x-text="formatDuration(getCalendarDaysRemaining(component))"></div>
                                                <div x-show="getDueDate(component)"
                                                     x-text="'Due ' + formatDate(getDueDate(component))"
                                                     style="color: var(--pf-v5-global--Color--200); font-size: 0.85em;"></div>
                                            </div>
                                        </template>
                                        <template x-if="getCalendarDaysRemaining(component) === null">
                                            <div style="color: var(--pf-v5-global--Color--200);">—</div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Row 3: Tracking Settings -->
                                <div style="margin-bottom: 0;">
                                    <div style="font-size: 0.75em; font-weight: 600; text-transform: uppercase; color: var(--pf-v5-global--Color--200); margin-bottom: 0.5rem;">Tracking</div>
                                    <div class="component-detail-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                                        <!-- TBO -->
                                        <div>
                                            <div style="display: flex; align-items: center; gap: 0.35rem; flex-wrap: wrap;">
                                                <span class="pf-v5-c-label pf-m-compact"
                                                      :class="component.tbo_critical ? 'pf-m-blue' : 'pf-m-grey'">
                                                    TBO
                                                </span>
                                                <template x-if="component.tbo_critical && component.on_condition">
                                                    <span class="pf-v5-c-label pf-m-compact pf-m-cyan" title="Reliability-Centered / On-Condition maintenance — over-TBO operation is intentional">
                                                        On-Condition
                                                    </span>
                                                </template>
                                            </div>
                                            <template x-if="component.tbo_critical">
                                                <div style="margin-top: 0.3rem; font-size: 0.9em;">
                                                    <div x-show="component.tbo_hours" x-text="component.tbo_hours + ' hr'"></div>
                                                    <div x-show="component.tbo_days" x-text="component.tbo_days + ' days'" style="color: var(--pf-v5-global--Color--200);"></div>
                                                    <div x-show="!component.tbo_hours && !component.tbo_days" style="color: var(--pf-v5-global--Color--200);">No limit set</div>
                                                </div>
                                            </template>
                                            <template x-if="!component.tbo_critical">
                                                <div style="margin-top: 0.3rem; font-size: 0.85em; color: var(--pf-v5-global--Color--200);">Disabled</div>
                                            </template>
                                        </div>
                                        <!-- Service Interval -->
                                        <div>
                                            <span class="pf-v5-c-label pf-m-compact"
                                                  :class="component.replacement_critical ? 'pf-m-purple' : 'pf-m-grey'">
                                                Service Interval
                                            </span>
                                            <template x-if="component.replacement_critical">
                                                <div style="margin-top: 0.3rem; font-size: 0.9em;">
                                                    <div x-show="component.replacement_hours" x-text="component.replacement_hours + ' hr'"></div>
                                                    <div x-show="component.replacement_days" x-text="component.replacement_days + ' days'" style="color: var(--pf-v5-global--Color--200);"></div>
                                                    <div x-show="!component.replacement_hours && !component.replacement_days" style="color: var(--pf-v5-global--Color--200);">No limit set</div>
                                                </div>
                                            </template>
                                            <template x-if="!component.replacement_critical">
                                                <div style="margin-top: 0.3rem; font-size: 0.85em; color: var(--pf-v5-global--Color--200);">Disabled</div>
                                            </template>
                                        </div>
                                        <!-- Inspection -->
                                        <div>
                                            <span class="pf-v5-c-label pf-m-compact"
                                                  :class="component.inspection_critical ? 'pf-m-green' : 'pf-m-grey'">
                                                Inspection
                                            </span>
                                            <template x-if="component.inspection_critical">
                                                <div style="margin-top: 0.3rem; font-size: 0.9em;">
                                                    <div x-show="component.inspection_hours" x-text="component.inspection_hours + ' hr'"></div>
                                                    <div x-show="component.inspection_days" x-text="component.inspection_days + ' days'" style="color: var(--pf-v5-global--Color--200);"></div>
                                                    <div x-show="!component.inspection_hours && !component.inspection_days" style="color: var(--pf-v5-global--Color--200);">No limit set</div>
                                                </div>
                                            </template>
                                            <template x-if="!component.inspection_critical">
                                                <div style="margin-top: 0.3rem; font-size: 0.85em; color: var(--pf-v5-global--Color--200);">Disabled</div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                            </td>
                        </tr>
                    </tbody>
                </template>
            </table>
        </div>

        <!-- Logbook Tab (Records group) -->
        <div x-show="activeTab === 'logbook'" class="pf-v5-c-page__main-section">
            <div class="tab-subtab-bar">
                <div class="pf-v5-c-toggle-group">
                    <div class="pf-v5-c-toggle-group__item">
                        <button class="pf-v5-c-toggle-group__button pf-m-selected">Logbook</button>
                    </div>
                    <div class="pf-v5-c-toggle-group__item">
                        <button class="pf-v5-c-toggle-group__button" @click="activeTab = 'major-records'">Repairs &amp; Alterations</button>
                    </div>
                </div>
                <button class="pf-v5-c-button pf-m-primary" x-show="isOwner" @click="openLogbookModal()">
                    <i class="fas fa-plus"></i> New Entry
                </button>
            </div>
            <div class="tab-section-header">
                <!-- Logbook type filter toggle group -->
                <div class="pf-v5-c-toggle-group">
                    <template x-for="tab in ['ALL', 'AC', 'ENG', 'PROP', 'OTHER']" :key="tab">
                        <div class="pf-v5-c-toggle-group__item">
                            <button class="pf-v5-c-toggle-group__button"
                                    :class="{ 'pf-m-selected': logbookActiveTab === tab }"
                                    @click="switchLogbookTab(tab)"
                                    x-text="logbookTabLabel(tab)">
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Loading -->
            <div x-show="!logbookLoaded" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading logbook...</h2>
                </div>
            </div>

            <div x-show="logbookLoaded" x-cloak>
                <!-- Filter bar -->
                <div style="display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
                    <input type="search"
                           class="pf-v5-c-form-control"
                           placeholder="Search entries..."
                           x-model="logbookSearch"
                           @input="onLogbookSearchInput()"
                           style="flex: 1; min-width: 200px; max-width: 400px;">
                    <select class="pf-v5-c-form-control"
                            x-model="logbookEntryTypeFilter"
                            @change="loadLogbookEntries(false)"
                            style="width: auto;">
                        <option value="">All Types</option>
                        <option value="MAINTENANCE">Maintenance</option>
                        <option value="INSPECTION">Inspection</option>
                        <option value="FLIGHT">Flight</option>
                        <option value="HOURS_UPDATE">Hours Update</option>
                        <option value="OTHER">Other</option>
                    </select>
                    <span style="color: var(--pf-v5-global--Color--200); font-size: 0.875rem;"
                          x-show="logbookTotal > 0"
                          x-text="`${logbookTotal} entr${logbookTotal === 1 ? 'y' : 'ies'}`">
                    </span>
                </div>

                <template x-if="logbookEntries.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-book" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg"
                                x-text="logbookActiveTab === 'ALL' ? 'No logbook entries' :
                                        `No ${logbookTabLabel(logbookActiveTab)} logbook entries`">
                            </h2>
                            <div class="pf-v5-c-empty-state__body"
                                 x-text="logbookSearch || logbookEntryTypeFilter
                                         ? 'No entries match your search criteria.'
                                         : 'No entries have been recorded yet.'">
                            </div>
                        </div>
                    </div>
                </template>
                <template x-if="logbookEntries.length > 0">
                    <div class="pf-v5-l-stack pf-m-gutter">
                        <template x-for="log in logbookEntries" :key="log.id">
                            <div class="pf-v5-c-card" :id="`log-entry-${log.id}`">
                                <div class="pf-v5-c-card__header">
                                    <div class="pf-v5-c-card__header-main">
                                        <div class="pf-v5-c-card__title">
                                            <span x-text="formatDate(log.date)" style="font-weight: 600;"></span>
                                            <span class="pf-v5-c-label pf-m-blue" style="margin-left: 0.5rem;" x-text="log.entry_type || log.log_type"></span>
                                            <span class="pf-v5-c-label pf-m-grey" style="margin-left: 0.25rem;"
                                                  x-show="logbookActiveTab === 'ALL'"
                                                  x-text="logbookTabLabel(log.log_type)">
                                            </span>
                                            <span class="logbook-attachment-badge" x-show="logAttachmentCount(log) > 0">
                                                <i class="fas fa-paperclip"></i>
                                                <span x-text="logAttachmentCount(log)"></span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="pf-v5-c-card__actions" x-show="isOwner">
                                        <div class="logbook-overflow" @click.outside="logbookOpenOverflow = null">
                                            <button class="pf-v5-c-button pf-m-plain"
                                                    @click.stop="logbookOpenOverflow = (logbookOpenOverflow === log.id ? null : log.id)"
                                                    title="More actions" aria-label="More actions">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div class="logbook-overflow-menu" x-show="logbookOpenOverflow === log.id">
                                                <button class="logbook-overflow-item" @click="openCreateRecordsModal(log); logbookOpenOverflow = null">
                                                    <i class="fas fa-clipboard-check"></i> Create compliance records
                                                </button>
                                                <button class="logbook-overflow-item" @click="openLinkPicker(log); logbookOpenOverflow = null">
                                                    <i class="fas fa-link"></i> Link to record
                                                </button>
                                                <button class="logbook-overflow-item" @click="editLogEntry(log); logbookOpenOverflow = null">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="logbook-overflow-item logbook-overflow-danger" @click="deleteLogEntry(log); logbookOpenOverflow = null">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="pf-v5-c-card__body">
                                    <p :class="logbookExpandedEntries[log.id] ? '' : 'logbook-text-clamped'" x-text="log.text"></p>
                                    <button x-show="!logbookExpandedEntries[log.id] && log.text && log.text.length > 200"
                                            class="pf-v5-c-button pf-m-link pf-m-inline"
                                            style="font-size: 0.85rem; margin-top: 0.25rem;"
                                            @click="toggleLogExpand(log.id)">
                                        Show more
                                    </button>
                                    <template x-if="log.aircraft_hours_at_entry">
                                        <p style="margin-top: 0.5rem;">
                                            <strong>Aircraft Hours:</strong>
                                            <span x-text="formatHours(log.aircraft_hours_at_entry)"></span>
                                        </p>
                                    </template>
                                    <template x-if="log.signoff_person">
                                        <p style="margin-top: 0.5rem;">
                                            <strong>Signed by:</strong>
                                            <span x-text="log.signoff_person"></span>
                                            <template x-if="log.signoff_location">
                                                <span> at <span x-text="log.signoff_location"></span></span>
                                            </template>
                                        </p>
                                    </template>
                                    <template x-if="log.log_image && (!isPublicView || log.log_image_shared)">
                                        <p style="margin-top: 0.5rem;">
                                            <i class="fas fa-paperclip" style="color: var(--pf-v5-global--Color--200);"></i>
                                            <button class="pf-v5-c-button pf-m-link pf-m-inline"
                                                    @click="viewLogEntryDocument(log)"
                                                    style="font-size: inherit;">
                                                View attached document
                                            </button>
                                        </p>
                                    </template>
                                    <template x-if="log.related_documents_detail && log.related_documents_detail.length > 0">
                                        <div style="margin-top: 0.5rem;">
                                            <strong style="font-size: 0.85em;">Related Documents:</strong>
                                            <template x-for="rdoc in log.related_documents_detail" :key="rdoc.id">
                                                <span style="display: inline-flex; align-items: center; gap: 0.25rem; margin-left: 0.5rem;">
                                                    <i class="fas fa-file-alt" style="color: var(--pf-v5-global--Color--200); font-size: 0.85em;"></i>
                                                    <button class="pf-v5-c-button pf-m-link pf-m-inline"
                                                            @click="viewRelatedDocument(rdoc)"
                                                            style="font-size: inherit;"
                                                            x-text="rdoc.name"></button>
                                                    <span class="pf-v5-c-label pf-m-compact" style="font-size: 0.75em;" x-text="rdoc.doc_type_display"></span>
                                                </span>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <template x-if="logbookHasMore">
                            <div style="text-align: center; padding: 1rem 0;">
                                <button class="pf-v5-c-button pf-m-secondary" @click="loadMoreLogbook()">
                                    Load more
                                </button>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>

        <!-- Squawks Tab -->
        <div x-show="activeTab === 'squawks'" class="pf-v5-c-page__main-section">
            <!-- Header with Add Button -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Active Squawks</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <a x-show="!isPublicView" :href="`/aircraft/${aircraftId}/squawks/history/`" class="pf-v5-c-button pf-m-secondary">
                        <i class="fas fa-history"></i> View History
                    </a>
                    <button class="pf-v5-c-button pf-m-primary" x-show="canCreateSquawk" @click="openSquawkModal()">
                        <i class="fas fa-plus"></i> New Squawk
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <template x-if="activeSquawks.length === 0">
                <div class="pf-v5-c-empty-state">
                    <div class="pf-v5-c-empty-state__content">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--pf-v5-global--success-color--100);"></i>
                        <h2 class="pf-v5-c-title pf-m-lg">No Active Squawks</h2>
                        <div class="pf-v5-c-empty-state__body">
                            This aircraft has no open maintenance issues.
                        </div>
                    </div>
                </div>
            </template>

            <!-- Squawk List -->
            <div class="pf-v5-l-stack pf-m-gutter" x-show="activeSquawks.length > 0">
                <template x-for="squawk in sortedActiveSquawks" :key="squawk.id">
                    <div class="pf-v5-c-card squawk-card" :class="getSquawkCardClass(squawk)">
                        <div class="pf-v5-c-card__header">
                            <div class="pf-v5-c-card__header-main">
                                <div class="pf-v5-c-card__title">
                                    <span class="pf-v5-c-label" :class="getSquawkPriorityClass(squawk)" x-text="squawk.priority_display"></span>
                                    <template x-if="squawk.component_name">
                                        <span class="pf-v5-c-label pf-m-blue" style="margin-left: 0.5rem;" x-text="squawk.component_name"></span>
                                    </template>
                                </div>
                            </div>
                            <div class="pf-v5-c-card__actions" x-show="isOwner">
                                <button class="pf-v5-c-button pf-m-plain" @click="editSquawk(squawk)" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="pf-v5-c-button pf-m-primary squawk-resolve-btn" @click="resolveSquawk(squawk)">
                                    <i class="fas fa-check"></i> Resolve
                                </button>
                            </div>
                        </div>
                        <div class="pf-v5-c-card__body">
                            <p x-text="squawk.issue_reported"></p>
                            <template x-if="squawk.notes">
                                <p style="margin-top: 0.5rem; color: var(--pf-v5-global--Color--200);">
                                    <strong>Notes:</strong> <span x-text="squawk.notes"></span>
                                </p>
                            </template>
                        </div>
                        <div class="pf-v5-c-card__footer" style="font-size: 0.875rem; color: var(--pf-v5-global--Color--200);">
                            <span>Reported <span x-text="formatDateTime(squawk.created_at)"></span></span>
                            <template x-if="squawk.reported_by_username">
                                <span> by <span x-text="squawk.reported_by_username"></span></span>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Inline Resolved Squawks (public maintenance view only) -->
            <template x-if="isPublicView && isMaintenance && resolvedSquawks.length > 0">
                <div style="margin-top: 1.5rem;">
                    <h2 style="margin-bottom: 1rem;">Resolved Squawks</h2>
                    <table class="pf-v5-c-table resolved-squawks-table">
                        <thead>
                            <tr>
                                <th>Date Reported</th>
                                <th>Priority</th>
                                <th>Component</th>
                                <th>Issue</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="squawk in resolvedSquawks" :key="squawk.id">
                                <tr>
                                    <td data-label="Date Reported" x-text="formatDate(squawk.created_at)"></td>
                                    <td data-label="Priority">
                                        <span class="pf-v5-c-label" :class="getSquawkPriorityClass(squawk)" x-text="squawk.priority_display"></span>
                                    </td>
                                    <td data-label="Component" :class="{ 'optional-empty': !squawk.component_name }" x-text="squawk.component_name"></td>
                                    <td data-label="Issue">
                                        <span x-text="squawk.issue_reported"></span>
                                        <template x-if="squawk.notes">
                                            <div style="font-size: 0.875rem; color: var(--pf-v5-global--Color--200); margin-top: 0.25rem;">
                                                <strong>Notes:</strong> <span x-text="squawk.notes"></span>
                                            </div>
                                        </template>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </template>
        </div>

        <!-- Compliance Tab Group (ADs & Inspections) -->
        <div x-show="activePrimaryTab === 'compliance'" class="pf-v5-c-page__main-section">
            <div class="tab-subtab-bar">
                <div class="pf-v5-c-toggle-group">
                    <div class="pf-v5-c-toggle-group__item">
                        <button class="pf-v5-c-toggle-group__button"
                                :class="{ 'pf-m-selected': activeTab === 'ads' }"
                                @click="activeTab = 'ads'">
                            ADs &amp; Bulletins
                        </button>
                    </div>
                    <div class="pf-v5-c-toggle-group__item">
                        <button class="pf-v5-c-toggle-group__button"
                                :class="{ 'pf-m-selected': activeTab === 'inspections' }"
                                @click="activeTab = 'inspections'">
                            Inspections
                        </button>
                    </div>
                </div>
                <button class="pf-v5-c-button pf-m-primary" x-show="isOwner && activeTab === 'ads'" @click="openAdModal()">
                    <i class="fas fa-plus"></i> Add Bulletin
                </button>
                <button class="pf-v5-c-button pf-m-primary" x-show="isOwner && activeTab === 'inspections'" @click="openInspectionTypeModal()">
                    <i class="fas fa-plus"></i> Add Inspection Type
                </button>
            </div>
            <div x-show="activeTab === 'ads'">

            <!-- Loading -->
            <div x-show="!adsLoaded" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading bulletins...</h2>
                </div>
            </div>

            <div x-show="adsLoaded" x-cloak>
                <!-- Empty State -->
                <template x-if="applicableAds.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-clipboard-check" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No Bulletins Tracked</h2>
                            <div class="pf-v5-c-empty-state__body">
                                No ADs or bulletins are currently tracked for this aircraft.
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Mandatory section -->
                <div x-show="mandatoryAds.length > 0">
                    <h3 style="margin-bottom: 0.75rem;">Mandatory</h3>
                    <table class="pf-v5-c-table ads-table" style="margin-bottom: 1.5rem;">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Type</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Recurring</th>
                                <th>Status</th>
                                <th>Last Complied</th>
                                <th>Next Due</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <template x-for="ad in mandatoryAds" :key="ad.id">
                            <tbody class="ad-row-group" :class="{'pf-m-expanded': expandedAdIds[ad.id]}">
                                <tr x-data="{ overflowOpen: false }">
                                    <td class="pf-v5-c-table__toggle">
                                        <button class="pf-v5-c-button pf-m-plain"
                                                @click="toggleAdExpand(ad.id)"
                                                :aria-expanded="expandedAdIds[ad.id] ? 'true' : 'false'"
                                                title="Toggle details">
                                            <i class="fas fa-angle-right"
                                               :style="expandedAdIds[ad.id] ? 'transform: rotate(90deg)' : ''"></i>
                                        </button>
                                    </td>
                                    <td data-label="Type">
                                        <span class="pf-v5-c-label" :class="getBulletinTypeClass(ad.bulletin_type)" x-text="getBulletinTypeLabel(ad.bulletin_type)"></span>
                                    </td>
                                    <td data-label="Name">
                                        <span x-text="ad.name"></span>
                                        <div class="ad-name-subtitle" x-show="ad.short_description" x-text="ad.short_description"></div>
                                    </td>
                                    <td data-label="Description">
                                        <span x-text="ad.short_description"></span>
                                        <template x-if="ad.compliance_type === 'conditional' && ad.trigger_condition">
                                            <div style="font-size: 0.85em; color: var(--pf-v5-global--Color--200); margin-top: 0.25rem;">
                                                Trigger: <span x-text="ad.trigger_condition"></span>
                                            </div>
                                        </template>
                                    </td>
                                    <td data-label="Recurring">
                                        <template x-if="ad.recurring">
                                            <span>
                                                Yes
                                                <template x-if="ad.recurring_hours > 0">
                                                    <span x-text="'(' + ad.recurring_hours + ' hrs)'"></span>
                                                </template>
                                                <template x-if="ad.recurring_months > 0">
                                                    <span x-text="'(' + ad.recurring_months + ' mo)'"></span>
                                                </template>
                                            </span>
                                        </template>
                                        <template x-if="!ad.recurring">
                                            <span>No</span>
                                        </template>
                                    </td>
                                    <td data-label="Status">
                                        <span class="pf-v5-c-label" :class="getAdStatusClass(ad)" x-text="getAdStatusText(ad)"></span>
                                    </td>
                                    <td data-label="Last Complied" x-text="ad.latest_compliance ? formatDate(ad.latest_compliance.date_complied) : '-'"></td>
                                    <td data-label="Next Due">
                                        <template x-if="ad.latest_compliance && ad.latest_compliance.permanent">
                                            <span class="ad-next-due-na">N/A</span>
                                        </template>
                                        <template x-if="ad.latest_compliance && !ad.latest_compliance.permanent && ad.next_due_date_display">
                                            <span><span class="consumable-field-label">Next due: </span><span x-text="'End of ' + ad.next_due_date_display"></span></span>
                                        </template>
                                        <template x-if="ad.latest_compliance && !ad.latest_compliance.permanent && !ad.next_due_date_display && ad.latest_compliance.next_due_at_time > 0">
                                            <span><span class="consumable-field-label">Next due: </span><span x-text="formatHours(ad.latest_compliance.next_due_at_time) + ' hrs'"></span></span>
                                        </template>
                                        <template x-if="!ad.latest_compliance || (!ad.latest_compliance.permanent && !ad.next_due_date_display && (!ad.latest_compliance.next_due_at_time || ad.latest_compliance.next_due_at_time == 0))">
                                            <span>-</span>
                                        </template>
                                    </td>
                                    <td data-label="Actions">
                                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                                            <!-- Primary: Record Compliance -->
                                            <button class="pf-v5-c-button pf-m-primary pf-m-small squawk-resolve-btn" x-show="isOwner"
                                                    @click="openComplianceModal(ad)"
                                                    title="Record Compliance">
                                                <i class="fas fa-check"></i> Record
                                            </button>
                                            <!-- Secondary: History -->
                                            <button class="pf-v5-c-button pf-m-secondary pf-m-small" x-show="isMaintenance"
                                                    @click="openComplianceHistory(ad)"
                                                    title="View Compliance History">
                                                <i class="fas fa-history"></i> History
                                            </button>
                                            <!-- Overflow "..." — edit, remove -->
                                            <div class="insp-overflow" x-show="isOwner"
                                                 @click.outside="overflowOpen = false">
                                                <button class="pf-v5-c-button pf-m-plain"
                                                        @click.stop="overflowOpen = !overflowOpen"
                                                        title="More actions" aria-label="More actions">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div class="logbook-overflow-menu" x-show="overflowOpen">
                                                    <button class="logbook-overflow-item"
                                                            @click="editAd(ad); overflowOpen = false">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="logbook-overflow-item logbook-overflow-danger"
                                                            @click="removeAd(ad); overflowOpen = false">
                                                        <i class="fas fa-times"></i> Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Expandable detail row -->
                                <tr class="pf-v5-c-table__expandable-row"
                                    :class="{'pf-m-expanded': expandedAdIds[ad.id]}"
                                    x-show="expandedAdIds[ad.id]">
                                    <td colspan="9">
                                        <div class="pf-v5-c-table__expandable-row-content">
                                            <div class="pf-v5-l-grid pf-m-gutter">
                                                <div class="pf-v5-l-grid__item pf-m-12-col pf-m-6-col-on-md">
                                                    <p class="pf-v5-u-font-weight-bold pf-v5-u-mb-xs">Required Action</p>
                                                    <p x-text="ad.required_action || 'No required action specified.'"
                                                       style="white-space: pre-wrap; margin: 0;"></p>
                                                </div>
                                                <div class="pf-v5-l-grid__item pf-m-12-col pf-m-6-col-on-md">
                                                    <p class="pf-v5-u-font-weight-bold pf-v5-u-mb-xs">Bulletin Document</p>
                                                    <template x-if="ad.document">
                                                        <button class="pf-v5-c-button pf-m-link pf-m-inline"
                                                                @click="openDocumentViewer(ad.document, 'Bulletin: ' + ad.name, 0)">
                                                            <i class="fas fa-file-alt pf-v5-u-mr-xs"></i>
                                                            <span x-text="ad.document.name"></span>
                                                        </button>
                                                    </template>
                                                    <template x-if="!ad.document">
                                                        <span class="pf-v5-u-color-400">No document attached</span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </template>
                    </table>
                </div>

                <!-- Optional / Advisory section -->
                <div x-show="nonMandatoryAds.length > 0">
                    <hr style="margin-bottom: 1.25rem; border-color: var(--pf-v5-global--BorderColor--100);" x-show="mandatoryAds.length > 0">
                    <h3 style="margin-bottom: 0.75rem;">Optional / Advisory</h3>
                    <table class="pf-v5-c-table ads-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Type</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Recurring</th>
                                <th>Status</th>
                                <th>Last Complied</th>
                                <th>Next Due</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <template x-for="ad in nonMandatoryAds" :key="ad.id">
                            <tbody class="ad-row-group" :class="{'pf-m-expanded': expandedAdIds[ad.id]}">
                                <tr x-data="{ overflowOpen: false }">
                                    <td class="pf-v5-c-table__toggle">
                                        <button class="pf-v5-c-button pf-m-plain"
                                                @click="toggleAdExpand(ad.id)"
                                                :aria-expanded="expandedAdIds[ad.id] ? 'true' : 'false'"
                                                title="Toggle details">
                                            <i class="fas fa-angle-right"
                                               :style="expandedAdIds[ad.id] ? 'transform: rotate(90deg)' : ''"></i>
                                        </button>
                                    </td>
                                    <td data-label="Type">
                                        <span class="pf-v5-c-label" :class="getBulletinTypeClass(ad.bulletin_type)" x-text="getBulletinTypeLabel(ad.bulletin_type)"></span>
                                    </td>
                                    <td data-label="Name">
                                        <span x-text="ad.name"></span>
                                        <div class="ad-name-subtitle" x-show="ad.short_description" x-text="ad.short_description"></div>
                                    </td>
                                    <td data-label="Description">
                                        <span x-text="ad.short_description"></span>
                                        <template x-if="ad.compliance_type === 'conditional' && ad.trigger_condition">
                                            <div style="font-size: 0.85em; color: var(--pf-v5-global--Color--200); margin-top: 0.25rem;">
                                                Trigger: <span x-text="ad.trigger_condition"></span>
                                            </div>
                                        </template>
                                    </td>
                                    <td data-label="Recurring">
                                        <template x-if="ad.recurring">
                                            <span>
                                                Yes
                                                <template x-if="ad.recurring_hours > 0">
                                                    <span x-text="'(' + ad.recurring_hours + ' hrs)'"></span>
                                                </template>
                                                <template x-if="ad.recurring_months > 0">
                                                    <span x-text="'(' + ad.recurring_months + ' mo)'"></span>
                                                </template>
                                            </span>
                                        </template>
                                        <template x-if="!ad.recurring">
                                            <span>No</span>
                                        </template>
                                    </td>
                                    <td data-label="Status">
                                        <span class="pf-v5-c-label" :class="getAdStatusClass(ad)" x-text="getAdStatusText(ad)"></span>
                                    </td>
                                    <td data-label="Last Complied" x-text="ad.latest_compliance ? formatDate(ad.latest_compliance.date_complied) : '-'"></td>
                                    <td data-label="Next Due">
                                        <template x-if="ad.latest_compliance && ad.latest_compliance.permanent">
                                            <span class="ad-next-due-na">N/A</span>
                                        </template>
                                        <template x-if="ad.latest_compliance && !ad.latest_compliance.permanent && ad.next_due_date_display">
                                            <span><span class="consumable-field-label">Next due: </span><span x-text="'End of ' + ad.next_due_date_display"></span></span>
                                        </template>
                                        <template x-if="ad.latest_compliance && !ad.latest_compliance.permanent && !ad.next_due_date_display && ad.latest_compliance.next_due_at_time > 0">
                                            <span><span class="consumable-field-label">Next due: </span><span x-text="formatHours(ad.latest_compliance.next_due_at_time) + ' hrs'"></span></span>
                                        </template>
                                        <template x-if="!ad.latest_compliance || (!ad.latest_compliance.permanent && !ad.next_due_date_display && (!ad.latest_compliance.next_due_at_time || ad.latest_compliance.next_due_at_time == 0))">
                                            <span>-</span>
                                        </template>
                                    </td>
                                    <td data-label="Actions">
                                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                                            <!-- Primary: Record Compliance -->
                                            <button class="pf-v5-c-button pf-m-primary pf-m-small squawk-resolve-btn" x-show="isOwner"
                                                    @click="openComplianceModal(ad)"
                                                    title="Record Compliance">
                                                <i class="fas fa-check"></i> Record
                                            </button>
                                            <!-- Secondary: History -->
                                            <button class="pf-v5-c-button pf-m-secondary pf-m-small" x-show="isMaintenance"
                                                    @click="openComplianceHistory(ad)"
                                                    title="View Compliance History">
                                                <i class="fas fa-history"></i> History
                                            </button>
                                            <!-- Overflow "..." — edit, remove -->
                                            <div class="insp-overflow" x-show="isOwner"
                                                 @click.outside="overflowOpen = false">
                                                <button class="pf-v5-c-button pf-m-plain"
                                                        @click.stop="overflowOpen = !overflowOpen"
                                                        title="More actions" aria-label="More actions">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div class="logbook-overflow-menu" x-show="overflowOpen">
                                                    <button class="logbook-overflow-item"
                                                            @click="editAd(ad); overflowOpen = false">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="logbook-overflow-item logbook-overflow-danger"
                                                            @click="removeAd(ad); overflowOpen = false">
                                                        <i class="fas fa-times"></i> Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Expandable detail row -->
                                <tr class="pf-v5-c-table__expandable-row"
                                    :class="{'pf-m-expanded': expandedAdIds[ad.id]}"
                                    x-show="expandedAdIds[ad.id]">
                                    <td colspan="9">
                                        <div class="pf-v5-c-table__expandable-row-content">
                                            <div class="pf-v5-l-grid pf-m-gutter">
                                                <div class="pf-v5-l-grid__item pf-m-12-col pf-m-6-col-on-md">
                                                    <p class="pf-v5-u-font-weight-bold pf-v5-u-mb-xs">Required Action</p>
                                                    <p x-text="ad.required_action || 'No required action specified.'"
                                                       style="white-space: pre-wrap; margin: 0;"></p>
                                                </div>
                                                <div class="pf-v5-l-grid__item pf-m-12-col pf-m-6-col-on-md">
                                                    <p class="pf-v5-u-font-weight-bold pf-v5-u-mb-xs">Bulletin Document</p>
                                                    <template x-if="ad.document">
                                                        <button class="pf-v5-c-button pf-m-link pf-m-inline"
                                                                @click="openDocumentViewer(ad.document, 'Bulletin: ' + ad.name, 0)">
                                                            <i class="fas fa-file-alt pf-v5-u-mr-xs"></i>
                                                            <span x-text="ad.document.name"></span>
                                                        </button>
                                                    </template>
                                                    <template x-if="!ad.document">
                                                        <span class="pf-v5-u-color-400">No document attached</span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </template>
                    </table>
                </div>
            </div>
            </div>
            <div x-show="activeTab === 'inspections'">

            <!-- Loading -->
            <div x-show="!inspectionsLoaded" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading inspections...</h2>
                </div>
            </div>

            <div x-show="inspectionsLoaded" x-cloak>
                <!-- Empty State -->
                <template x-if="inspectionTypes.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-clipboard-check" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No Applicable Inspections</h2>
                            <div class="pf-v5-c-empty-state__body">
                                No inspection types are currently tracked for this aircraft.
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Inspection Types Table -->
                <template x-if="inspectionTypes.length > 0">
                    <table class="pf-v5-c-table inspections-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Recurring</th>
                                <th>Status</th>
                                <th>Last Completed</th>
                                <th>Next Due</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="insp in sortedInspectionTypes" :key="insp.id">
                                <tr x-data="{ overflowOpen: false }">
                                    <td data-label="Name" x-text="insp.name"></td>
                                    <td data-label="Recurring">
                                        <template x-if="insp.recurring">
                                            <span>
                                                Recurring
                                                <template x-if="insp.recurring_hours > 0">
                                                    <span x-text="' · ' + insp.recurring_hours + ' hrs'"></span>
                                                </template>
                                                <template x-if="insp.recurring_months > 0">
                                                    <span x-text="' · ' + insp.recurring_months + ' mo'"></span>
                                                </template>
                                                <template x-if="insp.recurring_days > 0 && insp.recurring_months === 0">
                                                    <span x-text="' · ' + insp.recurring_days + ' days'"></span>
                                                </template>
                                            </span>
                                        </template>
                                        <template x-if="!insp.recurring">
                                            <span>One-time</span>
                                        </template>
                                    </td>
                                    <td data-label="Status">
                                        <span class="pf-v5-c-label" :class="getInspectionStatusClass(insp)" x-text="getInspectionStatusText(insp)"></span>
                                    </td>
                                    <td data-label="Last Completed">
                                        <span class="insp-mobile-label">Last</span>
                                        <span x-text="insp.latest_record ? formatDate(insp.latest_record.date) : '—'"></span>
                                    </td>
                                    <td data-label="Next Due">
                                        <span class="insp-mobile-label">Due</span>
                                        <template x-if="!insp.recurring || !insp.latest_record">
                                            <span>—</span>
                                        </template>
                                        <template x-if="insp.recurring && insp.latest_record && insp.next_due_date">
                                            <span x-text="formatDate(insp.next_due_date)"></span>
                                        </template>
                                        <template x-if="insp.recurring && insp.latest_record && insp.next_due_hours && !insp.next_due_date">
                                            <span x-text="formatHours(insp.next_due_hours) + ' hrs'"></span>
                                        </template>
                                    </td>
                                    <td data-label="Actions">
                                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                                            <!-- Primary: Record Inspection -->
                                            <button class="pf-v5-c-button pf-m-primary pf-m-small squawk-resolve-btn" x-show="isOwner"
                                                    @click="openInspectionModal(insp)"
                                                    title="Record Inspection">
                                                <i class="fas fa-check"></i> Record
                                            </button>
                                            <!-- Secondary: History -->
                                            <button class="pf-v5-c-button pf-m-secondary pf-m-small" x-show="isMaintenance"
                                                    @click="openInspectionHistory(insp)"
                                                    title="View Inspection History">
                                                <i class="fas fa-history"></i> History
                                            </button>
                                            <!-- Overflow "..." — edit, remove -->
                                            <div class="insp-overflow" x-show="isOwner"
                                                 @click.outside="overflowOpen = false">
                                                <button class="pf-v5-c-button pf-m-plain"
                                                        @click.stop="overflowOpen = !overflowOpen"
                                                        title="More actions" aria-label="More actions">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div class="logbook-overflow-menu" x-show="overflowOpen">
                                                    <button class="logbook-overflow-item"
                                                            @click="editInspectionType(insp); overflowOpen = false">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="logbook-overflow-item logbook-overflow-danger"
                                                            @click="removeInspectionType(insp); overflowOpen = false">
                                                        <i class="fas fa-times"></i> Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </template>
            </div>
            </div>
        </div>

        <!-- Repairs & Alterations Tab (Records group) -->
        <div x-show="activeTab === 'major-records'" class="pf-v5-c-page__main-section">
            <div class="tab-subtab-bar">
                <div class="pf-v5-c-toggle-group">
                    <div class="pf-v5-c-toggle-group__item">
                        <button class="pf-v5-c-toggle-group__button" @click="activeTab = 'logbook'">Logbook</button>
                    </div>
                    <div class="pf-v5-c-toggle-group__item">
                        <button class="pf-v5-c-toggle-group__button pf-m-selected">Repairs &amp; Alterations</button>
                    </div>
                </div>
                <div x-show="isOwner" style="display: flex; gap: 0.5rem;">
                    <button class="pf-v5-c-button pf-m-primary" @click="openMajorRecordModal('repair')">
                        <i class="fas fa-plus"></i> Add Repair
                    </button>
                    <button class="pf-v5-c-button pf-m-secondary" @click="openMajorRecordModal('alteration')">
                        <i class="fas fa-plus"></i> Add Alteration
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div x-show="!majorRecordsLoaded" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading records...</h2>
                </div>
            </div>

            <div x-show="majorRecordsLoaded" x-cloak>
                <!-- Filter toggle -->
                <template x-if="majorRecords.length > 0">
                    <div class="pf-v5-c-toggle-group" style="margin-bottom: 1rem;">
                        <div class="pf-v5-c-toggle-group__item">
                            <button class="pf-v5-c-toggle-group__button" :class="{ 'pf-m-selected': majorRecordFilter === 'all' }" @click="majorRecordFilter = 'all'">
                                <span class="pf-v5-c-toggle-group__text">All</span>
                            </button>
                        </div>
                        <div class="pf-v5-c-toggle-group__item">
                            <button class="pf-v5-c-toggle-group__button" :class="{ 'pf-m-selected': majorRecordFilter === 'repair' }" @click="majorRecordFilter = 'repair'">
                                <span class="pf-v5-c-toggle-group__text">Repairs</span>
                            </button>
                        </div>
                        <div class="pf-v5-c-toggle-group__item">
                            <button class="pf-v5-c-toggle-group__button" :class="{ 'pf-m-selected': majorRecordFilter === 'alteration' }" @click="majorRecordFilter = 'alteration'">
                                <span class="pf-v5-c-toggle-group__text">Alterations</span>
                            </button>
                        </div>
                    </div>
                </template>

                <!-- Empty State -->
                <template x-if="majorRecords.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-wrench" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No Major Repairs or Alterations</h2>
                            <div class="pf-v5-c-empty-state__body">
                                No major repairs or alterations have been recorded for this aircraft.
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Major Repairs Section -->
                <template x-if="majorRecordFilter !== 'alteration' && majorRepairs.length > 0">
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 0.75rem; color: var(--pf-v5-global--Color--200);">Major Repairs</h3>
                        <table class="pf-v5-c-table pf-m-compact major-records-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Title</th>
                                    <th>Date</th>
                                    <th>Component</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <template x-for="record in majorRepairs" :key="record.id">
                                <tbody class="major-record-row-group">
                                    <tr>
                                        <td class="pf-v5-c-table__toggle">
                                            <button class="pf-v5-c-button pf-m-plain"
                                                    @click="toggleMajorRecordExpand(record.id)"
                                                    :aria-expanded="isMajorRecordExpanded(record.id).toString()">
                                                <i class="fas fa-angle-right"
                                                   :style="isMajorRecordExpanded(record.id) ? 'transform: rotate(90deg)' : ''"></i>
                                            </button>
                                        </td>
                                        <td data-label="Title">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                                <span x-text="record.title"></span>
                                                <span class="pf-v5-c-label pf-m-compact pf-m-gold" x-show="record.has_ica" title="Instructions for Continued Airworthiness">
                                                    <span class="pf-v5-c-label__content"><i class="fas fa-book-open" style="margin-right: 0.25rem; font-size: 0.7rem;"></i>Has ICA</span>
                                                </span>
                                            </div>
                                        </td>
                                        <td data-label="Date" x-text="formatDate(record.date_performed)"></td>
                                        <td data-label="Component" :class="{ 'optional-empty': !record.component_name }">
                                            <span class="major-record-mobile-label" x-show="record.component_name">Component:</span><span x-text="record.component_name"></span>
                                        </td>
                                        <td data-label="Actions">
                                            <div style="display: flex; gap: 0.25rem; align-items: center;">
                                                <div class="related-popup-trigger" x-show="record.logbook_entry || canViewDocument(record.form_337_document)" @click.outside="if (openRelatedPopup === record.id) openRelatedPopup = null">
                                                    <button class="pf-v5-c-button pf-m-plain" title="View related documents" style="color: var(--pf-v5-global--link--Color);" @click.stop="openRelatedPopup = openRelatedPopup === record.id ? null : record.id">
                                                        <i class="fas fa-paperclip"></i>
                                                    </button>
                                                    <div class="related-popup" x-show="openRelatedPopup === record.id">
                                                        <template x-if="record.logbook_entry">
                                                            <button class="pf-v5-c-button pf-m-link pf-m-inline" @click="viewMajorRecordLogEntry(record)" style="font-size: 0.85rem; padding: 0;">
                                                                <i class="fas fa-book" style="margin-right: 0.25rem;"></i>Logbook
                                                            </button>
                                                        </template>
                                                        <template x-if="canViewDocument(record.form_337_document)">
                                                            <button class="pf-v5-c-button pf-m-link pf-m-inline" @click="viewMajorRecordDocument(record.form_337_document, record.form_337_document_name || 'Form 337')" style="font-size: 0.85rem; padding: 0;">
                                                                <i class="fas fa-file-alt" style="margin-right: 0.25rem;"></i>Form 337
                                                            </button>
                                                        </template>
                                                    </div>
                                                </div>
                                                <button class="pf-v5-c-button pf-m-plain" x-show="isOwner"
                                                        @click="editMajorRecord(record)"
                                                        title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="pf-v5-c-button pf-m-plain pf-m-danger" x-show="isOwner"
                                                        @click="deleteMajorRecord(record)"
                                                        title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr x-show="isMajorRecordExpanded(record.id)"
                                        :class="{'pf-m-expanded': isMajorRecordExpanded(record.id)}"
                                        class="pf-v5-c-table__expandable-row">
                                        <td></td>
                                        <td colspan="4" style="padding: 0.75rem 1rem;">
                                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem 2.5rem; margin-bottom: 0.75rem;">
                                                <template x-if="record.performed_by">
                                                    <div>
                                                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">Performed By</div>
                                                        <div x-text="record.performed_by"></div>
                                                    </div>
                                                </template>
                                                <template x-if="record.aircraft_hours">
                                                    <div>
                                                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">Aircraft Hours</div>
                                                        <div x-text="formatHours(record.aircraft_hours)"></div>
                                                    </div>
                                                </template>
                                                <template x-if="record.has_ica">
                                                    <div>
                                                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">ICAs</div>
                                                        <span class="pf-v5-c-label pf-m-compact pf-m-gold">
                                                            <span class="pf-v5-c-label__content"><i class="fas fa-book-open" style="margin-right: 0.25rem; font-size: 0.7rem;"></i>Has ICAs</span>
                                                        </span>
                                                    </div>
                                                </template>
                                            </div>
                                            <template x-if="record.has_ica && record.ica_notes">
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">ICA Notes</div>
                                                    <div x-text="record.ica_notes" style="white-space: pre-wrap;"></div>
                                                </div>
                                            </template>
                                            <template x-if="record.description">
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">Description</div>
                                                    <div x-text="record.description" style="white-space: pre-wrap;"></div>
                                                </div>
                                            </template>
                                            <template x-if="record.notes">
                                                <div>
                                                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">Notes</div>
                                                    <div x-text="record.notes" style="white-space: pre-wrap;"></div>
                                                </div>
                                            </template>
                                        </td>
                                    </tr>
                                </tbody>
                            </template>
                        </table>
                    </div>
                </template>

                <!-- Major Alterations Section -->
                <template x-if="majorRecordFilter !== 'repair' && majorAlterations.length > 0">
                    <div>
                        <h3 style="margin-bottom: 0.75rem; color: var(--pf-v5-global--Color--200);">Major Alterations</h3>
                        <table class="pf-v5-c-table pf-m-compact major-records-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Title</th>
                                    <th>Date</th>
                                    <th>Component</th>
                                    <th>STC #</th>
                                    <th>STC Holder</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <template x-for="record in majorAlterations" :key="record.id">
                                <tbody class="major-record-row-group">
                                    <tr>
                                        <td class="pf-v5-c-table__toggle">
                                            <button class="pf-v5-c-button pf-m-plain"
                                                    @click="toggleMajorRecordExpand(record.id)"
                                                    :aria-expanded="isMajorRecordExpanded(record.id).toString()">
                                                <i class="fas fa-angle-right"
                                                   :style="isMajorRecordExpanded(record.id) ? 'transform: rotate(90deg)' : ''"></i>
                                            </button>
                                        </td>
                                        <td data-label="Title">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                                <span x-text="record.title"></span>
                                                <span class="pf-v5-c-label pf-m-compact pf-m-gold" x-show="record.has_ica" title="Instructions for Continued Airworthiness">
                                                    <span class="pf-v5-c-label__content"><i class="fas fa-book-open" style="margin-right: 0.25rem; font-size: 0.7rem;"></i>Has ICA</span>
                                                </span>
                                            </div>
                                        </td>
                                        <td data-label="Date" x-text="formatDate(record.date_performed)"></td>
                                        <td data-label="Component" :class="{ 'optional-empty': !record.component_name }">
                                            <span class="major-record-mobile-label" x-show="record.component_name">Component:</span><span x-text="record.component_name"></span>
                                        </td>
                                        <td data-label="STC #" :class="{ 'optional-empty': !record.stc_number }" x-text="record.stc_number"></td>
                                        <td data-label="STC Holder" :class="{ 'optional-empty': !record.stc_holder }" x-text="record.stc_holder"></td>
                                        <td data-label="Actions">
                                            <div style="display: flex; gap: 0.25rem; align-items: center;">
                                                <div class="related-popup-trigger" x-show="record.logbook_entry || canViewDocument(record.form_337_document) || canViewDocument(record.stc_document)" @click.outside="if (openRelatedPopup === record.id) openRelatedPopup = null">
                                                    <button class="pf-v5-c-button pf-m-plain" title="View related documents" style="color: var(--pf-v5-global--link--Color);" @click.stop="openRelatedPopup = openRelatedPopup === record.id ? null : record.id">
                                                        <i class="fas fa-paperclip"></i>
                                                    </button>
                                                    <div class="related-popup" x-show="openRelatedPopup === record.id">
                                                        <template x-if="record.logbook_entry">
                                                            <button class="pf-v5-c-button pf-m-link pf-m-inline" @click="viewMajorRecordLogEntry(record)" style="font-size: 0.85rem; padding: 0;">
                                                                <i class="fas fa-book" style="margin-right: 0.25rem;"></i>Logbook
                                                            </button>
                                                        </template>
                                                        <template x-if="canViewDocument(record.form_337_document)">
                                                            <button class="pf-v5-c-button pf-m-link pf-m-inline" @click="viewMajorRecordDocument(record.form_337_document, record.form_337_document_name || 'Form 337')" style="font-size: 0.85rem; padding: 0;">
                                                                <i class="fas fa-file-alt" style="margin-right: 0.25rem;"></i>Form 337
                                                            </button>
                                                        </template>
                                                        <template x-if="canViewDocument(record.stc_document)">
                                                            <button class="pf-v5-c-button pf-m-link pf-m-inline" @click="viewMajorRecordDocument(record.stc_document, record.stc_document_name || 'STC Document')" style="font-size: 0.85rem; padding: 0;">
                                                                <i class="fas fa-certificate" style="margin-right: 0.25rem;"></i>STC Doc
                                                            </button>
                                                        </template>
                                                    </div>
                                                </div>
                                                <button class="pf-v5-c-button pf-m-plain" x-show="isOwner"
                                                        @click="editMajorRecord(record)"
                                                        title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="pf-v5-c-button pf-m-plain pf-m-danger" x-show="isOwner"
                                                        @click="deleteMajorRecord(record)"
                                                        title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr x-show="isMajorRecordExpanded(record.id)"
                                        :class="{'pf-m-expanded': isMajorRecordExpanded(record.id)}"
                                        class="pf-v5-c-table__expandable-row">
                                        <td></td>
                                        <td colspan="6" style="padding: 0.75rem 1rem;">
                                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem 2.5rem; margin-bottom: 0.75rem;">
                                                <template x-if="record.performed_by">
                                                    <div>
                                                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">Performed By</div>
                                                        <div x-text="record.performed_by"></div>
                                                    </div>
                                                </template>
                                                <template x-if="record.aircraft_hours">
                                                    <div>
                                                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">Aircraft Hours</div>
                                                        <div x-text="formatHours(record.aircraft_hours)"></div>
                                                    </div>
                                                </template>
                                                <template x-if="record.has_ica">
                                                    <div>
                                                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">ICAs</div>
                                                        <span class="pf-v5-c-label pf-m-compact pf-m-gold">
                                                            <span class="pf-v5-c-label__content"><i class="fas fa-book-open" style="margin-right: 0.25rem; font-size: 0.7rem;"></i>Has ICAs</span>
                                                        </span>
                                                    </div>
                                                </template>
                                            </div>
                                            <template x-if="record.has_ica && record.ica_notes">
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">ICA Notes</div>
                                                    <div x-text="record.ica_notes" style="white-space: pre-wrap;"></div>
                                                </div>
                                            </template>
                                            <template x-if="record.description">
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">Description</div>
                                                    <div x-text="record.description" style="white-space: pre-wrap;"></div>
                                                </div>
                                            </template>
                                            <template x-if="record.notes">
                                                <div>
                                                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem;">Notes</div>
                                                    <div x-text="record.notes" style="white-space: pre-wrap;"></div>
                                                </div>
                                            </template>
                                        </td>
                                    </tr>
                                </tbody>
                            </template>
                        </table>
                    </div>
                </template>

                <!-- Filtered empty state -->
                <template x-if="majorRecords.length > 0 && filteredMajorRecords.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <h2 class="pf-v5-c-title pf-m-lg" x-text="majorRecordFilter === 'repair' ? 'No Major Repairs' : 'No Major Alterations'"></h2>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Major Record Create/Edit Modal -->
        <div class="pf-v5-c-backdrop" x-show="majorRecordModalOpen" x-cloak>
            <div class="pf-v5-c-modal-box" role="dialog" aria-modal="true" style="width: 700px;">
                <div class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingMajorRecord ? 'Edit Record' : (majorRecordForm.record_type === 'repair' ? 'Add Major Repair' : 'Add Major Alteration')"></h1>
                </div>
                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="saveMajorRecord()" class="pf-v5-c-form">
                        <!-- Record Type -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Record Type</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select class="pf-v5-c-form-control" x-model="majorRecordForm.record_type">
                                    <option value="repair">Major Repair</option>
                                    <option value="alteration">Major Alteration</option>
                                </select>
                            </div>
                        </div>

                        <!-- Title -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Title</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">&#42;</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input class="pf-v5-c-form-control" type="text" x-model="majorRecordForm.title" required
                                       placeholder="e.g. Longeron repair, STC SA00001SE installation">
                            </div>
                        </div>

                        <!-- Date Performed -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Date Performed</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">&#42;</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input class="pf-v5-c-form-control" type="date" x-model="majorRecordForm.date_performed" required>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Description</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea class="pf-v5-c-form-control" x-model="majorRecordForm.description" rows="3"
                                          placeholder="Detailed description of the work performed"></textarea>
                            </div>
                        </div>

                        <!-- Performed By -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Performed By</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input class="pf-v5-c-form-control" type="text" x-model="majorRecordForm.performed_by"
                                       placeholder="Mechanic, shop, or IA">
                            </div>
                        </div>

                        <!-- Two-column row: Component + Aircraft Hours -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Component -->
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label">
                                    <span class="pf-v5-c-form__label-text">Component</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <select class="pf-v5-c-form-control" x-model="majorRecordForm.component">
                                        <option value="">-- None --</option>
                                        <template x-for="comp in components" :key="comp.id">
                                            <option :value="comp.id" x-text="comp.component_type_name + (comp.install_location ? ' (' + comp.install_location + ')' : '')"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>

                            <!-- Aircraft Hours -->
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label">
                                    <span class="pf-v5-c-form__label-text">Aircraft Hours</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input class="pf-v5-c-form-control" type="number" step="0.1" x-model="majorRecordForm.aircraft_hours"
                                           placeholder="Total hours at time of work">
                                </div>
                            </div>
                        </div>

                        <!-- Form 337 Document -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Form 337 Document</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select class="pf-v5-c-form-control" x-model="majorRecordForm.form_337_document">
                                    <option value="">-- None --</option>
                                    <template x-for="doc in (documentCollections || []).flatMap(c => c.documents).concat(uncollectedDocuments || [])" :key="doc.id">
                                        <option :value="doc.id" x-text="doc.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- STC fields (shown only for alterations) -->
                        <template x-if="majorRecordForm.record_type === 'alteration'">
                            <div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="pf-v5-c-form__group">
                                        <label class="pf-v5-c-form__label">
                                            <span class="pf-v5-c-form__label-text">STC Number</span>
                                        </label>
                                        <div class="pf-v5-c-form__group-control">
                                            <input class="pf-v5-c-form-control" type="text" x-model="majorRecordForm.stc_number"
                                                   placeholder="e.g. SA00001SE">
                                        </div>
                                    </div>
                                    <div class="pf-v5-c-form__group">
                                        <label class="pf-v5-c-form__label">
                                            <span class="pf-v5-c-form__label-text">STC Holder</span>
                                        </label>
                                        <div class="pf-v5-c-form__group-control">
                                            <input class="pf-v5-c-form-control" type="text" x-model="majorRecordForm.stc_holder"
                                                   placeholder="STC holder / manufacturer">
                                        </div>
                                    </div>
                                </div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label">
                                        <span class="pf-v5-c-form__label-text">STC Document</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <select class="pf-v5-c-form-control" x-model="majorRecordForm.stc_document">
                                            <option value="">-- None --</option>
                                            <template x-for="doc in (documentCollections || []).flatMap(c => c.documents).concat(uncollectedDocuments || [])" :key="doc.id">
                                                <option :value="doc.id" x-text="doc.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Logbook Entry -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Logbook Entry</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <!-- Selected entry chip -->
                                <template x-if="pickerSelectedEntry">
                                    <div style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px; background: var(--pf-v5-global--BackgroundColor--100);">
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                                <span style="font-weight: 500;" x-text="formatDate(pickerSelectedEntry.date)"></span>
                                                <span x-show="pickerSelectedEntry.aircraft_hours_at_entry" style="color: var(--pf-v5-global--Color--200);" x-text="'· ' + formatHours(pickerSelectedEntry.aircraft_hours_at_entry)"></span>
                                                <span class="pf-v5-c-label pf-m-compact pf-m-blue" x-show="pickerSelectedEntry.entry_type"><span class="pf-v5-c-label__content" x-text="pickerSelectedEntry.entry_type"></span></span>
                                            </div>
                                            <div style="margin-top: 0.25rem; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="(pickerSelectedEntry.text || '').substring(0, 80)"></div>
                                            <div x-show="pickerSelectedEntry.signoff_person" style="margin-top: 0.125rem; font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                                <i class="fas fa-user"></i> <span x-text="pickerSelectedEntry.signoff_person"></span>
                                            </div>
                                        </div>
                                        <button class="pf-v5-c-button pf-m-plain" type="button" @click="pickerClear()" title="Clear selection"><i class="fas fa-times"></i></button>
                                    </div>
                                </template>
                                <!-- Search row (shown when no entry selected) -->
                                <template x-if="!pickerSelectedEntry">
                                    <div>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="text" class="pf-v5-c-form-control" placeholder="Search by date, text, mechanic..." x-model="pickerSearchQuery" @input="pickerOnInput()" @focus="pickerSearchQuery.trim() && pickerDoSearch()" @keydown.escape="pickerDropdownOpen = false; pickerSearchQuery = ''" style="flex: 1;">
                                            <button class="pf-v5-c-button pf-m-secondary" type="button" @click="pickerOpenBrowse()">Browse</button>
                                        </div>
                                        <!-- Inline results -->
                                        <div x-show="pickerDropdownOpen" style="border: 1px solid var(--pf-v5-global--BorderColor--100); border-top: 0; border-radius: 0 0 3px 3px; background: var(--pf-v5-global--BackgroundColor--100); max-height: 200px; overflow-y: auto; margin-top: -1px;">
                                            <div x-show="pickerSearchLoading" style="padding: 0.75rem; text-align: center; color: var(--pf-v5-global--Color--200);"><i class="fas fa-spinner fa-spin"></i> Searching...</div>
                                            <div x-show="!pickerSearchLoading && pickerSearchResults.length === 0" style="padding: 0.75rem; color: var(--pf-v5-global--Color--200);">No entries found</div>
                                            <template x-for="entry in pickerSearchResults" :key="entry.id">
                                                <div class="logbook-picker-result" @click="pickerSelectEntry(entry)" style="padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid var(--pf-v5-global--BorderColor--200);">
                                                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                                        <span style="font-weight: 500;" x-text="formatDate(entry.date)"></span>
                                                        <span x-show="entry.aircraft_hours_at_entry" style="color: var(--pf-v5-global--Color--200); font-size: 0.9em;" x-text="'· ' + formatHours(entry.aircraft_hours_at_entry)"></span>
                                                        <span class="pf-v5-c-label pf-m-compact pf-m-blue" x-show="entry.entry_type"><span class="pf-v5-c-label__content" x-text="entry.entry_type"></span></span>
                                                    </div>
                                                    <div style="font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="(entry.text || '').substring(0, 80)"></div>
                                                    <div x-show="entry.signoff_person" style="font-size: 0.85em; color: var(--pf-v5-global--Color--200);"><i class="fas fa-user"></i> <span x-text="entry.signoff_person"></span></div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- ICA -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Instructions for Continued Airworthiness (ICAs)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" x-model="majorRecordForm.has_ica">
                                    <span>This record includes ICAs</span>
                                </label>
                            </div>
                        </div>
                        <template x-if="majorRecordForm.has_ica">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label">
                                    <span class="pf-v5-c-form__label-text">ICA Notes</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <textarea class="pf-v5-c-form-control" x-model="majorRecordForm.ica_notes" rows="2"
                                              placeholder="Where the ICAs are located and what they cover"></textarea>
                                </div>
                            </div>
                        </template>

                        <!-- Notes -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Notes</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea class="pf-v5-c-form-control" x-model="majorRecordForm.notes" rows="2"
                                          placeholder="Additional notes"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="saveMajorRecord()" :disabled="majorRecordSubmitting || !majorRecordForm.title || !majorRecordForm.date_performed">
                        <span x-show="majorRecordSubmitting" class="pf-v5-c-spinner pf-m-sm" role="progressbar"><span class="pf-v5-c-spinner__clipper"></span></span>
                        <span x-text="editingMajorRecord ? 'Save Changes' : 'Create'"></span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeMajorRecordModal()">Cancel</button>
                </footer>
            </div>
        </div>

        <!-- Consumables Tab Group (Oil & Fuel) -->
        <div x-show="activePrimaryTab === 'consumables'" class="pf-v5-c-page__main-section">
            <div class="tab-subtab-bar">
                <div class="pf-v5-c-toggle-group">
                    <div class="pf-v5-c-toggle-group__item">
                        <button class="pf-v5-c-toggle-group__button"
                                :class="{ 'pf-m-selected': activeTab === 'oil' }"
                                @click="activeTab = 'oil'">
                            Oil
                        </button>
                    </div>
                    <div class="pf-v5-c-toggle-group__item">
                        <button class="pf-v5-c-toggle-group__button"
                                :class="{ 'pf-m-selected': activeTab === 'fuel' }"
                                @click="activeTab = 'fuel'">
                            Fuel
                        </button>
                    </div>
                    <div class="pf-v5-c-toggle-group__item">
                        <button class="pf-v5-c-toggle-group__button"
                                :class="{ 'pf-m-selected': activeTab === 'oil-analysis' }"
                                @click="activeTab = 'oil-analysis'">
                            Oil Analysis
                        </button>
                    </div>
                </div>
                <button class="pf-v5-c-button pf-m-primary" x-show="canCreateConsumable && activeTab === 'oil'" @click="openOilModal()">
                    <i class="fas fa-plus"></i> Add Oil Record
                </button>
                <button class="pf-v5-c-button pf-m-primary" x-show="canCreateConsumable && activeTab === 'fuel'" @click="openFuelModal()">
                    <i class="fas fa-plus"></i> Add Fuel Record
                </button>
                <template x-if="activeTab === 'oil-analysis' && canWrite">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="pf-v5-c-button pf-m-secondary" @click="openOilAnalysisAiModal()">
                            <i class="fas fa-file-pdf"></i> Import from PDF
                        </button>
                        <button class="pf-v5-c-button pf-m-primary" @click="openOilAnalysisModal()">
                            <i class="fas fa-plus"></i> Add Report
                        </button>
                    </div>
                </template>
            </div>
            <div x-show="activeTab === 'oil'">

            <!-- Loading -->
            <div x-show="!oilLoaded" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading oil records...</h2>
                </div>
            </div>

            <div x-show="oilLoaded" x-cloak>
                <!-- Empty State -->
                <template x-if="oilRecords.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-oil-can" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No oil records</h2>
                            <div class="pf-v5-c-empty-state__body">
                                Track oil consumption by adding records each time you add oil.
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Oil Chart -->
                <template x-if="oilRecords.length >= 2">
                    <div class="pf-v5-c-card" style="margin-bottom: 1rem;">
                        <div class="pf-v5-c-card__title"><h3>Oil Consumption Trend (Hours per Quart)</h3></div>
                        <div class="pf-v5-c-card__body">
                            <canvas id="oilChart" style="max-height: 300px;"></canvas>
                            <p class="pf-v5-u-color-200 pf-v5-u-font-size-sm pf-v5-u-mt-sm">Average is based on the most recent 20 data points, with statistical outliers excluded. Outlier records are marked with <i class="fas fa-exclamation-triangle" style="color: #f0ab00;"></i> in the table below.</p>
                        </div>
                    </div>
                </template>

                <!-- Oil Records Table -->
                <template x-if="oilRecords.length > 0">
                    <table class="pf-v5-c-table consumable-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Hours</th>
                                <th>Qty (qt)</th>
                                <th>Level After</th>
                                <th>Type</th>
                                <th>Notes</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="record in oilRecords" :key="record.id">
                                <tr>
                                    <td data-label="Date">
                                        <span x-text="formatDate(record.date)"></span>
                                        <span x-show="isOilOutlier(record.id)" style="color: #f0ab00; margin-left: 0.3rem;" title="This record's consumption rate is a statistical outlier and was excluded from the average."><i class="fas fa-exclamation-triangle"></i></span>
                                    </td>
                                    <td data-label="Hours">
                                        <span class="consumable-field-label">At </span><span x-text="formatHours(record.flight_hours)"></span>
                                    </td>
                                    <td data-label="Qty (qt)">
                                        <span class="consumable-field-label">Added </span><span x-text="record.quantity_added"></span>
                                    </td>
                                    <td data-label="Level After" :class="{ 'consumable-empty-field': !record.level_after }">
                                        <span class="consumable-field-label">Level </span><span x-text="record.level_after || '-'"></span>
                                    </td>
                                    <td data-label="Type" :class="{ 'consumable-empty-field': !record.consumable_type }" x-text="record.consumable_type || '-'"></td>
                                    <td data-label="Notes" :class="{ 'consumable-empty-field': !record.notes }" x-text="record.notes || '-'"></td>
                                    <td data-label="Actions">
                                        <button class="pf-v5-c-button pf-m-plain" x-show="isOwner" @click="editOilRecord(record)" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="pf-v5-c-button pf-m-plain" x-show="isOwner" @click="cardDeleteOilRecord(record)" title="Delete" style="color: var(--pf-v5-global--danger-color--100);">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </template>
            </div>
            </div>
            <div x-show="activeTab === 'fuel'">

            <!-- Loading -->
            <div x-show="!fuelLoaded" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading fuel records...</h2>
                </div>
            </div>

            <div x-show="fuelLoaded" x-cloak>
                <!-- Empty State -->
                <template x-if="fuelRecords.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-gas-pump" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No fuel records</h2>
                            <div class="pf-v5-c-empty-state__body">
                                Track fuel consumption by adding records each time you refuel.
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Fuel Chart -->
                <template x-if="fuelRecords.length >= 2">
                    <div class="pf-v5-c-card" style="margin-bottom: 1rem;">
                        <div class="pf-v5-c-card__title"><h3>Fuel Consumption Trend (Gallons per Hour)</h3></div>
                        <div class="pf-v5-c-card__body">
                            <canvas id="fuelChart" style="max-height: 300px;"></canvas>
                            <p class="pf-v5-u-color-200 pf-v5-u-font-size-sm pf-v5-u-mt-sm">Average is based on the most recent 20 data points, with statistical outliers excluded. Outlier records are marked with <i class="fas fa-exclamation-triangle" style="color: #f0ab00;"></i> in the table below.</p>
                        </div>
                    </div>
                </template>

                <!-- Fuel Records Table -->
                <template x-if="fuelRecords.length > 0">
                    <table class="pf-v5-c-table consumable-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Hours</th>
                                <th>Qty (gal)</th>
                                <th>Level After</th>
                                <th>Type</th>
                                <th>Notes</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="record in fuelRecords" :key="record.id">
                                <tr>
                                    <td data-label="Date">
                                        <span x-text="formatDate(record.date)"></span>
                                        <span x-show="isFuelOutlier(record.id)" style="color: #f0ab00; margin-left: 0.3rem;" title="This record's consumption rate is a statistical outlier and was excluded from the average."><i class="fas fa-exclamation-triangle"></i></span>
                                    </td>
                                    <td data-label="Hours">
                                        <span class="consumable-field-label">At </span><span x-text="formatHours(record.flight_hours)"></span>
                                    </td>
                                    <td data-label="Qty (gal)">
                                        <span class="consumable-field-label">Added </span><span x-text="record.quantity_added"></span>
                                    </td>
                                    <td data-label="Level After" :class="{ 'consumable-empty-field': !record.level_after }">
                                        <span class="consumable-field-label">Level </span><span x-text="record.level_after || '-'"></span>
                                    </td>
                                    <td data-label="Type" :class="{ 'consumable-empty-field': !record.consumable_type }" x-text="record.consumable_type || '-'"></td>
                                    <td data-label="Notes" :class="{ 'consumable-empty-field': !record.notes }" x-text="record.notes || '-'"></td>
                                    <td data-label="Actions">
                                        <button class="pf-v5-c-button pf-m-plain" x-show="isOwner" @click="editFuelRecord(record)" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="pf-v5-c-button pf-m-plain" x-show="isOwner" @click="cardDeleteFuelRecord(record)" title="Delete" style="color: var(--pf-v5-global--danger-color--100);">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </template>
            </div>
            </div>

            <!-- Oil Analysis Tab -->
            <div x-show="activeTab === 'oil-analysis'">

            <!-- Loading -->
            <div x-show="!oilAnalysisLoaded" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading oil analysis reports...</h2>
                </div>
            </div>

            <div x-show="oilAnalysisLoaded" x-cloak>

                <!-- Component filter -->
                <template x-if="oilAnalysisEngineComponents.length > 1">
                    <div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <label class="pf-v5-c-form__label" for="oilAnalysisComponentFilter" style="margin: 0;">Filter by component:</label>
                        <select id="oilAnalysisComponentFilter" class="pf-v5-c-form-control" style="max-width: 300px;"
                                x-model="oilAnalysisFilterComponent"
                                @change="oilAnalysisLoaded = false; loadOilAnalysis()">
                            <option value="">All components</option>
                            <template x-for="comp in oilAnalysisEngineComponents" :key="comp.id">
                                <option :value="comp.id" x-text="comp.component_type_name + (comp.install_location ? ' (' + comp.install_location + ')' : '')"></option>
                            </template>
                        </select>
                    </div>
                </template>

                <!-- Empty State -->
                <template x-if="oilAnalysisFilteredReports.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-flask" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No oil analysis reports</h2>
                            <div class="pf-v5-c-empty-state__body">
                                Track engine health by adding oil analysis lab reports.
                            </div>
                            <div class="pf-v5-c-empty-state__primary" x-show="canWrite" style="margin-top: 1rem;">
                                <button class="pf-v5-c-button pf-m-secondary" @click="openOilAnalysisAiModal()" style="margin-right: 0.5rem;">
                                    <i class="fas fa-file-pdf"></i> Import from PDF
                                </button>
                                <button class="pf-v5-c-button pf-m-primary" @click="openOilAnalysisModal()">
                                    <i class="fas fa-plus"></i> Add Report
                                </button>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Chart and element toggles -->
                <template x-if="oilAnalysisFilteredReports.length >= 2">
                    <div>
                        <!-- Element toggle chips -->
                        <div style="margin-bottom: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.4rem; align-items: center;">
                            <span style="font-size: 0.875rem; color: var(--pf-v5-global--Color--200); margin-right: 0.25rem;">Show elements:</span>
                            <template x-for="el in ['iron','copper','chromium','aluminum','lead','silicon','nickel','tin','molybdenum','magnesium','potassium','boron','sodium','calcium','phosphorus','zinc','barium','silver','titanium','manganese']" :key="el">
                                <button class="pf-v5-c-button"
                                        :class="isOilAnalysisElementSelected(el) ? 'pf-m-primary' : 'pf-m-secondary'"
                                        style="padding: 0.2rem 0.6rem; font-size: 0.8rem; text-transform: capitalize;"
                                        @click="toggleOilAnalysisElement(el)"
                                        x-text="el"></button>
                            </template>
                        </div>

                        <div class="pf-v5-c-card" style="margin-bottom: 1rem;">
                            <div class="pf-v5-c-card__title"><h3>Element Trend (PPM over Time)</h3></div>
                            <div class="pf-v5-c-card__body">
                                <canvas id="oilAnalysisChart" style="max-height: 350px;"></canvas>
                                <p class="pf-v5-u-color-200 pf-v5-u-font-size-sm pf-v5-u-mt-sm">
                                    Outlier values (IQR method) shown as larger <span style="color: #f0ab00;">&#9650;</span> orange points. Dashed lines show per-element averages.
                                </p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Reports Table -->
                <template x-if="oilAnalysisFilteredReports.length > 0">
                    <table class="pf-v5-c-table consumable-table">
                        <thead>
                            <tr>
                                <th>Sample Date</th>
                                <th>Engine Hours</th>
                                <th>Oil Hours</th>
                                <th>Status</th>
                                <th>Lab</th>
                                <th>Key Elements (ppm)</th>
                                <th>Component</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="report in oilAnalysisFilteredReports" :key="report.id">
                                <tr>
                                    <td data-label="Sample Date" x-text="formatDate(report.sample_date)"></td>
                                    <td data-label="Engine Hours" :class="{ 'consumable-empty-field': !report.engine_hours }">
                                        <span x-text="report.engine_hours != null ? formatHours(report.engine_hours) : '-'"></span>
                                    </td>
                                    <td data-label="Oil Hours" :class="{ 'consumable-empty-field': !report.oil_hours }">
                                        <span x-text="report.oil_hours != null ? report.oil_hours + ' hrs' : '-'"></span>
                                    </td>
                                    <td data-label="Status">
                                        <template x-if="report.status">
                                            <span class="pf-v5-c-label" :class="oilAnalysisStatusClass(report.status)">
                                                <span class="pf-v5-c-label__content" x-text="oilAnalysisStatusLabel(report.status)"></span>
                                            </span>
                                        </template>
                                        <template x-if="!report.status">
                                            <span class="consumable-empty-field">—</span>
                                        </template>
                                    </td>
                                    <td data-label="Lab" :class="{ 'consumable-empty-field': !report.lab }" x-text="report.lab || '-'"></td>
                                    <td data-label="Key Elements (ppm)" style="font-size: 0.82rem; white-space: nowrap;">
                                        <template x-if="report.elements_ppm && Object.keys(report.elements_ppm).length > 0">
                                            <span>
                                                <template x-for="el in ['iron','copper','chromium','aluminum','lead','silicon']" :key="el">
                                                    <span x-show="report.elements_ppm[el] != null" style="margin-right: 0.5rem;">
                                                        <span style="text-transform: capitalize; font-weight: 500;" x-text="el.slice(0,2).toUpperCase() + ':'"></span>
                                                        <span x-text="report.elements_ppm[el]"></span>
                                                    </span>
                                                </template>
                                            </span>
                                        </template>
                                        <template x-if="!report.elements_ppm || Object.keys(report.elements_ppm).length === 0">
                                            <span class="consumable-empty-field">—</span>
                                        </template>
                                    </td>
                                    <td data-label="Component" :class="{ 'consumable-empty-field': !report.component_display }">
                                        <span x-text="report.component_display || '-'"></span>
                                    </td>
                                    <td data-label="Actions">
                                        <button class="pf-v5-c-button pf-m-plain" x-show="isOwner" @click="editOilAnalysisReport(report)" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </template>
            </div>
            </div>
        </div>

        <!-- Documents Tab -->
        <div x-show="activeTab === 'documents'" class="pf-v5-c-page__main-section">
            <!-- Header with action buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Documents</h2>
                <div x-show="isOwner" style="display: flex; gap: 0.5rem;">
                    <button class="pf-v5-c-button pf-m-secondary" @click="openCollectionModal()">
                        <i class="fas fa-folder-plus"></i> Add Collection
                    </button>
                    <button class="pf-v5-c-button pf-m-primary" @click="openDocumentModal()">
                        <i class="fas fa-plus"></i> Add Document
                    </button>
                </div>
            </div>

            <!-- Loading State for Documents -->
            <div x-show="documentsLoading" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading documents...</h2>
                </div>
            </div>

            <!-- Documents Content -->
            <div x-show="!documentsLoading" x-cloak>
                <!-- Empty State -->
                <template x-if="documentCollections.length === 0 && uncollectedDocuments.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No documents</h2>
                            <div class="pf-v5-c-empty-state__body">
                                No documents have been uploaded for this aircraft yet.
                            </div>
                            <div class="pf-v5-c-empty-state__primary" x-show="isOwner" style="margin-top: 1rem;">
                                <button class="pf-v5-c-button pf-m-secondary" @click="openCollectionModal()">
                                    <i class="fas fa-folder-plus"></i> Add Collection
                                </button>
                                <button class="pf-v5-c-button pf-m-primary" @click="openDocumentModal()" style="margin-left: 0.5rem;">
                                    <i class="fas fa-plus"></i> Add Document
                                </button>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Document Collections -->
                <div class="pf-v5-l-stack pf-m-gutter" x-show="documentCollections.length > 0 || uncollectedDocuments.length > 0">
                    <!-- Collections -->
                    <template x-for="collection in [...documentCollections].sort((a, b) => { if (a.starred && !b.starred) return -1; if (!a.starred && b.starred) return 1; return (a.name || '').localeCompare(b.name || ''); })" :key="collection.id">
                        <div class="pf-v5-c-card" x-data="{ collapsed: true, collMenuOpen: false }">
                            <div class="pf-v5-c-card__header">
                                <div class="pf-v5-c-card__header-main">
                                    <div class="pf-v5-c-card__title" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;" @click="collapsed = !collapsed">
                                        <i class="fas" :class="collapsed ? 'fa-chevron-right' : 'fa-chevron-down'" style="font-size: 0.75rem; opacity: 0.6;"></i>
                                        <h2 x-text="collection.name"></h2>
                                        <i x-show="collection.starred" class="fas fa-star" style="font-size: 0.7rem; color: var(--pf-v5-global--warning-color--100); opacity: 0.8;"></i>
                                    </div>
                                </div>
                                <div class="pf-v5-c-card__actions" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <!-- Visibility badge -->
                                    <span x-show="isOwner"
                                          class="pf-v5-c-label"
                                          :class="collection.visibility === 'status' ? 'pf-m-green' : collection.visibility === 'maintenance' ? 'pf-m-blue' : 'pf-m-grey'"
                                          x-text="collection.visibility === 'private' ? 'Private' : collection.visibility === 'status' ? 'Public' : 'Maintenance'">
                                    </span>
                                    <!-- Page count -->
                                    <span class="pf-v5-c-label pf-m-blue">
                                        <span x-text="collection.document_count + ' pages'"></span>
                                    </span>
                                    <!-- Overflow menu (owners only) -->
                                    <div x-show="isOwner" class="doc-coll-overflow" @click.outside="collMenuOpen = false">
                                        <button class="pf-v5-c-button pf-m-plain"
                                                @click.stop="collMenuOpen = !collMenuOpen"
                                                title="More actions" aria-label="More actions">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div class="doc-coll-overflow-menu" x-show="collMenuOpen">
                                            <button class="doc-coll-overflow-item" @click="starCollection(collection); collMenuOpen = false">
                                                <i class="fas fa-star" :style="collection.starred ? 'color: var(--pf-v5-global--warning-color--100);' : 'opacity: 0.4;'"></i>
                                                <span x-text="collection.starred ? 'Unpin from top' : 'Pin to top'"></span>
                                            </button>
                                            <div class="doc-coll-overflow-section">Visibility</div>
                                            <button class="doc-coll-overflow-item" @click="setCollectionVisibility(collection, 'private'); collMenuOpen = false">
                                                <i class="fas fa-lock"></i> Private
                                                <i class="fas fa-check doc-coll-overflow-check" x-show="collection.visibility === 'private'"></i>
                                            </button>
                                            <button class="doc-coll-overflow-item" @click="setCollectionVisibility(collection, 'status'); collMenuOpen = false">
                                                <i class="fas fa-globe"></i> Public
                                                <i class="fas fa-check doc-coll-overflow-check" x-show="collection.visibility === 'status'"></i>
                                            </button>
                                            <button class="doc-coll-overflow-item" @click="setCollectionVisibility(collection, 'maintenance'); collMenuOpen = false">
                                                <i class="fas fa-tools"></i> Maintenance only
                                                <i class="fas fa-check doc-coll-overflow-check" x-show="collection.visibility === 'maintenance'"></i>
                                            </button>
                                            <div class="doc-coll-overflow-section">Actions</div>
                                            <button class="doc-coll-overflow-item" @click="openDocumentModalForCollection(collection); collMenuOpen = false">
                                                <i class="fas fa-plus"></i> Add document
                                            </button>
                                            <button class="doc-coll-overflow-item" @click="editCollection(collection); collMenuOpen = false">
                                                <i class="fas fa-pencil-alt"></i> Edit
                                            </button>
                                            <button class="doc-coll-overflow-item doc-coll-overflow-danger" @click="deleteCollection(collection); collMenuOpen = false">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <template x-if="collection.description && !collapsed">
                                <div class="pf-v5-c-card__body">
                                    <p x-text="collection.description" style="color: var(--pf-v5-global--Color--200);"></p>
                                </div>
                            </template>
                            <div class="pf-v5-c-card__body" x-show="!collapsed">
                                <div class="document-grid">
                                    <template x-for="doc in collection.documents" :key="doc.id">
                                        <div class="document-item" style="position: relative;" @click="openDocumentViewer(doc, collection.name)">
                                            <div class="document-item-actions" x-show="isOwner" style="position: absolute; top: 0.25rem; right: 0.25rem; display: flex; gap: 0.125rem; z-index: 2;">
                                                <button class="pf-v5-c-button pf-m-plain" style="padding: 0.25rem; font-size: 0.75rem;" @click.stop="toggleDocumentSharing(doc)"
                                                        :title="doc.visibility === 'status' ? 'All share links (click to cycle)' : doc.visibility === 'maintenance' ? 'Maintenance only (click to cycle)' : doc.visibility === 'private' ? 'Hidden (click to cycle)' : 'Inherits from collection (click to cycle)'"
                                                        :style="doc.visibility === 'status' ? 'color: var(--pf-v5-global--success-color--100);' : doc.visibility === 'maintenance' ? 'color: var(--pf-v5-global--info-color--100);' : doc.visibility === 'private' ? 'color: var(--pf-v5-global--danger-color--100);' : ''">
                                                    <i class="fas" :class="doc.visibility === 'status' ? 'fa-globe' : doc.visibility === 'maintenance' ? 'fa-tools' : doc.visibility === 'private' ? 'fa-eye-slash' : 'fa-minus-circle'"></i>
                                                </button>
                                                <button class="pf-v5-c-button pf-m-plain" style="padding: 0.25rem; font-size: 0.75rem;" @click="editDocument(doc, $event)" title="Edit document">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </button>
                                                <button class="pf-v5-c-button pf-m-plain pf-m-danger" style="padding: 0.25rem; font-size: 0.75rem;" @click="deleteDocument(doc, $event)" title="Delete document">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <div class="document-thumbnail">
                                                <template x-if="doc.images && doc.images.length > 0 && getFileType(doc.images[0].image) === 'image'">
                                                    <img :src="doc.images[0].image" :alt="doc.name">
                                                </template>
                                                <template x-if="doc.images && doc.images.length > 0 && getFileType(doc.images[0].image) !== 'image'">
                                                    <div class="document-placeholder">
                                                        <i :class="getFileIcon(doc.images[0].image)" style="color: var(--pf-v5-global--danger-color--100);"></i>
                                                    </div>
                                                </template>
                                                <template x-if="!doc.images || doc.images.length === 0">
                                                    <div class="document-placeholder">
                                                        <i class="fas fa-file-alt"></i>
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="document-info">
                                                <span class="document-name" x-text="doc.name"></span>
                                                <span class="document-type" x-text="doc.doc_type_display"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Uncollected Documents -->
                    <template x-if="uncollectedDocuments.length > 0">
                        <div class="pf-v5-c-card">
                            <div class="pf-v5-c-card__header">
                                <div class="pf-v5-c-card__header-main">
                                    <div class="pf-v5-c-card__title">
                                        <h2>Other Documents</h2>
                                    </div>
                                </div>
                                <div class="pf-v5-c-card__actions">
                                    <span class="pf-v5-c-label pf-m-grey">
                                        <span x-text="uncollectedDocuments.length + ' documents'"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="pf-v5-c-card__body">
                                <div class="document-grid">
                                    <template x-for="doc in uncollectedDocuments" :key="doc.id">
                                        <div class="document-item" style="position: relative;" @click="openDocumentViewer(doc, 'Other Documents')">
                                            <div class="document-item-actions" x-show="isOwner" style="position: absolute; top: 0.25rem; right: 0.25rem; display: flex; gap: 0.125rem; z-index: 2;">
                                                <button class="pf-v5-c-button pf-m-plain" style="padding: 0.25rem; font-size: 0.75rem;" @click.stop="toggleDocumentSharing(doc)"
                                                        :title="doc.visibility === 'status' ? 'All share links (click to cycle)' : doc.visibility === 'maintenance' ? 'Maintenance only (click to cycle)' : 'Hidden (click to share)'"
                                                        :style="doc.visibility === 'status' ? 'color: var(--pf-v5-global--success-color--100);' : doc.visibility === 'maintenance' ? 'color: var(--pf-v5-global--info-color--100);' : ''">
                                                    <i class="fas" :class="doc.visibility === 'status' ? 'fa-globe' : doc.visibility === 'maintenance' ? 'fa-tools' : 'fa-lock'"></i>
                                                </button>
                                                <button class="pf-v5-c-button pf-m-plain" style="padding: 0.25rem; font-size: 0.75rem;" @click="editDocument(doc, $event)" title="Edit document">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </button>
                                                <button class="pf-v5-c-button pf-m-plain pf-m-danger" style="padding: 0.25rem; font-size: 0.75rem;" @click="deleteDocument(doc, $event)" title="Delete document">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <div class="document-thumbnail">
                                                <template x-if="doc.images && doc.images.length > 0 && getFileType(doc.images[0].image) === 'image'">
                                                    <img :src="doc.images[0].image" :alt="doc.name">
                                                </template>
                                                <template x-if="doc.images && doc.images.length > 0 && getFileType(doc.images[0].image) !== 'image'">
                                                    <div class="document-placeholder">
                                                        <i :class="getFileIcon(doc.images[0].image)" style="color: var(--pf-v5-global--danger-color--100);"></i>
                                                    </div>
                                                </template>
                                                <template x-if="!doc.images || doc.images.length === 0">
                                                    <div class="document-placeholder">
                                                        <i class="fas fa-file-alt"></i>
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="document-info">
                                                <span class="document-name" x-text="doc.name"></span>
                                                <span class="document-type" x-text="doc.doc_type_display"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Sharing & Access Tab -->
    <div x-show="activeTab === 'roles'" class="pf-v5-c-page__main-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Sharing &amp; Access</h2>
        </div>

        <!-- Share Links Card -->
        <div class="pf-v5-c-card" style="margin-bottom: 1rem;">
            <div class="pf-v5-c-card__header">
                <div class="pf-v5-c-card__header-main">
                    <div class="pf-v5-c-card__title"><h3 class="pf-v5-c-card__title-text">Share Links</h3></div>
                </div>
                <div class="pf-v5-c-card__actions">
                    <button class="pf-v5-c-button pf-m-primary" @click="openShareTokenModal()">
                        <i class="fas fa-plus"></i> Create Link
                    </button>
                </div>
            </div>
            <div class="pf-v5-c-card__body">
                <template x-if="shareTokens.length === 0 && shareTokensLoaded">
                    <p style="color: var(--pf-v5-global--Color--200);">No share links created yet.</p>
                </template>
                <table class="pf-v5-c-table pf-m-compact" x-show="shareTokens.length > 0">
                    <thead>
                        <tr>
                            <th>Label</th>
                            <th>Access Level</th>
                            <th>Expires</th>
                            <th>URL</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="t in shareTokens" :key="t.id">
                            <tr>
                                <td x-text="t.label || '—'"></td>
                                <td>
                                    <span class="pf-v5-c-label"
                                          :class="t.privilege === 'maintenance' ? 'pf-m-blue' : 'pf-m-green'">
                                        <span class="pf-v5-c-label__content"
                                              x-text="t.privilege === 'maintenance' ? 'Maintenance Detail' : 'Current Status'"></span>
                                    </span>
                                </td>
                                <td x-text="t.expires_at ? formatDate(t.expires_at) : 'Never'"></td>
                                <td style="max-width: 18rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    <span style="font-family: monospace; font-size: 0.8rem;" x-text="t.share_url"></span>
                                </td>
                                <td style="white-space: nowrap;">
                                    <button class="pf-v5-c-button pf-m-plain" @click="copyTokenUrl(t.share_url)" title="Copy link">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="pf-v5-c-button pf-m-plain pf-m-danger" @click="revokeShareToken(t.id)" title="Revoke link">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export Card -->
        <div class="pf-v5-c-card" style="margin-bottom: 1rem;">
            <div class="pf-v5-c-card__header">
                <div class="pf-v5-c-card__header-main">
                    <div class="pf-v5-c-card__title"><h3 class="pf-v5-c-card__title-text">Export Archive</h3></div>
                </div>
                <div class="pf-v5-c-card__actions">
                    <a :href="'/api/aircraft/' + aircraftId + '/export/'"
                       class="pf-v5-c-button pf-m-secondary">
                        <i class="fas fa-download"></i> Download Archive
                    </a>
                </div>
            </div>
            <div class="pf-v5-c-card__body">
                <p style="color: var(--pf-v5-global--Color--200); margin: 0;">
                    Export all aircraft data — components, logbook entries, squawks, inspections,
                    ADs, and file attachments — as a <code>.sam.zip</code> archive.
                    The archive can be imported into any Simple Aircraft Manager instance.
                </p>
            </div>
        </div>

        <!-- Roles Card -->
        <div class="pf-v5-c-card">
            <div class="pf-v5-c-card__header">
                <div class="pf-v5-c-card__header-main">
                    <div class="pf-v5-c-card__title"><h3>User Roles</h3></div>
                </div>
                <div class="pf-v5-c-card__actions">
                    <button class="pf-v5-c-button pf-m-primary" @click="openRoleModal()">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </div>
            </div>
            <div class="pf-v5-c-card__body">
                <template x-if="roles.length === 0 && rolesLoaded">
                    <p style="color: var(--pf-v5-global--Color--200);">No roles assigned.</p>
                </template>
                <table class="pf-v5-c-table pf-m-compact" x-show="roles.length > 0">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Added</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="r in roles" :key="r.id">
                            <tr>
                                <td x-text="r.username"></td>
                                <td x-text="r.user_display"></td>
                                <td>
                                    <select class="pf-v5-c-form-control"
                                            :value="r.role"
                                            @change="updateRole(r, $event.target.value)"
                                            style="width: auto; min-width: 6rem;">
                                        <option value="owner">Owner</option>
                                        <option value="pilot">Pilot</option>
                                    </select>
                                </td>
                                <td x-text="formatDate(r.created_at)"></td>
                                <td>
                                    <button class="pf-v5-c-button pf-m-plain pf-m-danger"
                                            @click="removeRole(r)"
                                            title="Remove user">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create Share Token Modal -->
    <div class="pf-v5-c-backdrop" x-show="shareTokenModalOpen" x-cloak @click.self="closeShareTokenModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-sm" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeShareTokenModal()" style="position: absolute; top: 1rem; right: 1rem;">
                    <i class="fas fa-times"></i>
                </button>
                <div class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Create Share Link</h1>
                </div>
                <div class="pf-v5-c-modal-box__body">
                    <template x-if="shareTokenError">
                        <div class="pf-v5-c-alert pf-m-danger pf-m-inline" style="margin-bottom: 1rem;">
                            <p class="pf-v5-c-alert__title" x-text="shareTokenError"></p>
                        </div>
                    </template>
                    <div class="pf-v5-c-form__group" style="margin-bottom: 1rem;">
                        <label class="pf-v5-c-form__label">Label <span style="color: var(--pf-v5-global--Color--200); font-weight: normal;">(optional)</span></label>
                        <input class="pf-v5-c-form-control" type="text" x-model="shareTokenForm.label"
                               placeholder="e.g. Annual inspection viewer" maxlength="100">
                    </div>
                    <div class="pf-v5-c-form__group" style="margin-bottom: 1rem;">
                        <label class="pf-v5-c-form__label">Access Level <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span></label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.25rem;">
                            <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" x-model="shareTokenForm.privilege" value="status" style="margin-top: 0.2rem;">
                                <span>
                                    <strong>Current Status</strong><br>
                                    <span style="color: var(--pf-v5-global--Color--200); font-size: 0.85rem;">Overview, airworthiness, active squawks, public notes, documents. No maintenance history.</span>
                                </span>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" x-model="shareTokenForm.privilege" value="maintenance" style="margin-top: 0.2rem;">
                                <span>
                                    <strong>Maintenance Detail</strong><br>
                                    <span style="color: var(--pf-v5-global--Color--200); font-size: 0.85rem;">Full maintenance history including logbook, AD history, inspection records, and major repairs.</span>
                                </span>
                            </label>
                        </div>
                    </div>
                    <div class="pf-v5-c-form__group" style="margin-bottom: 1rem;">
                        <label class="pf-v5-c-form__label">Expires after <span style="color: var(--pf-v5-global--Color--200); font-weight: normal;">(optional)</span></label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input class="pf-v5-c-form-control" type="number" x-model="shareTokenForm.expires_in_days"
                                   placeholder="No expiration" min="1" style="width: 8rem;">
                            <span style="color: var(--pf-v5-global--Color--200); white-space: nowrap;">days</span>
                        </div>
                    </div>
                </div>
                <div class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="createShareToken()" :disabled="shareTokenSubmitting || !shareTokenForm.privilege">
                        <template x-if="shareTokenSubmitting">
                            <span class="pf-v5-c-spinner pf-m-sm" role="progressbar">
                                <span class="pf-v5-c-spinner__clipper"></span>
                            </span>
                        </template>
                        Create Link
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeShareTokenModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Role Modal -->
    <div class="pf-v5-c-backdrop" x-show="roleModalOpen" x-cloak @click.self="closeRoleModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-sm" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeRoleModal()" style="position: absolute; top: 1rem; right: 1rem;">
                    <i class="fas fa-times"></i>
                </button>
                <div class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Add User Role</h1>
                </div>
                <div class="pf-v5-c-modal-box__body">
                    <template x-if="roleError">
                        <div class="pf-v5-c-alert pf-m-danger pf-m-inline" style="margin-bottom: 1rem;">
                            <p class="pf-v5-c-alert__title" x-text="roleError"></p>
                        </div>
                    </template>
                    <div class="pf-v5-c-form__group" style="margin-bottom: 1rem; position: relative;">
                        <label class="pf-v5-c-form__label">Search User</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input class="pf-v5-c-form-control" type="text"
                                   x-model="userSearchQuery"
                                   @input="onUserSearchInput()"
                                   placeholder="Type username or name..."
                                   :disabled="!!selectedUser">
                            <template x-if="selectedUser">
                                <button class="pf-v5-c-button pf-m-plain" type="button"
                                        @click="clearUserSelection()" title="Clear selection"
                                        style="padding: 0.25rem 0.5rem; flex-shrink: 0;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </template>
                            <template x-if="userSearchLoading">
                                <span class="pf-v5-c-spinner pf-m-sm" role="progressbar" style="flex-shrink: 0;">
                                    <span class="pf-v5-c-spinner__clipper"></span>
                                </span>
                            </template>
                        </div>
                        <template x-if="userSearchResults.length > 0">
                            <ul style="position: absolute; z-index: 200; background: var(--pf-v5-global--BackgroundColor--100); border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 4px; width: 100%; margin: 0; padding: 0; list-style: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto;">
                                <template x-for="u in userSearchResults" :key="u.id">
                                    <li @click="selectUser(u)"
                                        style="padding: 0.5rem 0.75rem; cursor: pointer;"
                                        @mouseenter="$el.style.background='var(--pf-v5-global--BackgroundColor--200)'"
                                        @mouseleave="$el.style.background=''"
                                        x-text="u.display">
                                    </li>
                                </template>
                            </ul>
                        </template>
                        <p class="pf-v5-c-form__helper-text" style="color: var(--pf-v5-global--Color--200); font-size: 0.8rem; margin-top: 0.25rem;">
                            Type at least 2 characters to search.
                        </p>
                    </div>
                    <div class="pf-v5-c-form__group">
                        <label class="pf-v5-c-form__label">Role</label>
                        <select class="pf-v5-c-form-control" x-model="roleForm.role">
                            <option value="pilot">Pilot</option>
                            <option value="owner">Owner</option>
                        </select>
                    </div>
                </div>
                <div class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="addRole()" :disabled="roleSubmitting || !roleForm.user">
                        <template x-if="roleSubmitting">
                            <span class="pf-v5-c-spinner pf-m-sm" role="progressbar">
                                <span class="pf-v5-c-spinner__clipper"></span>
                            </span>
                        </template>
                        Add Role
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeRoleModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logbook Entry Modal -->
    <div class="pf-v5-c-backdrop" x-show="logbookModalOpen" x-cloak @click.self="closeLogbookModal()" style="z-index: 1100;">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeLogbookModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingLogEntry ? 'Edit Logbook Entry' : 'New Logbook Entry'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitLogEntry" class="pf-v5-c-form">
                        <!-- Date / Hours row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="log-date">
                                    <span class="pf-v5-c-form__label-text">Date</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="log-date" class="pf-v5-c-form-control" type="date" x-model="logbookForm.date" required>
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="log-hours">
                                    <span class="pf-v5-c-form__label-text">Aircraft Hours</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="log-hours" class="pf-v5-c-form-control" type="number" step="0.1" min="0" x-model="logbookForm.aircraft_hours_at_entry" placeholder="e.g. 1234.5">
                                </div>
                            </div>
                        </div>

                        <!-- Entry Type / Log Type row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="log-entry-type">
                                    <span class="pf-v5-c-form__label-text">Entry Type</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <select id="log-entry-type" class="pf-v5-c-form-control" x-model="logbookForm.entry_type">
                                        <option value="MAINTENANCE">Maintenance</option>
                                        <option value="INSPECTION">Inspection</option>
                                        <option value="FLIGHT">Flight</option>
                                        <option value="HOURS_UPDATE">Hours Update</option>
                                        <option value="OTHER">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="log-type">
                                    <span class="pf-v5-c-form__label-text">Log Book</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <select id="log-type" class="pf-v5-c-form-control" x-model="logbookForm.log_type">
                                        <option value="AC">Airframe</option>
                                        <option value="ENG">Engine</option>
                                        <option value="PROP">Propeller</option>
                                        <option value="OTHER">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Entry Text -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="log-text">
                                <span class="pf-v5-c-form__label-text">Entry Description</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="log-text" class="pf-v5-c-form-control" rows="4" x-model="logbookForm.text" required placeholder="Describe the maintenance performed, inspection completed, etc."></textarea>
                            </div>
                        </div>

                        <!-- Signoff row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="log-signoff-person">
                                    <span class="pf-v5-c-form__label-text">Signed Off By</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="log-signoff-person" class="pf-v5-c-form-control" type="text" x-model="logbookForm.signoff_person" placeholder="Mechanic name / certificate #">
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="log-signoff-location">
                                    <span class="pf-v5-c-form__label-text">Location</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="log-signoff-location" class="pf-v5-c-form-control" type="text" x-model="logbookForm.signoff_location" placeholder="Airport / facility">
                                </div>
                            </div>
                        </div>

                        <!-- Page Number (when entry has an attached document) -->
                        <template x-if="editingLogEntry && editingLogEntry.log_image">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="log-page-number">
                                    <span class="pf-v5-c-form__label-text">Page Number</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="log-page-number" class="pf-v5-c-form-control" type="number" min="1" step="1" x-model="logbookForm.page_number" placeholder="Page in attached document">
                                    <p style="font-size: 0.8em; color: var(--pf-v5-global--Color--200); margin-top: 0.25rem;">
                                        Which page of the attached document this entry appears on.
                                    </p>
                                </div>
                            </div>
                        </template>

                        <!-- Attach Images (new entries only) -->
                        <template x-if="!editingLogEntry">
                            <div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="log-images">
                                        <span class="pf-v5-c-form__label-text">Attach Images / Documents</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input id="log-images" class="pf-v5-c-form-control" type="file" multiple
                                               accept=".jpg,.jpeg,.png,.gif,.webp,.bmp,.tiff,.pdf,.txt"
                                               @change="onLogbookFilesSelected($event)">
                                        <p style="font-size: 0.8em; color: var(--pf-v5-global--Color--200); margin-top: 0.25rem;">
                                            Files are uploaded as a new document linked to this entry. Accepted: images, PDF, TXT.
                                        </p>
                                        <template x-if="logbookImageFiles.length > 0">
                                            <p style="font-size: 0.85em; margin-top: 0.25rem;">
                                                <i class="fas fa-paperclip"></i>
                                                <span x-text="logbookImageFiles.length"></span> file(s) selected
                                            </p>
                                        </template>
                                    </div>
                                </div>
                                <template x-if="logbookImageFiles.length > 0">
                                    <div class="pf-v5-c-form__group">
                                        <label class="pf-v5-c-form__label" for="log-collection">
                                            <span class="pf-v5-c-form__label-text">Document Collection</span>
                                        </label>
                                        <div class="pf-v5-c-form__group-control">
                                            <select id="log-collection" class="pf-v5-c-form-control" x-model="logbookForm.document_collection">
                                                <option value="">— No collection (uncollected) —</option>
                                                <template x-for="col in aircraftCollections" :key="col.id">
                                                    <option :value="col.id" x-text="col.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Related Documents (both new and edit) -->
                        <div style="border-top: 1px solid var(--pf-v5-global--BorderColor--100); margin-top: 1rem; padding-top: 1rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.85rem; font-weight: 600; color: var(--pf-v5-global--Color--100);">
                                    Related Documents <span style="font-weight: 400; color: var(--pf-v5-global--Color--200);">(optional)</span>
                                </span>
                            </div>

                            <!-- Already linked documents (edit mode) -->
                            <template x-if="logbookExistingRelatedDocs.length > 0">
                                <div style="margin-bottom: 0.75rem;">
                                    <span style="font-size: 0.8rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.04em;">Linked</span>
                                    <template x-for="(doc, idx) in logbookExistingRelatedDocs" :key="doc.id">
                                        <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; background: var(--pf-v5-global--BackgroundColor--200); border-radius: 4px; margin-top: 0.35rem;">
                                            <i class="fas fa-file-alt" style="color: var(--pf-v5-global--Color--200);"></i>
                                            <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="doc.name"></span>
                                            <span class="pf-v5-c-label pf-m-compact" style="font-size: 0.75em;" x-text="doc.doc_type_display"></span>
                                            <button type="button" class="pf-v5-c-button pf-m-plain" @click="removeExistingRelatedDoc(idx)" title="Unlink document" style="color: var(--pf-v5-global--danger-color--100); padding: 0.25rem;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Link existing documents -->
                            <div class="pf-v5-c-form__group" style="margin-bottom: 0.75rem;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.4rem;">
                                    <span style="font-size: 0.8rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.04em;">Link Existing Document</span>
                                    <button type="button" class="pf-v5-c-button pf-m-link pf-m-inline" @click="addRelatedDoc()" :disabled="availableDocsForLogbook.length === 0" style="font-size: 0.8rem;">+ Add</button>
                                </div>
                                <template x-for="(rel, idx) in logbookRelatedDocs" :key="idx">
                                    <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; background: var(--pf-v5-global--BackgroundColor--200); border-radius: 4px; margin-bottom: 0.35rem;">
                                        <select class="pf-v5-c-form-control" x-model="rel.document_id" style="flex: 1; min-width: 0;">
                                            <option value="">— Select Document —</option>
                                            <template x-for="d in availableDocsForLogbook" :key="d.id">
                                                <option :value="d.id" x-text="d.name + ' (' + d.doc_type_display + ')'"></option>
                                            </template>
                                        </select>
                                        <button type="button" class="pf-v5-c-button pf-m-plain" @click="removeRelatedDoc(idx)" style="color: var(--pf-v5-global--danger-color--100); padding: 0.25rem;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>

                            <!-- Upload new related documents -->
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="log-related-files">
                                    <span class="pf-v5-c-form__label-text" style="font-size: 0.8rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.04em;">Upload New Documents</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="log-related-files" class="pf-v5-c-form-control" type="file" multiple
                                           accept=".jpg,.jpeg,.png,.gif,.webp,.bmp,.tiff,.pdf,.txt"
                                           @change="onRelatedDocFilesSelected($event)">
                                    <template x-if="logbookRelatedDocFiles.length > 0">
                                        <div style="margin-top: 0.35rem;">
                                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.35rem;">
                                                <label style="font-size: 0.8rem; white-space: nowrap;">Document Type:</label>
                                                <select class="pf-v5-c-form-control" x-model="logbookRelatedDocType" style="flex: 1;">
                                                    <option value="INVOICE">Receipt / Invoice</option>
                                                    <option value="DISC">Discrepancy List</option>
                                                    <option value="ALTER">Alteration Record</option>
                                                    <option value="REPORT">Report</option>
                                                    <option value="ESTIMATE">Estimate</option>
                                                    <option value="OTHER">Other</option>
                                                </select>
                                            </div>
                                            <template x-for="(file, idx) in logbookRelatedDocFiles" :key="idx">
                                                <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.3rem 0.5rem; background: var(--pf-v5-global--BackgroundColor--200); border-radius: 4px; margin-bottom: 0.25rem; font-size: 0.85em;">
                                                    <i class="fas fa-file" style="color: var(--pf-v5-global--Color--200);"></i>
                                                    <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="file.name"></span>
                                                    <button type="button" class="pf-v5-c-button pf-m-plain" @click="removeRelatedDocFile(idx)" style="color: var(--pf-v5-global--danger-color--100); padding: 0.15rem;">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- Associations (new entries only) -->
                        <template x-if="!editingLogEntry && (applicableAds.length > 0 || inspectionTypes.length > 0 || activeSquawks.length > 0)">
                            <div style="border-top: 1px solid var(--pf-v5-global--BorderColor--100); margin-top: 1rem; padding-top: 1rem;">
                                <p style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--pf-v5-global--Color--100);">
                                    Associations <span style="font-weight: 400; color: var(--pf-v5-global--Color--200);">(optional)</span>
                                </p>

                                <!-- AD Compliance rows -->
                                <template x-if="applicableAds.length > 0">
                                    <div class="pf-v5-c-form__group" style="margin-bottom: 0.75rem;">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.4rem;">
                                            <span style="font-size: 0.8rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.04em;">AD Compliance</span>
                                            <button type="button" class="pf-v5-c-button pf-m-link pf-m-inline" @click="addAdAssociation()" :disabled="availableAdsForLogbook.length === 0" style="font-size: 0.8rem;">+ Add Bulletin</button>
                                        </div>
                                        <template x-for="(adAssoc, idx) in logbookAssociations.ads" :key="idx">
                                            <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; background: var(--pf-v5-global--BackgroundColor--200); border-radius: 4px; margin-bottom: 0.35rem;">
                                                <select class="pf-v5-c-form-control" x-model="adAssoc.ad_id" style="flex: 2; min-width: 0;">
                                                    <option value="">— Select AD —</option>
                                                    <template x-for="ad in sortedApplicableAds" :key="ad.id">
                                                        <option :value="ad.id" :disabled="logbookAssociations.ads.some((a, i) => i !== idx && a.ad_id === ad.id)" x-text="ad.name + ' – ' + ad.short_description"></option>
                                                    </template>
                                                </select>
                                                <input type="number" class="pf-v5-c-form-control" x-model="adAssoc.next_due_at_time" placeholder="Next due hrs" style="flex: 1; min-width: 80px;" min="0" step="0.1">
                                                <label style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.8rem; white-space: nowrap; cursor: pointer;">
                                                    <input type="checkbox" x-model="adAssoc.permanent"> Permanent
                                                </label>
                                                <button type="button" class="pf-v5-c-button pf-m-plain" @click="removeAdAssociation(idx)" style="color: var(--pf-v5-global--danger-color--100); padding: 0.25rem;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Inspections rows -->
                                <template x-if="inspectionTypes.length > 0">
                                    <div class="pf-v5-c-form__group" style="margin-bottom: 0.75rem;">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.4rem;">
                                            <span style="font-size: 0.8rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.04em;">Inspections Performed</span>
                                            <button type="button" class="pf-v5-c-button pf-m-link pf-m-inline" @click="addInspectionAssociation()" :disabled="availableInspectionsForLogbook.length === 0" style="font-size: 0.8rem;">+ Add Inspection</button>
                                        </div>
                                        <template x-for="(inspAssoc, idx) in logbookAssociations.inspections" :key="idx">
                                            <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; background: var(--pf-v5-global--BackgroundColor--200); border-radius: 4px; margin-bottom: 0.35rem;">
                                                <select class="pf-v5-c-form-control" x-model="inspAssoc.inspection_type_id" style="flex: 1; min-width: 0;">
                                                    <option value="">— Select Inspection —</option>
                                                    <template x-for="it in sortedInspectionTypes" :key="it.id">
                                                        <option :value="it.id" :disabled="logbookAssociations.inspections.some((a, i) => i !== idx && a.inspection_type_id === it.id)" x-text="it.name"></option>
                                                    </template>
                                                </select>
                                                <button type="button" class="pf-v5-c-button pf-m-plain" @click="removeInspectionAssociation(idx)" style="color: var(--pf-v5-global--danger-color--100); padding: 0.25rem;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Squawks rows -->
                                <template x-if="activeSquawks.length > 0">
                                    <div class="pf-v5-c-form__group">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.4rem;">
                                            <span style="font-size: 0.8rem; font-weight: 600; color: var(--pf-v5-global--Color--200); text-transform: uppercase; letter-spacing: 0.04em;">Squawks Addressed</span>
                                            <button type="button" class="pf-v5-c-button pf-m-link pf-m-inline" @click="addSquawkAssociation()" :disabled="availableSquawksForLogbook.length === 0" style="font-size: 0.8rem;">+ Add Squawk</button>
                                        </div>
                                        <template x-for="(sqAssoc, idx) in logbookAssociations.squawks" :key="idx">
                                            <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; background: var(--pf-v5-global--BackgroundColor--200); border-radius: 4px; margin-bottom: 0.35rem;">
                                                <select class="pf-v5-c-form-control" x-model="sqAssoc.squawk_id" style="flex: 1; min-width: 0;">
                                                    <option value="">— Select Squawk —</option>
                                                    <template x-for="sq in sortedActiveSquawks" :key="sq.id">
                                                        <option :value="sq.id" :disabled="logbookAssociations.squawks.some((a, i) => i !== idx && a.squawk_id === sq.id)" x-text="(sq.component_name ? sq.component_name + ': ' : '') + (sq.issue_reported || '').slice(0, 60)"></option>
                                                    </template>
                                                </select>
                                                <label style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.8rem; white-space: nowrap; cursor: pointer;">
                                                    <input type="checkbox" x-model="sqAssoc.resolve"> Resolve
                                                </label>
                                                <button type="button" class="pf-v5-c-button pf-m-plain" @click="removeSquawkAssociation(idx)" style="color: var(--pf-v5-global--danger-color--100); padding: 0.25rem;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" type="button" @click="submitLogEntry()" :disabled="logbookSubmitting">
                        <span x-show="!logbookSubmitting" x-text="editingLogEntry ? 'Save Changes' : 'Create Entry'"></span>
                        <span x-show="logbookSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" type="button" @click="closeLogbookModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Compliance History Modal -->
    <div class="pf-v5-c-backdrop" x-show="complianceHistoryOpen" x-cloak @click.self="closeComplianceHistory()" style="z-index: 1000;">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeComplianceHistory()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">
                        Compliance History
                        <template x-if="selectedAdForHistory">
                            <span style="font-weight: normal; font-size: 0.9em;"> — <span x-text="selectedAdForHistory.name"></span></span>
                        </template>
                    </h1>
                    <template x-if="selectedAdForHistory?.short_description">
                        <div class="pf-v5-c-modal-box__description" x-text="selectedAdForHistory.short_description"></div>
                    </template>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <!-- Loading -->
                    <div x-show="complianceHistoryLoading" style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner" style="width: 2rem; height: 2rem; margin: 0 auto;"></div>
                        <p style="margin-top: 0.5rem; color: var(--pf-v5-global--Color--200);">Loading history...</p>
                    </div>

                    <!-- Empty -->
                    <template x-if="!complianceHistoryLoading && complianceHistory.length === 0">
                        <div class="pf-v5-c-empty-state">
                            <div class="pf-v5-c-empty-state__content">
                                <i class="fas fa-clipboard" style="font-size: 2.5rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                                <h2 class="pf-v5-c-title pf-m-md">No compliance records</h2>
                                <div class="pf-v5-c-empty-state__body">
                                    No compliance has been recorded for this AD on this aircraft.
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Compliance records table -->
                    <template x-if="!complianceHistoryLoading && complianceHistory.length > 0">
                        <table class="pf-v5-c-table compliance-history-table">
                            <thead>
                                <tr>
                                    <th>Date Complied</th>
                                    <th>Aircraft Hours</th>
                                    <th>Notes</th>
                                    <th>Compliance</th>
                                    <th>Next Due (hrs)</th>
                                    <th>Logbook Entry</th>
                                    <th x-show="isOwner"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="record in complianceHistory" :key="record.id">
                                    <tr>
                                        <td data-label="Date Complied" x-text="formatDate(record.date_complied)"></td>
                                        <td data-label="Aircraft Hours">
                                            <template x-if="record.aircraft_hours_at_compliance">
                                                <span><span class="consumable-field-label">Hours: </span><span x-text="formatHours(record.aircraft_hours_at_compliance)"></span></span>
                                            </template>
                                        </td>
                                        <td data-label="Notes" x-text="record.compliance_notes"></td>
                                        <td data-label="Compliance">
                                            <template x-if="record.permanent">
                                                <span class="pf-v5-c-label pf-m-blue pf-m-compact">Permanent (one-time)</span>
                                            </template>
                                        </td>
                                        <td data-label="Next Due (hrs)">
                                            <template x-if="record.next_due_at_time && record.next_due_at_time > 0">
                                                <span><span class="consumable-field-label">Next due: </span><span x-text="formatHours(record.next_due_at_time) + ' hrs'"></span></span>
                                            </template>
                                        </td>
                                        <td data-label="Logbook Entry">
                                            <template x-if="record.logbook_entry">
                                                <button class="pf-v5-c-button pf-m-link pf-m-inline"
                                                        @click="viewLogEntryFromCompliance(record.logbook_entry)">
                                                    <i class="fas fa-book-open"></i> View
                                                </button>
                                            </template>
                                        </td>
                                        <td data-label="Actions" x-show="isOwner" style="white-space: nowrap;">
                                            <button class="pf-v5-c-button pf-m-plain" title="Edit" @click="openEditComplianceModal(record)">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button class="pf-v5-c-button pf-m-plain" title="Delete" style="color: var(--pf-v5-global--danger-color--100);" @click="deleteComplianceRecord(record)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </template>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" x-show="isOwner" type="button" @click="openComplianceModal(selectedAdForHistory); closeComplianceHistory()">
                        <i class="fas fa-plus"></i> Record New Compliance
                    </button>
                    <button class="pf-v5-c-button pf-m-link" type="button" @click="closeComplianceHistory()">Close</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Logbook Entry Detail Modal (from compliance history / inspection history) -->
    <div class="pf-v5-c-backdrop" x-show="logEntryDetailOpen" x-cloak @click.self="closeLogEntryDetail()" style="z-index: 1200;">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop style="max-height: 80vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeLogEntryDetail()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Logbook Entry</h1>
                    <template x-if="logEntryDetail">
                        <div class="pf-v5-c-modal-box__description">
                            <span x-text="formatDate(logEntryDetail.date)"></span>
                            <span class="pf-v5-c-label pf-m-blue pf-m-compact" style="margin-left: 0.5rem;" x-text="logEntryDetail.entry_type || logEntryDetail.log_type"></span>
                        </div>
                    </template>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <div x-show="logEntryDetailLoading" style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner" style="width: 2rem; height: 2rem; margin: 0 auto;"></div>
                    </div>

                    <template x-if="!logEntryDetailLoading && logEntryDetail">
                        <dl class="pf-v5-c-description-list">
                            <div class="pf-v5-c-description-list__group">
                                <dt class="pf-v5-c-description-list__term">Description</dt>
                                <dd class="pf-v5-c-description-list__description" x-text="logEntryDetail.text"></dd>
                            </div>
                            <template x-if="logEntryDetail.aircraft_hours_at_entry">
                                <div class="pf-v5-c-description-list__group">
                                    <dt class="pf-v5-c-description-list__term">Aircraft Hours</dt>
                                    <dd class="pf-v5-c-description-list__description" x-text="formatHours(logEntryDetail.aircraft_hours_at_entry)"></dd>
                                </div>
                            </template>
                            <template x-if="logEntryDetail.signoff_person">
                                <div class="pf-v5-c-description-list__group">
                                    <dt class="pf-v5-c-description-list__term">Signed By</dt>
                                    <dd class="pf-v5-c-description-list__description">
                                        <span x-text="logEntryDetail.signoff_person"></span>
                                        <template x-if="logEntryDetail.signoff_location">
                                            <span> at <span x-text="logEntryDetail.signoff_location"></span></span>
                                        </template>
                                    </dd>
                                </div>
                            </template>
                            <template x-if="logEntryDetail.log_image_detail && logEntryDetail.log_image_detail.images && logEntryDetail.log_image_detail.images.length > 0 && (!isPublicView || logEntryDetail.log_image_shared)">
                                <div style="margin-top: 1rem; border-top: 1px solid var(--pf-v5-global--BorderColor--100); padding-top: 1rem;">
                                    <!-- Header row: document name + download + counter -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-weight: 600; font-size: 0.9em;" x-text="logEntryDetail.log_image_detail.name"></span>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span x-show="logEntryDetail.log_image_detail.images.length > 1"
                                                  style="font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                                <span x-text="logEntryImageIndex + 1"></span> / <span x-text="logEntryDetail.log_image_detail.images.length"></span>
                                            </span>
                                            <a :href="logEntryDetail.log_image_detail.images[logEntryImageIndex]?.image"
                                               class="pf-v5-c-button pf-m-plain pf-m-small" download target="_blank" title="Download">
                                                <i class="fas fa-download"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- Image display -->
                                    <div style="position: relative;">
                                        <!-- Prev button -->
                                        <button class="pf-v5-c-button pf-m-plain" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); z-index: 1;"
                                                x-show="logEntryDetail.log_image_detail.images.length > 1 && logEntryImageIndex > 0"
                                                @click="logEntryImageIndex--">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <!-- Image -->
                                        <template x-if="getFileType(logEntryDetail.log_image_detail.images[logEntryImageIndex]?.image) === 'image'">
                                            <img :src="logEntryDetail.log_image_detail.images[logEntryImageIndex]?.image"
                                                 :alt="logEntryDetail.log_image_detail.name"
                                                 style="max-width: 100%; display: block; margin: 0 auto; border-radius: 4px;">
                                        </template>
                                        <!-- PDF -->
                                        <template x-if="getFileType(logEntryDetail.log_image_detail.images[logEntryImageIndex]?.image) === 'pdf'">
                                            <iframe :src="logEntryDetail.log_image_detail.images[logEntryImageIndex]?.image"
                                                    style="width: 100%; height: 60vh; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 4px;"></iframe>
                                        </template>
                                        <!-- Other file types -->
                                        <template x-if="getFileType(logEntryDetail.log_image_detail.images[logEntryImageIndex]?.image) !== 'image' && getFileType(logEntryDetail.log_image_detail.images[logEntryImageIndex]?.image) !== 'pdf'">
                                            <div style="text-align: center; padding: 2rem;">
                                                <i :class="getFileIcon(logEntryDetail.log_image_detail.images[logEntryImageIndex]?.image)" style="font-size: 3rem; color: var(--pf-v5-global--Color--200); margin-bottom: 0.5rem;"></i>
                                                <p style="color: var(--pf-v5-global--Color--200);">Use the download button to open this file.</p>
                                            </div>
                                        </template>
                                        <!-- Next button -->
                                        <button class="pf-v5-c-button pf-m-plain" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 1;"
                                                x-show="logEntryDetail.log_image_detail.images.length > 1 && logEntryImageIndex < logEntryDetail.log_image_detail.images.length - 1"
                                                @click="logEntryImageIndex++">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <!-- Image notes -->
                                    <template x-if="logEntryDetail.log_image_detail.images[logEntryImageIndex]?.notes">
                                        <p style="font-size: 0.85em; color: var(--pf-v5-global--Color--200); margin-top: 0.5rem;"
                                           x-text="logEntryDetail.log_image_detail.images[logEntryImageIndex].notes"></p>
                                    </template>
                                </div>
                            </template>
                            <!-- Related documents inline -->
                            <template x-if="logEntryDetail.related_documents_detail && logEntryDetail.related_documents_detail.length > 0">
                                <div>
                                    <template x-for="rdoc in logEntryDetail.related_documents_detail" :key="rdoc.id">
                                        <div x-show="rdoc.images && rdoc.images.length > 0"
                                             style="margin-top: 1rem; border-top: 1px solid var(--pf-v5-global--BorderColor--100); padding-top: 1rem;">
                                            <!-- Header row: document name + download + counter -->
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                                <span style="font-weight: 600; font-size: 0.9em;" x-text="rdoc.name"></span>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span x-show="rdoc.images.length > 1"
                                                          style="font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                                        <span x-text="(relatedDocImageIndices[rdoc.id] || 0) + 1"></span> / <span x-text="rdoc.images.length"></span>
                                                    </span>
                                                    <a :href="rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.image"
                                                       class="pf-v5-c-button pf-m-plain pf-m-small" download target="_blank" title="Download">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                </div>
                                            </div>
                                            <!-- Image display -->
                                            <div style="position: relative;">
                                                <button class="pf-v5-c-button pf-m-plain" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); z-index: 1;"
                                                        x-show="rdoc.images.length > 1 && (relatedDocImageIndices[rdoc.id] || 0) > 0"
                                                        @click="relatedDocImageIndices[rdoc.id] = (relatedDocImageIndices[rdoc.id] || 0) - 1">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <div x-show="getFileType(rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.image) === 'image'">
                                                    <img :src="rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.image"
                                                         :alt="rdoc.name"
                                                         style="max-width: 100%; display: block; margin: 0 auto; border-radius: 4px;">
                                                </div>
                                                <div x-show="getFileType(rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.image) === 'pdf'">
                                                    <iframe :src="rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.image"
                                                            style="width: 100%; height: 60vh; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 4px;"></iframe>
                                                </div>
                                                <div x-show="getFileType(rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.image) !== 'image' && getFileType(rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.image) !== 'pdf'"
                                                     style="text-align: center; padding: 2rem;">
                                                    <i :class="getFileIcon(rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.image)" style="font-size: 3rem; color: var(--pf-v5-global--Color--200); margin-bottom: 0.5rem;"></i>
                                                    <p style="color: var(--pf-v5-global--Color--200);">Use the download button to open this file.</p>
                                                </div>
                                                <button class="pf-v5-c-button pf-m-plain" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 1;"
                                                        x-show="rdoc.images.length > 1 && (relatedDocImageIndices[rdoc.id] || 0) < rdoc.images.length - 1"
                                                        @click="relatedDocImageIndices[rdoc.id] = (relatedDocImageIndices[rdoc.id] || 0) + 1">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </div>
                                            <!-- Image notes -->
                                            <p x-show="rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.notes"
                                               x-text="rdoc.images[relatedDocImageIndices[rdoc.id] || 0]?.notes || ''"
                                               style="font-size: 0.85em; color: var(--pf-v5-global--Color--200); margin-top: 0.5rem;"></p>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </dl>
                    </template>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-link" type="button" @click="closeLogEntryDetail()">Close</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div class="pf-v5-c-backdrop" x-show="viewerOpen" x-cloak @click.self="closeDocumentViewer()" style="z-index: 1300;">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg document-viewer-modal" @click.stop>
                <div style="position: absolute; top: 1rem; right: 1rem; z-index: 10; display: flex; gap: 0.25rem;">
                    <template x-if="viewerDocument?.images && viewerDocument.images.length > 0">
                        <a :href="viewerDocument.images[viewerImageIndex]?.image" class="pf-v5-c-button pf-m-plain" download target="_blank" title="Download file">
                            <i class="fas fa-download"></i>
                        </a>
                    </template>
                    <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeDocumentViewer()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="viewerDocument?.name"></h1>
                    <div class="pf-v5-c-modal-box__description">
                        <span x-text="viewerCollectionName"></span>
                        <span class="pf-v5-c-label pf-m-blue pf-m-compact" style="margin-left: 0.5rem;" x-text="viewerDocument?.doc_type_display"></span>
                    </div>
                </header>

                <div class="pf-v5-c-modal-box__body document-viewer-body">
                    <template x-if="viewerDocument?.description">
                        <p style="margin-bottom: 1rem; color: var(--pf-v5-global--Color--200);" x-text="viewerDocument.description"></p>
                    </template>

                    <!-- File Navigation -->
                    <template x-if="viewerDocument?.images && viewerDocument.images.length > 0">
                        <div class="document-viewer-images">
                            <!-- File Counter -->
                            <div class="image-counter" x-show="viewerDocument.images.length > 1">
                                <span x-text="viewerImageIndex + 1"></span> / <span x-text="viewerDocument.images.length"></span>
                            </div>

                            <!-- Main Content Area -->
                            <div class="viewer-image-container">
                                <button class="nav-button nav-prev" @click="prevImage()" x-show="viewerDocument.images.length > 1 && viewerImageIndex > 0">
                                    <i class="fas fa-chevron-left"></i>
                                </button>

                                <!-- Image file -->
                                <template x-if="getFileType(viewerDocument.images[viewerImageIndex]?.image) === 'image'">
                                    <img :src="viewerDocument.images[viewerImageIndex]?.image" :alt="viewerDocument.name" class="viewer-image">
                                </template>

                                <!-- PDF file -->
                                <template x-if="getFileType(viewerDocument.images[viewerImageIndex]?.image) === 'pdf'">
                                    <iframe :src="viewerDocument.images[viewerImageIndex]?.image" style="width: 100%; height: 70vh; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 4px;"></iframe>
                                </template>

                                <!-- Text or other file -->
                                <template x-if="getFileType(viewerDocument.images[viewerImageIndex]?.image) !== 'image' && getFileType(viewerDocument.images[viewerImageIndex]?.image) !== 'pdf'">
                                    <div style="text-align: center; padding: 2rem;">
                                        <i :class="getFileIcon(viewerDocument.images[viewerImageIndex]?.image)" style="font-size: 4rem; color: var(--pf-v5-global--Color--200); margin-bottom: 1rem;"></i>
                                        <p style="color: var(--pf-v5-global--Color--200);">This file cannot be previewed. Use the download button above.</p>
                                    </div>
                                </template>

                                <button class="nav-button nav-next" @click="nextImage()" x-show="viewerDocument.images.length > 1 && viewerImageIndex < viewerDocument.images.length - 1">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>

                            <!-- File Notes -->
                            <template x-if="viewerDocument.images[viewerImageIndex]?.notes">
                                <p class="image-notes" x-text="viewerDocument.images[viewerImageIndex].notes"></p>
                            </template>

                            <!-- Thumbnail Strip -->
                            <div class="thumbnail-strip" x-show="viewerDocument.images.length > 1">
                                <template x-for="(img, idx) in viewerDocument.images" :key="img.id">
                                    <div class="thumbnail"
                                         :class="{ 'active': idx === viewerImageIndex }"
                                         @click="viewerImageIndex = idx">
                                        <template x-if="getFileType(img.image) === 'image'">
                                            <img :src="img.image" :alt="`Page ${idx + 1}`">
                                        </template>
                                        <template x-if="getFileType(img.image) !== 'image'">
                                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--pf-v5-global--BackgroundColor--200);">
                                                <i :class="getFileIcon(img.image)" style="font-size: 1.25rem; color: var(--pf-v5-global--Color--200);"></i>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template x-if="!viewerDocument?.images || viewerDocument.images.length === 0">
                        <div class="pf-v5-c-empty-state">
                            <div class="pf-v5-c-empty-state__content">
                                <i class="fas fa-file" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                                <h2 class="pf-v5-c-title pf-m-lg">No files</h2>
                                <div class="pf-v5-c-empty-state__body">
                                    This document has no attached files.
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Component Modal -->
    <div class="pf-v5-c-backdrop" x-show="componentModalOpen" x-cloak @click.self="closeComponentModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeComponentModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingComponent ? 'Edit Component' : 'Add Component'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitComponent" class="pf-v5-c-form">
                        <!-- Component Type -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="comp-type">
                                <span class="pf-v5-c-form__label-text">Component Type</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select id="comp-type" class="pf-v5-c-form-control" x-model="componentForm.component_type" required>
                                    <option value="">-- Select type --</option>
                                    <template x-for="ct in componentTypes" :key="ct.id">
                                        <option :value="ct.id" x-text="ct.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Parent Component -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="comp-parent">
                                <span class="pf-v5-c-form__label-text">Parent Component</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select id="comp-parent" class="pf-v5-c-form-control" x-model="componentForm.parent_component">
                                    <option value="">-- None (top-level) --</option>
                                    <template x-for="comp in getParentOptions(editingComponent?.id)" :key="comp.id">
                                        <option :value="comp.id" x-text="getComponentLabel(comp)"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Manufacturer / Model row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="comp-manufacturer">
                                    <span class="pf-v5-c-form__label-text">Manufacturer</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="comp-manufacturer" class="pf-v5-c-form-control" type="text" x-model="componentForm.manufacturer" required>
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="comp-model">
                                    <span class="pf-v5-c-form__label-text">Model</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="comp-model" class="pf-v5-c-form-control" type="text" x-model="componentForm.model" required>
                                </div>
                            </div>
                        </div>

                        <!-- Serial Number / Install Location row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="comp-serial">
                                    <span class="pf-v5-c-form__label-text">Serial Number</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="comp-serial" class="pf-v5-c-form-control" type="text" x-model="componentForm.serial_number">
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="comp-location">
                                    <span class="pf-v5-c-form__label-text">Install Location</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="comp-location" class="pf-v5-c-form-control" type="text" x-model="componentForm.install_location">
                                </div>
                            </div>
                        </div>

                        <!-- Status / Date In Service row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="comp-status">
                                    <span class="pf-v5-c-form__label-text">Status</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <select id="comp-status" class="pf-v5-c-form-control" x-model="componentForm.status" required>
                                        <option value="IN-USE">In Service</option>
                                        <option value="SPARE">Spare Part</option>
                                        <option value="DISPOSED">Disposed</option>
                                    </select>
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="comp-date-in-service">
                                    <span class="pf-v5-c-form__label-text">Date In Service</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="comp-date-in-service" class="pf-v5-c-form-control" type="date" x-model="componentForm.date_in_service" required>
                                </div>
                            </div>
                        </div>

                        <!-- Hours row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="comp-hours-in-service">
                                    <span class="pf-v5-c-form__label-text">Hours In Service</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="comp-hours-in-service" class="pf-v5-c-form-control" type="number" step="0.1" min="0" x-model="componentForm.hours_in_service">
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="comp-hours-since-overhaul">
                                    <span class="pf-v5-c-form__label-text">Hours Since Overhaul</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="comp-hours-since-overhaul" class="pf-v5-c-form-control" type="number" step="0.1" min="0" x-model="componentForm.hours_since_overhaul">
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="comp-overhaul-date">
                                    <span class="pf-v5-c-form__label-text">Overhaul Date</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input id="comp-overhaul-date" class="pf-v5-c-form-control" type="date" x-model="componentForm.overhaul_date">
                                </div>
                            </div>
                        </div>

                        <!-- Tracking Flags -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Tracking</span>
                            </label>
                            <div class="pf-v5-c-form__group-control" style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" x-model="componentForm.tbo_critical"> TBO Tracking
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" x-model="componentForm.inspection_critical"> Inspection Tracking
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" x-model="componentForm.replacement_critical"> Service Interval Tracking
                                </label>
                            </div>
                        </div>

                        <!-- TBO Intervals + On-Condition (shown when tbo_critical) -->
                        <template x-if="componentForm.tbo_critical">
                            <div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="pf-v5-c-form__group">
                                        <label class="pf-v5-c-form__label" for="comp-tbo-hours">
                                            <span class="pf-v5-c-form__label-text">TBO Hours</span>
                                        </label>
                                        <div class="pf-v5-c-form__group-control">
                                            <input id="comp-tbo-hours" class="pf-v5-c-form-control" type="number" min="0" x-model="componentForm.tbo_hours">
                                        </div>
                                    </div>
                                    <div class="pf-v5-c-form__group">
                                        <label class="pf-v5-c-form__label" for="comp-tbo-days">
                                            <span class="pf-v5-c-form__label-text">TBO Days</span>
                                        </label>
                                        <div class="pf-v5-c-form__group-control">
                                            <input id="comp-tbo-days" class="pf-v5-c-form-control" type="number" min="0" x-model="componentForm.tbo_days">
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 0.75rem;">
                                    <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" x-model="componentForm.on_condition" style="margin-top: 0.2rem; flex-shrink: 0;">
                                        <span>
                                            <span style="font-weight: 500;">Maintained On-Condition</span>
                                            <span style="display: block; font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                                Enables RCM/on-condition maintenance mode. Over-TBO hours are shown in blue/green rather than red/orange.
                                            </span>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </template>

                        <!-- Inspection Intervals (shown when inspection_critical) -->
                        <template x-if="componentForm.inspection_critical">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="comp-inspection-hours">
                                        <span class="pf-v5-c-form__label-text">Inspection Hours</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input id="comp-inspection-hours" class="pf-v5-c-form-control" type="number" min="0" x-model="componentForm.inspection_hours">
                                    </div>
                                </div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="comp-inspection-days">
                                        <span class="pf-v5-c-form__label-text">Inspection Days</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input id="comp-inspection-days" class="pf-v5-c-form-control" type="number" min="0" x-model="componentForm.inspection_days">
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Replacement Intervals (shown when replacement_critical) -->
                        <template x-if="componentForm.replacement_critical">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="comp-replacement-hours">
                                        <span class="pf-v5-c-form__label-text">Service Interval Hours</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input id="comp-replacement-hours" class="pf-v5-c-form-control" type="number" min="0" x-model="componentForm.replacement_hours">
                                    </div>
                                </div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="comp-replacement-days">
                                        <span class="pf-v5-c-form__label-text">Service Interval Days</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input id="comp-replacement-days" class="pf-v5-c-form-control" type="number" min="0" x-model="componentForm.replacement_days">
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Notes -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="comp-notes">
                                <span class="pf-v5-c-form__label-text">Notes</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="comp-notes" class="pf-v5-c-form-control" rows="2" x-model="componentForm.notes" placeholder="Additional notes..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitComponent" :disabled="componentSubmitting">
                        <span x-show="!componentSubmitting" x-text="editingComponent ? 'Save Changes' : 'Add Component'"></span>
                        <span x-show="componentSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeComponentModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Service Reset Modal -->
    <div class="pf-v5-c-backdrop" x-show="serviceResetModalOpen" x-cloak @click.self="closeServiceResetModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-sm" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeServiceResetModal()" style="position: absolute; top: 1rem; right: 1rem;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Reset Service Time</h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <template x-if="serviceResetComponent">
                        <div>
                            <p style="margin-bottom: 1.25rem;">
                                <strong x-text="getComponentLabel(serviceResetComponent)"></strong>
                                &mdash;
                                <span x-text="formatHours(serviceResetComponent.hours_since_overhaul || 0)"></span> since last OH/SVC
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <div style="padding: 0.75rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: var(--pf-v5-global--BorderRadius--sm);">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Service in place</div>
                                    <div style="color: var(--pf-v5-global--Color--200); font-size: 0.875rem;">
                                        Resets OH/SVC hours only. Use when the component is inspected, adjusted, or cleaned without being replaced.
                                    </div>
                                </div>
                                <div style="padding: 0.75rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: var(--pf-v5-global--BorderRadius--sm);">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Replace</div>
                                    <div style="color: var(--pf-v5-global--Color--200); font-size: 0.875rem;">
                                        Resets OH/SVC hours <em>and</em> total time in service. Use when a new unit is installed (e.g. oil change, new filter).
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="confirmServiceReset(false)" :disabled="serviceResetSubmitting">
                        <template x-if="serviceResetSubmitting">
                            <span class="pf-v5-c-spinner pf-m-sm" role="progressbar">
                                <span class="pf-v5-c-spinner__clipper"></span>
                            </span>
                        </template>
                        Service in place
                    </button>
                    <button class="pf-v5-c-button pf-m-secondary" @click="confirmServiceReset(true)" :disabled="serviceResetSubmitting">Replace</button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeServiceResetModal()" :disabled="serviceResetSubmitting">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Squawk Modal -->
    <div class="pf-v5-c-backdrop" x-show="squawkModalOpen" x-cloak @click.self="closeSquawkModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeSquawkModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingSquawk ? 'Edit Squawk' : 'New Squawk'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitSquawk" class="pf-v5-c-form">
                        <!-- Priority -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="squawk-priority">
                                <span class="pf-v5-c-form__label-text">Priority</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select id="squawk-priority" class="pf-v5-c-form-control" x-model="squawkForm.priority" required>
                                    <option value="0">Ground Aircraft</option>
                                    <option value="1">Fix Soon</option>
                                    <option value="2">Fix at Next Inspection</option>
                                    <option value="3">Fix Eventually</option>
                                </select>
                            </div>
                        </div>

                        <!-- Component (Optional) -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="squawk-component">
                                <span class="pf-v5-c-form__label-text">Component (Optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select id="squawk-component" class="pf-v5-c-form-control" x-model="squawkForm.component">
                                    <option value="">-- No specific component --</option>
                                    <template x-for="comp in components" :key="comp.id">
                                        <option :value="comp.id" x-text="getComponentTypeName(comp) + (comp.install_location ? ' (' + comp.install_location + ')' : '')"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Issue Reported -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="squawk-issue">
                                <span class="pf-v5-c-form__label-text">Issue Description</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="squawk-issue" class="pf-v5-c-form-control" rows="3" x-model="squawkForm.issue_reported" required placeholder="Describe the issue..."></textarea>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="squawk-notes">
                                <span class="pf-v5-c-form__label-text">Notes (Optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="squawk-notes" class="pf-v5-c-form-control" rows="2" x-model="squawkForm.notes" placeholder="Additional notes..."></textarea>
                            </div>
                        </div>

                        <!-- Grounding Warning -->
                        <template x-if="squawkForm.priority === '0' || squawkForm.priority === 0">
                            <div class="pf-v5-c-alert pf-m-warning pf-m-inline" role="alert">
                                <div class="pf-v5-c-alert__icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="pf-v5-c-alert__description">
                                    This squawk will ground the aircraft until resolved.
                                </div>
                            </div>
                        </template>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitSquawk" :disabled="squawkSubmitting">
                        <span x-show="!squawkSubmitting" x-text="editingSquawk ? 'Save Changes' : 'Create Squawk'"></span>
                        <span x-show="squawkSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeSquawkModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="pf-v5-c-backdrop" x-show="noteModalOpen" x-cloak @click.self="closeNoteModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeNoteModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="isPublicView ? 'Note' : (editingNote ? 'Edit Note' : 'Add Note')"></h1>
                </header>

                <!-- View-only body for public view -->
                <div class="pf-v5-c-modal-box__body" x-show="isPublicView">
                    <p style="white-space: pre-wrap;" x-text="noteForm.text"></p>
                    <template x-if="editingNote">
                        <div class="note-meta" style="margin-top: 1rem; color: var(--pf-v5-global--Color--200); font-size: 0.875rem;">
                            <span x-text="formatDate(editingNote.added_timestamp)"></span>
                            <template x-if="editingNote.added_by_username">
                                <span> - <span x-text="editingNote.added_by_username"></span></span>
                            </template>
                            <template x-if="editingNote.edited_timestamp">
                                <span class="note-edited">(edited)</span>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- Editable body for authenticated view -->
                <div class="pf-v5-c-modal-box__body" x-show="!isPublicView">
                    <form @submit.prevent="submitNote" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="note-text">
                                <span class="pf-v5-c-form__label-text">Note</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="note-text" class="pf-v5-c-form-control" rows="5" x-model="noteForm.text" required placeholder="Enter your note..."></textarea>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group" style="margin-top: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" x-model="noteForm.public">
                                <span>Share this note publicly (visible on share links)</span>
                            </label>
                        </div>
                    </form>
                </div>

                <!-- Public view footer -->
                <footer class="pf-v5-c-modal-box__footer" x-show="isPublicView">
                    <button class="pf-v5-c-button pf-m-link" @click="closeNoteModal()">Close</button>
                </footer>

                <!-- Authenticated view footer -->
                <footer class="pf-v5-c-modal-box__footer" x-show="!isPublicView">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitNote" :disabled="noteSubmitting">
                        <span x-show="!noteSubmitting" x-text="editingNote ? 'Save Changes' : 'Add Note'"></span>
                        <span x-show="noteSubmitting">Saving...</span>
                    </button>
                    <template x-if="editingNote">
                        <button class="pf-v5-c-button pf-m-danger" @click="deleteNote" :disabled="noteSubmitting">
                            Delete
                        </button>
                    </template>
                    <button class="pf-v5-c-button pf-m-link" @click="closeNoteModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- All Notes Modal -->
    <div class="pf-v5-c-backdrop" x-show="showAllNotes" x-cloak @click.self="showAllNotes = false">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="showAllNotes = false" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">All Notes</h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <div class="notes-list notes-list-full">
                        <template x-for="note in aircraftNotes" :key="note.id">
                            <div class="note-item" @click="isPublicView ? (viewNote(note), showAllNotes = false) : (editNote(note), showAllNotes = false)">
                                <p class="note-text" x-text="note.text"></p>
                                <div class="note-meta">
                                    <span x-text="formatDate(note.added_timestamp)"></span>
                                    <template x-if="note.added_by_username">
                                        <span> - <span x-text="note.added_by_username"></span></span>
                                    </template>
                                    <template x-if="note.edited_timestamp">
                                        <span class="note-edited">(edited)</span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" x-show="canCreateNote" @click="openNoteModal(); showAllNotes = false;">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="showAllNotes = false">Close</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Oil Record Modal -->
    <div class="pf-v5-c-backdrop" x-show="oilModalOpen" x-cloak @click.self="closeOilModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeOilModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingOilRecord ? 'Edit Oil Record' : 'Add Oil Record'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitOilRecord" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-date">
                                <span class="pf-v5-c-form__label-text">Date</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="date" id="oil-date" class="pf-v5-c-form-control" x-model="oilForm.date" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-quantity">
                                <span class="pf-v5-c-form__label-text">Quantity Added (quarts)</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.25" min="0" id="oil-quantity" class="pf-v5-c-form-control" x-model="oilForm.quantity_added" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-level">
                                <span class="pf-v5-c-form__label-text">Level After (quarts, optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.25" min="0" id="oil-level" class="pf-v5-c-form-control" x-model="oilForm.level_after">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-hours">
                                <span class="pf-v5-c-form__label-text">Aircraft Hours</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="oil-hours" class="pf-v5-c-form-control" x-model="oilForm.flight_hours" :placeholder="formatHours(aircraft?.flight_time)">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-type">
                                <span class="pf-v5-c-form__label-text">Oil Type (optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="text" id="oil-type" class="pf-v5-c-form-control" x-model="oilForm.consumable_type" placeholder="e.g. Aeroshell W100">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-notes">
                                <span class="pf-v5-c-form__label-text">Notes (optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="oil-notes" class="pf-v5-c-form-control" rows="2" x-model="oilForm.notes"></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitOilRecord" :disabled="oilSubmitting">
                        <span x-show="!oilSubmitting" x-text="editingOilRecord ? 'Save Changes' : 'Add Record'"></span>
                        <span x-show="oilSubmitting">Saving...</span>
                    </button>
                    <template x-if="editingOilRecord">
                        <button class="pf-v5-c-button pf-m-danger" @click="deleteOilRecord" :disabled="oilSubmitting">Delete</button>
                    </template>
                    <button class="pf-v5-c-button pf-m-link" @click="closeOilModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Add Bulletin Modal -->
    <div class="pf-v5-c-backdrop" x-show="adModalOpen" x-cloak @click.self="closeAdModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeAdModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingAd ? 'Edit Bulletin' : 'Add Bulletin'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <!-- Add existing bulletin - only show when creating new -->
                    <div style="margin-bottom: 1.5rem;" x-show="!editingAd">
                        <h3 style="margin-bottom: 0.75rem;">Add Existing Bulletin</h3>

                        <!-- Selected bulletin chip -->
                        <template x-if="selectedExistingAd">
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px; margin-bottom: 0.5rem; background: var(--pf-v5-global--BackgroundColor--200);">
                                <span class="pf-v5-c-label" :class="getBulletinTypeClass(selectedExistingAd.bulletin_type)" x-text="getBulletinTypeLabel(selectedExistingAd.bulletin_type)" style="flex-shrink: 0;"></span>
                                <span style="font-weight: 600;" x-text="selectedExistingAd.name"></span>
                                <span style="color: var(--pf-v5-global--Color--200); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="'— ' + selectedExistingAd.short_description"></span>
                                <button class="pf-v5-c-button pf-m-plain" @click="selectedExistingAdId = ''; adSearchQuery = ''" title="Clear selection" style="margin-left: auto; flex-shrink: 0;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </template>

                        <!-- Search input (shown when nothing is selected) -->
                        <template x-if="!selectedExistingAd">
                            <div>
                                <div style="position: relative; margin-bottom: 0.4rem;">
                                    <i class="fas fa-search" style="position: absolute; left: 0.65rem; top: 50%; transform: translateY(-50%); color: var(--pf-v5-global--Color--200); pointer-events: none;"></i>
                                    <input class="pf-v5-c-form-control" type="search"
                                           x-model="adSearchQuery"
                                           placeholder="Search by name, number, type, or description..."
                                           style="padding-left: 2rem;">
                                </div>
                                <template x-if="allAdsLoading">
                                    <div style="padding: 0.75rem 1rem; color: var(--pf-v5-global--Color--200); display: flex; align-items: center; gap: 0.5rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px;">
                                        <div class="loading-spinner" style="width: 1rem; height: 1rem; flex-shrink: 0;"></div>
                                        Loading bulletins...
                                    </div>
                                </template>
                                <template x-if="!allAdsLoading">
                                    <div style="border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px; max-height: 220px; overflow-y: auto;">
                                        <template x-if="availableAds.length === 0">
                                            <div style="padding: 0.75rem 1rem; color: var(--pf-v5-global--Color--200); font-style: italic;">
                                                All known bulletins are already applied to this aircraft.
                                            </div>
                                        </template>
                                        <template x-if="availableAds.length > 0 && filteredAvailableAds.length === 0">
                                            <div style="padding: 0.75rem 1rem; color: var(--pf-v5-global--Color--200); font-style: italic;">
                                                No bulletins match your search.
                                            </div>
                                        </template>
                                        <template x-for="ad in filteredAvailableAds" :key="ad.id">
                                            <div class="bulletin-search-result"
                                                 @click="selectedExistingAdId = ad.id"
                                                 style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid var(--pf-v5-global--BorderColor--100);">
                                                <span class="pf-v5-c-label" :class="getBulletinTypeClass(ad.bulletin_type)" x-text="getBulletinTypeLabel(ad.bulletin_type)" style="flex-shrink: 0;"></span>
                                                <div style="min-width: 0;">
                                                    <div style="font-weight: 600;" x-text="ad.name"></div>
                                                    <div style="font-size: 0.85em; color: var(--pf-v5-global--Color--200); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" x-text="ad.short_description"></div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <div style="margin-top: 0.6rem;">
                            <button class="pf-v5-c-button pf-m-primary" @click="addExistingAd()" :disabled="!selectedExistingAdId || adSubmitting"
                                    x-text="adSubmitting ? 'Adding...' : 'Add to Aircraft'">
                            </button>
                        </div>
                    </div>

                    <hr style="margin: 1rem 0; border-color: var(--pf-v5-global--BorderColor--100);" x-show="!editingAd">

                    <!-- Create new bulletin -->
                    <h3 style="margin-bottom: 0.5rem;" x-text="editingAd ? 'Edit Bulletin Details' : 'Or Create New Bulletin'"></h3>
                    <form @submit.prevent="createAndAddAd" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="ad-bulletin-type">
                                <span class="pf-v5-c-form__label-text">Bulletin Type</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select id="ad-bulletin-type" class="pf-v5-c-form-control" x-model="adForm.bulletin_type"
                                        @change="if (!editingAd) { adForm.mandatory = (adForm.bulletin_type === 'ad'); }">
                                    <option value="ad">Airworthiness Directive (AD)</option>
                                    <option value="saib">Special Airworthiness Information Bulletin (SAIB)</option>
                                    <option value="sb">Service Bulletin (SB)</option>
                                    <option value="alert">Airworthiness Alert</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-control">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" x-model="adForm.mandatory"> Mandatory (affects airworthiness status)
                                </label>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="ad-name">
                                <span class="pf-v5-c-form__label-text">Name / Number</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input id="ad-name" class="pf-v5-c-form-control" type="text" x-model="adForm.name" placeholder="e.g. AD 2024-01-05 or SB-300-27-01">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="ad-description">
                                <span class="pf-v5-c-form__label-text">Short Description</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input id="ad-description" class="pf-v5-c-form-control" type="text" x-model="adForm.short_description">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="ad-action">
                                <span class="pf-v5-c-form__label-text">Required Action</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="ad-action" class="pf-v5-c-form-control" rows="2" x-model="adForm.required_action"></textarea>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="ad-compliance-type">
                                <span class="pf-v5-c-form__label-text">Compliance Type</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select id="ad-compliance-type" class="pf-v5-c-form-control" x-model="adForm.compliance_type">
                                    <option value="standard">Standard</option>
                                    <option value="conditional">Conditional (trigger-based)</option>
                                </select>
                            </div>
                        </div>
                        <template x-if="adForm.compliance_type === 'conditional'">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="ad-trigger-condition">
                                    <span class="pf-v5-c-form__label-text">Trigger Condition</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <textarea id="ad-trigger-condition" class="pf-v5-c-form-control" rows="2" x-model="adForm.trigger_condition" placeholder="e.g. Upon crankshaft removal from engine"></textarea>
                                </div>
                            </div>
                        </template>
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-control">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" x-model="adForm.recurring"> Recurring
                                </label>
                            </div>
                        </div>
                        <template x-if="adForm.recurring">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="ad-recurring-hours">
                                        <span class="pf-v5-c-form__label-text">Hours</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input id="ad-recurring-hours" class="pf-v5-c-form-control" type="number" step="0.1" min="0" x-model="adForm.recurring_hours">
                                    </div>
                                </div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="ad-recurring-months">
                                        <span class="pf-v5-c-form__label-text">Months</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input id="ad-recurring-months" class="pf-v5-c-form-control" type="number" min="0" x-model="adForm.recurring_months">
                                    </div>
                                </div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="ad-recurring-days">
                                        <span class="pf-v5-c-form__label-text">Days</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input id="ad-recurring-days" class="pf-v5-c-form-control" type="number" min="0" x-model="adForm.recurring_days">
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Bulletin Document -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label">
                                    <span class="pf-v5-c-form__label-text">Bulletin Document</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <!-- Selected document chip -->
                                <template x-if="adDocPickerSelected">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                        <span class="pf-v5-c-label pf-m-blue">
                                            <span class="pf-v5-c-label__content">
                                                <i class="fas fa-file-alt pf-v5-u-mr-xs"></i>
                                                <span x-text="adDocPickerSelected.name"></span>
                                            </span>
                                        </span>
                                        <button type="button" class="pf-v5-c-button pf-m-link"
                                                style="color: var(--pf-v5-global--danger-color--100);"
                                                @click="adDocPickerClear()">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    </div>
                                </template>

                                <!-- Search input (shown when no doc selected) -->
                                <template x-if="!adDocPickerSelected">
                                    <div style="position: relative;">
                                        <input type="text"
                                               class="pf-v5-c-form-control"
                                               placeholder="Search documents by name…"
                                               x-model="adDocPickerQuery"
                                               @input="adDocPickerInput()"
                                               @keydown.escape="adDocPickerDropdownOpen = false">

                                        <!-- Inline dropdown -->
                                        <div x-show="adDocPickerDropdownOpen"
                                             style="position: absolute; z-index: 10; width: 100%; background: white;
                                                    border: 1px solid #d2d2d2; border-radius: 4px; max-height: 240px;
                                                    overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,.12);">
                                            <div x-show="adDocPickerLoading" class="pf-v5-u-p-sm pf-v5-u-color-200">
                                                Searching…
                                            </div>
                                            <div x-show="!adDocPickerLoading && adDocPickerResults.length === 0"
                                                 class="pf-v5-u-p-sm pf-v5-u-color-200">
                                                No documents found
                                            </div>
                                            <template x-for="doc in adDocPickerResults" :key="doc.id">
                                                <div class="pf-v5-u-p-sm"
                                                     style="cursor: pointer; border-bottom: 1px solid #f0f0f0;"
                                                     @click="adDocPickerSelect(doc)"
                                                     @mouseenter="$el.style.background='#f5f5f5'"
                                                     @mouseleave="$el.style.background=''">
                                                    <div style="font-weight: 600;" x-text="doc.name"></div>
                                                    <div class="pf-v5-u-font-size-sm pf-v5-u-color-200"
                                                         x-text="doc.doc_type_display"></div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <p class="pf-v5-u-mt-xs" style="font-size: 0.875rem; color: var(--pf-v5-global--Color--200);">
                                    Link an existing document from this aircraft's library.
                                </p>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary"
                            @click="editingAd ? updateAd() : createAndAddAd()"
                            :disabled="adSubmitting || !adForm.name || !adForm.short_description"
                            x-text="editingAd ? (adSubmitting ? 'Updating...' : 'Update Bulletin') : (adSubmitting ? 'Creating...' : 'Create and Add to Aircraft')">
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeAdModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Record Compliance Modal -->
    <div class="pf-v5-c-backdrop" x-show="complianceModalOpen" x-cloak @click.self="closeComplianceModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeComplianceModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingComplianceRecord ? 'Edit Compliance Record' : 'Record Bulletin Compliance'"></h1>
                    <template x-if="selectedAd">
                        <div class="pf-v5-c-modal-box__description" x-text="selectedAd.name + ' — ' + selectedAd.short_description"></div>
                    </template>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitCompliance" class="pf-v5-c-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="compliance-date">
                                    <span class="pf-v5-c-form__label-text">Date Complied</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input type="date" id="compliance-date" class="pf-v5-c-form-control" x-model="complianceForm.date_complied" required>
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="compliance-aircraft-hours">
                                    <span class="pf-v5-c-form__label-text">Aircraft Hours</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input type="number" step="0.1" min="0" id="compliance-aircraft-hours" class="pf-v5-c-form-control" x-model="complianceForm.aircraft_hours" placeholder="e.g. 1234.5">
                                </div>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="compliance-notes">
                                <span class="pf-v5-c-form__label-text">Compliance Notes</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="compliance-notes" class="pf-v5-c-form-control" rows="3" x-model="complianceForm.compliance_notes" required placeholder="Describe compliance action taken..."></textarea>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-control">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" x-model="complianceForm.permanent"> Permanent (one-time compliance, no recurrence)
                                </label>
                            </div>
                        </div>
                        <template x-if="!complianceForm.permanent">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="compliance-next-due">
                                    <span class="pf-v5-c-form__label-text">Next Due At (aircraft hours)</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input type="number" step="0.1" min="0" id="compliance-next-due" class="pf-v5-c-form-control" x-model="complianceForm.next_due_at_time" :placeholder="'Current: ' + formatHours(aircraft?.flight_time)">
                                </div>
                            </div>
                        </template>

                        <!-- Logbook Entry -->
                        <div class="pf-v5-c-form__group" style="border-top: 1px solid var(--pf-v5-global--BorderColor--100); padding-top: 1rem; margin-top: 0.5rem;">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Logbook Entry</span>
                            </label>
                            <p style="font-size: 0.85em; color: var(--pf-v5-global--Color--200); margin: 0 0 0.5rem;" x-show="!pickerSelectedEntry && !editingComplianceRecord">
                                Selecting an entry will pre-fill the date, hours, and notes above.
                            </p>
                            <div class="pf-v5-c-form__group-control">
                                <!-- Selected entry chip -->
                                <template x-if="pickerSelectedEntry">
                                    <div style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px; background: var(--pf-v5-global--BackgroundColor--100);">
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                                <span style="font-weight: 500;" x-text="formatDate(pickerSelectedEntry.date)"></span>
                                                <span x-show="pickerSelectedEntry.aircraft_hours_at_entry" style="color: var(--pf-v5-global--Color--200);" x-text="'· ' + formatHours(pickerSelectedEntry.aircraft_hours_at_entry)"></span>
                                                <span class="pf-v5-c-label pf-m-compact pf-m-blue" x-show="pickerSelectedEntry.entry_type"><span class="pf-v5-c-label__content" x-text="pickerSelectedEntry.entry_type"></span></span>
                                            </div>
                                            <div style="margin-top: 0.25rem; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="(pickerSelectedEntry.text || '').substring(0, 80)"></div>
                                            <div x-show="pickerSelectedEntry.signoff_person" style="margin-top: 0.125rem; font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                                <i class="fas fa-user"></i> <span x-text="pickerSelectedEntry.signoff_person"></span>
                                            </div>
                                        </div>
                                        <button class="pf-v5-c-button pf-m-plain" type="button" @click="pickerClear()" title="Clear selection"><i class="fas fa-times"></i></button>
                                    </div>
                                </template>
                                <!-- Search row (shown when no entry selected) -->
                                <template x-if="!pickerSelectedEntry">
                                    <div>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="text" class="pf-v5-c-form-control" placeholder="Search by date, text, mechanic..." x-model="pickerSearchQuery" @input="pickerOnInput()" @focus="pickerSearchQuery.trim() && pickerDoSearch()" @keydown.escape="pickerDropdownOpen = false; pickerSearchQuery = ''" style="flex: 1;">
                                            <button class="pf-v5-c-button pf-m-secondary" type="button" @click="pickerOpenBrowse()">Browse</button>
                                        </div>
                                        <!-- Inline results -->
                                        <div x-show="pickerDropdownOpen" style="border: 1px solid var(--pf-v5-global--BorderColor--100); border-top: 0; border-radius: 0 0 3px 3px; background: var(--pf-v5-global--BackgroundColor--100); max-height: 200px; overflow-y: auto; margin-top: -1px;">
                                            <div x-show="pickerSearchLoading" style="padding: 0.75rem; text-align: center; color: var(--pf-v5-global--Color--200);"><i class="fas fa-spinner fa-spin"></i> Searching...</div>
                                            <div x-show="!pickerSearchLoading && pickerSearchResults.length === 0" style="padding: 0.75rem; color: var(--pf-v5-global--Color--200);">No entries found</div>
                                            <template x-for="entry in pickerSearchResults" :key="entry.id">
                                                <div class="logbook-picker-result" @click="pickerSelectEntry(entry)" style="padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid var(--pf-v5-global--BorderColor--200);">
                                                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                                        <span style="font-weight: 500;" x-text="formatDate(entry.date)"></span>
                                                        <span x-show="entry.aircraft_hours_at_entry" style="color: var(--pf-v5-global--Color--200); font-size: 0.9em;" x-text="'· ' + formatHours(entry.aircraft_hours_at_entry)"></span>
                                                        <span class="pf-v5-c-label pf-m-compact pf-m-blue" x-show="entry.entry_type"><span class="pf-v5-c-label__content" x-text="entry.entry_type"></span></span>
                                                    </div>
                                                    <div style="font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="(entry.text || '').substring(0, 80)"></div>
                                                    <div x-show="entry.signoff_person" style="font-size: 0.85em; color: var(--pf-v5-global--Color--200);"><i class="fas fa-user"></i> <span x-text="entry.signoff_person"></span></div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitCompliance" :disabled="complianceSubmitting">
                        <span x-show="!complianceSubmitting" x-text="editingComplianceRecord ? 'Save Changes' : 'Record Compliance'"></span>
                        <span x-show="complianceSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeComplianceModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Inspection History Modal -->
    <div class="pf-v5-c-backdrop" x-show="inspectionHistoryOpen" x-cloak @click.self="closeInspectionHistory()" style="z-index: 1000;">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeInspectionHistory()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">
                        <template x-if="selectedInspectionType">
                            <span x-text="selectedInspectionType.name + ' — History'"></span>
                        </template>
                    </h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <!-- Loading -->
                    <div x-show="inspectionHistoryLoading" style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner" style="width: 2rem; height: 2rem; margin: 0 auto;"></div>
                        <p style="margin-top: 0.5rem; color: var(--pf-v5-global--Color--200);">Loading history...</p>
                    </div>

                    <!-- Empty -->
                    <template x-if="!inspectionHistoryLoading && inspectionHistory.length === 0">
                        <div class="pf-v5-c-empty-state">
                            <div class="pf-v5-c-empty-state__content">
                                <i class="fas fa-clipboard" style="font-size: 2.5rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                                <h2 class="pf-v5-c-title pf-m-md">No inspection records</h2>
                                <div class="pf-v5-c-empty-state__body">
                                    No records have been logged for this inspection type yet.
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Records table -->
                    <template x-if="!inspectionHistoryLoading && inspectionHistory.length > 0">
                        <table class="pf-v5-c-table inspection-history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Aircraft Hours</th>
                                    <th>Logbook Entry</th>
                                    <th x-show="isOwner"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="record in inspectionHistory" :key="record.id">
                                    <tr>
                                        <td data-label="Date" x-text="formatDate(record.date)"></td>
                                        <td data-label="Aircraft Hours">
                                            <template x-if="record.aircraft_hours != null">
                                                <span><span class="consumable-field-label">Hours: </span><span x-text="formatHours(record.aircraft_hours)"></span></span>
                                            </template>
                                        </td>
                                        <td data-label="Logbook Entry">
                                            <template x-if="record.logbook_entry">
                                                <button class="pf-v5-c-button pf-m-link pf-m-inline"
                                                        @click="viewLogEntryFromCompliance(record.logbook_entry)">
                                                    <i class="fas fa-book-open"></i> View
                                                </button>
                                            </template>
                                        </td>
                                        <td data-label="Actions" x-show="isOwner">
                                            <div style="display: flex; gap: 0.25rem;">
                                                <button class="pf-v5-c-button pf-m-plain"
                                                        @click="editInspectionRecord(record)"
                                                        title="Edit Record">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="pf-v5-c-button pf-m-plain pf-m-danger"
                                                        @click="deleteInspectionRecord(record)"
                                                        title="Delete Record">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </template>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" x-show="isOwner" @click="openInspectionModal(selectedInspectionType)">
                        <i class="fas fa-plus"></i> Record Inspection
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeInspectionHistory()">Close</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Record Inspection Modal -->
    <div class="pf-v5-c-backdrop" x-show="inspectionModalOpen" x-cloak @click.self="closeInspectionModal()" style="z-index: 1100;">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeInspectionModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">
                        <template x-if="editingInspectionRecord">Edit Inspection Record</template>
                        <template x-if="!editingInspectionRecord">
                            <span>
                                Record Inspection
                                <template x-if="selectedInspectionType">
                                    <span>— <span x-text="selectedInspectionType.name"></span></span>
                                </template>
                            </span>
                        </template>
                    </h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitInspection" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="inspection-date">
                                <span class="pf-v5-c-form__label-text">Date Completed</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="date" id="inspection-date" class="pf-v5-c-form-control" x-model="inspectionForm.date" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="inspection-aircraft-hours">
                                <span class="pf-v5-c-form__label-text">Aircraft Hours</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="inspection-aircraft-hours" class="pf-v5-c-form-control"
                                       x-model="inspectionForm.aircraft_hours"
                                       :placeholder="formatHours(aircraft?.flight_time)">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Logbook Entry (optional)</span>
                            </label>
                            <p style="font-size: 0.85em; color: var(--pf-v5-global--Color--200); margin: 0 0 0.5rem;" x-show="!pickerSelectedEntry && !editingInspectionRecord">
                                Selecting an entry will pre-fill the date and hours above.
                            </p>
                            <div class="pf-v5-c-form__group-control">
                                <!-- Selected entry chip -->
                                <template x-if="pickerSelectedEntry">
                                    <div style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px; background: var(--pf-v5-global--BackgroundColor--100);">
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                                <span style="font-weight: 500;" x-text="formatDate(pickerSelectedEntry.date)"></span>
                                                <span x-show="pickerSelectedEntry.aircraft_hours_at_entry" style="color: var(--pf-v5-global--Color--200);" x-text="'· ' + formatHours(pickerSelectedEntry.aircraft_hours_at_entry)"></span>
                                                <span class="pf-v5-c-label pf-m-compact pf-m-blue" x-show="pickerSelectedEntry.entry_type"><span class="pf-v5-c-label__content" x-text="pickerSelectedEntry.entry_type"></span></span>
                                            </div>
                                            <div style="margin-top: 0.25rem; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="(pickerSelectedEntry.text || '').substring(0, 80)"></div>
                                            <div x-show="pickerSelectedEntry.signoff_person" style="margin-top: 0.125rem; font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                                <i class="fas fa-user"></i> <span x-text="pickerSelectedEntry.signoff_person"></span>
                                            </div>
                                        </div>
                                        <button class="pf-v5-c-button pf-m-plain" type="button" @click="pickerClear()" title="Clear selection"><i class="fas fa-times"></i></button>
                                    </div>
                                </template>
                                <!-- Search row (shown when no entry selected) -->
                                <template x-if="!pickerSelectedEntry">
                                    <div>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="text" class="pf-v5-c-form-control" placeholder="Search by date, text, mechanic..." x-model="pickerSearchQuery" @input="pickerOnInput()" @focus="pickerSearchQuery.trim() && pickerDoSearch()" @keydown.escape="pickerDropdownOpen = false; pickerSearchQuery = ''" style="flex: 1;">
                                            <button class="pf-v5-c-button pf-m-secondary" type="button" @click="pickerOpenBrowse()">Browse</button>
                                        </div>
                                        <!-- Inline results -->
                                        <div x-show="pickerDropdownOpen" style="border: 1px solid var(--pf-v5-global--BorderColor--100); border-top: 0; border-radius: 0 0 3px 3px; background: var(--pf-v5-global--BackgroundColor--100); max-height: 200px; overflow-y: auto; margin-top: -1px;">
                                            <div x-show="pickerSearchLoading" style="padding: 0.75rem; text-align: center; color: var(--pf-v5-global--Color--200);"><i class="fas fa-spinner fa-spin"></i> Searching...</div>
                                            <div x-show="!pickerSearchLoading && pickerSearchResults.length === 0" style="padding: 0.75rem; color: var(--pf-v5-global--Color--200);">No entries found</div>
                                            <template x-for="entry in pickerSearchResults" :key="entry.id">
                                                <div class="logbook-picker-result" @click="pickerSelectEntry(entry)" style="padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid var(--pf-v5-global--BorderColor--200);">
                                                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                                        <span style="font-weight: 500;" x-text="formatDate(entry.date)"></span>
                                                        <span x-show="entry.aircraft_hours_at_entry" style="color: var(--pf-v5-global--Color--200); font-size: 0.9em;" x-text="'· ' + formatHours(entry.aircraft_hours_at_entry)"></span>
                                                        <span class="pf-v5-c-label pf-m-compact pf-m-blue" x-show="entry.entry_type"><span class="pf-v5-c-label__content" x-text="entry.entry_type"></span></span>
                                                    </div>
                                                    <div style="font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="(entry.text || '').substring(0, 80)"></div>
                                                    <div x-show="entry.signoff_person" style="font-size: 0.85em; color: var(--pf-v5-global--Color--200);"><i class="fas fa-user"></i> <span x-text="entry.signoff_person"></span></div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitInspection" :disabled="inspectionSubmitting">
                        <span x-show="!inspectionSubmitting" x-text="editingInspectionRecord ? 'Save Changes' : 'Record Inspection'"></span>
                        <span x-show="inspectionSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeInspectionModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Create Compliance Records from Logbook Entry Modal -->
    <div class="pf-v5-c-backdrop" x-show="createRecordsModalOpen" x-cloak @click.self="!createRecordsSubmitting && closeCreateRecordsModal()" style="z-index: 1100;">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeCreateRecordsModal()" :disabled="createRecordsSubmitting" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Create Compliance Records</h1>
                    <template x-if="createRecordsEntry">
                        <div class="pf-v5-c-modal-box__description">
                            From logbook entry:
                            <strong x-text="formatDate(createRecordsEntry.date)"></strong>
                            <template x-if="createRecordsEntry.aircraft_hours_at_entry">
                                <span> · <span x-text="formatHours(createRecordsEntry.aircraft_hours_at_entry)"></span></span>
                            </template>
                            <span style="color: var(--pf-v5-global--Color--200);"> — </span>
                            <span style="color: var(--pf-v5-global--Color--200);" x-text="(createRecordsEntry.text || '').substring(0, 80) + (createRecordsEntry.text?.length > 80 ? '…' : '')"></span>
                        </div>
                    </template>
                </header>

                <div class="pf-v5-c-modal-box__body">

                    <!-- Loading spinner while tab data loads -->
                    <div x-show="createRecordsLoading" style="text-align: center; padding: 2rem 0; color: var(--pf-v5-global--Color--200);">
                        <div class="loading-spinner" style="width: 2rem; height: 2rem; margin: 0 auto;"></div>
                        <p style="margin-top: 0.5rem;">Loading...</p>
                    </div>

                    <!-- Empty state: no applicable inspections or ADs on this aircraft -->
                    <template x-if="!createRecordsLoading && createRecordsSelections.inspections.length === 0 && createRecordsSelections.ads.length === 0">
                        <div class="pf-v5-c-empty-state">
                            <div class="pf-v5-c-empty-state__content">
                                <i class="fas fa-info-circle" style="font-size: 2.5rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                                <h2 class="pf-v5-c-title pf-m-md">No applicable inspections or ADs</h2>
                                <div class="pf-v5-c-empty-state__body">
                                    Add inspection types or ADs from their respective tabs before creating records.
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Main form -->
                    <template x-if="!createRecordsLoading && (createRecordsSelections.inspections.length > 0 || createRecordsSelections.ads.length > 0)">
                        <div class="pf-v5-c-form">

                            <!-- Date / Hours row — editable in case entry lacks hours -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label">
                                        <span class="pf-v5-c-form__label-text">Date</span>
                                        <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input type="date" class="pf-v5-c-form-control" x-model="createRecordsDate" required>
                                    </div>
                                </div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label">
                                        <span class="pf-v5-c-form__label-text">Aircraft Hours</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input type="number" step="0.1" min="0" class="pf-v5-c-form-control" x-model="createRecordsHours" placeholder="e.g. 1234.5">
                                    </div>
                                </div>
                            </div>

                            <!-- Inspections checklist -->
                            <template x-if="createRecordsSelections.inspections.length > 0">
                                <div style="margin-bottom: 1.25rem;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--pf-v5-global--BorderColor--100);">
                                        <i class="fas fa-clipboard-list" style="color: var(--pf-v5-global--Color--200); margin-right: 0.4rem;"></i>Inspections
                                    </div>
                                    <template x-for="insp in createRecordsSelections.inspections" :key="insp.id">
                                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.25rem; border-bottom: 1px solid var(--pf-v5-global--BorderColor--200);">
                                            <input type="checkbox" x-model="insp.checked" :id="`cr-insp-${insp.id}`" style="flex-shrink: 0;">
                                            <label :for="`cr-insp-${insp.id}`" style="cursor: pointer; flex: 1; margin: 0;" x-text="insp.name"></label>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- ADs checklist -->
                            <template x-if="createRecordsSelections.ads.length > 0">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--pf-v5-global--BorderColor--100); display: flex; align-items: center; gap: 0.75rem;">
                                        <span><i class="fas fa-exclamation-triangle" style="color: var(--pf-v5-global--Color--200); margin-right: 0.4rem;"></i>Airworthiness Directives</span>
                                        <input type="text" class="pf-v5-c-form-control" placeholder="Filter ADs…"
                                               x-model="createRecordsAdSearch"
                                               style="width: 200px; font-weight: normal; font-size: 0.875rem;">
                                    </div>
                                    <template x-if="createRecordsFilteredAds.length === 0">
                                        <div style="color: var(--pf-v5-global--Color--200); font-size: 0.9em; padding: 0.5rem 0.25rem;">No ADs match filter</div>
                                    </template>
                                    <template x-for="ad in createRecordsFilteredAds" :key="ad.id">
                                        <div style="border-bottom: 1px solid var(--pf-v5-global--BorderColor--200);">
                                            <!-- AD row -->
                                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.5rem 0.25rem;">
                                                <input type="checkbox" x-model="ad.checked" :id="`cr-ad-${ad.id}`" @change="onCreateRecordsAdChecked(ad)" style="flex-shrink: 0; margin-top: 0.2rem;">
                                                <label :for="`cr-ad-${ad.id}`" style="cursor: pointer; flex: 1; margin: 0;">
                                                    <span style="font-weight: 500;" x-text="ad.name"></span>
                                                    <span style="color: var(--pf-v5-global--Color--200);"> — </span>
                                                    <span style="color: var(--pf-v5-global--Color--200); font-size: 0.9em;" x-text="ad.short_description"></span>
                                                </label>
                                            </div>
                                            <!-- Expanded fields when checked -->
                                            <template x-if="ad.checked">
                                                <div style="padding: 0.5rem 1.75rem 0.75rem; background: var(--pf-v5-global--BackgroundColor--200); border-radius: 3px; margin-bottom: 0.25rem;">
                                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                        <input type="checkbox" x-model="ad.permanent" :id="`cr-ad-perm-${ad.id}`">
                                                        <label :for="`cr-ad-perm-${ad.id}`" style="cursor: pointer; font-size: 0.9em; margin: 0;">Permanent compliance (no recurrence)</label>
                                                    </div>
                                                    <template x-if="!ad.permanent">
                                                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                                            <label style="font-size: 0.9em; white-space: nowrap; color: var(--pf-v5-global--Color--200);">Next due at (hrs):</label>
                                                            <input type="number" step="0.1" min="0" class="pf-v5-c-form-control" x-model="ad.next_due_at_time" placeholder="Optional" style="width: 130px;">
                                                        </div>
                                                    </template>
                                                    <div>
                                                        <label style="font-size: 0.9em; color: var(--pf-v5-global--Color--200); display: block; margin-bottom: 0.25rem;">Compliance notes (optional):</label>
                                                        <textarea class="pf-v5-c-form-control" rows="2" x-model="ad.compliance_notes" style="font-size: 0.9em;"
                                                                  :placeholder="(createRecordsEntry?.text || '').substring(0, 80)"></textarea>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>

                        </div>
                    </template>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <template x-if="!createRecordsLoading && (createRecordsSelections.inspections.length > 0 || createRecordsSelections.ads.length > 0)">
                        <button class="pf-v5-c-button pf-m-primary"
                                @click="submitCreateRecords()"
                                :disabled="createRecordsSubmitting || createRecordsTotalChecked === 0">
                            <span x-show="!createRecordsSubmitting">
                                Create
                                <span x-show="createRecordsTotalChecked > 0" x-text="createRecordsTotalChecked"></span>
                                Record<span x-show="createRecordsTotalChecked !== 1">s</span>
                            </span>
                            <span x-show="createRecordsSubmitting">Creating...</span>
                        </button>
                    </template>
                    <button class="pf-v5-c-button pf-m-link" @click="closeCreateRecordsModal()" :disabled="createRecordsSubmitting">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Add / Edit Inspection Type Modal -->
    <div class="pf-v5-c-backdrop" x-show="inspectionTypeModalOpen" x-cloak @click.self="closeInspectionTypeModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeInspectionTypeModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingInspectionType ? 'Edit Inspection Type' : 'Add Inspection Type'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <!-- Add existing or create new (only when creating) -->
                    <template x-if="!editingInspectionType">
                        <div style="margin-bottom: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label">
                                    <span class="pf-v5-c-form__label-text">Add Existing Type</span>
                                </label>
                                <div class="pf-v5-c-form__group-control" style="display: flex; gap: 0.5rem;">
                                    <select class="pf-v5-c-form-control" x-model="selectedExistingInspectionTypeId">
                                        <option value="">— Select existing —</option>
                                        <template x-for="t in availableInspectionTypes" :key="t.id">
                                            <option :value="t.id" x-text="t.name"></option>
                                        </template>
                                    </select>
                                    <button class="pf-v5-c-button pf-m-secondary"
                                            @click="addExistingInspectionType()"
                                            :disabled="!selectedExistingInspectionTypeId || inspectionTypeSubmitting">
                                        Add
                                    </button>
                                </div>
                            </div>
                            <div style="text-align: center; margin: 1rem 0; color: var(--pf-v5-global--Color--200);">— or create new —</div>
                        </div>
                    </template>

                    <form @submit.prevent="submitInspectionType" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="itype-name">
                                <span class="pf-v5-c-form__label-text">Name</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="text" id="itype-name" class="pf-v5-c-form-control" x-model="inspectionTypeForm.name" required placeholder="e.g. Annual Inspection">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Required</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <label class="pf-v5-c-check">
                                    <input type="checkbox" class="pf-v5-c-check__input" x-model="inspectionTypeForm.required">
                                    <span class="pf-v5-c-check__label">Required for airworthiness</span>
                                </label>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label">
                                <span class="pf-v5-c-form__label-text">Recurring</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <label class="pf-v5-c-check">
                                    <input type="checkbox" class="pf-v5-c-check__input" x-model="inspectionTypeForm.recurring">
                                    <span class="pf-v5-c-check__label">Repeats on a schedule</span>
                                </label>
                            </div>
                        </div>
                        <template x-if="inspectionTypeForm.recurring">
                            <div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="itype-hours">
                                        <span class="pf-v5-c-form__label-text">Recurring Hours (0 = not used)</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input type="number" step="0.1" min="0" id="itype-hours" class="pf-v5-c-form-control" x-model="inspectionTypeForm.recurring_hours">
                                    </div>
                                </div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="itype-months">
                                        <span class="pf-v5-c-form__label-text">Recurring Months (0 = not used)</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input type="number" min="0" id="itype-months" class="pf-v5-c-form-control" x-model="inspectionTypeForm.recurring_months">
                                    </div>
                                </div>
                                <div class="pf-v5-c-form__group">
                                    <label class="pf-v5-c-form__label" for="itype-days">
                                        <span class="pf-v5-c-form__label-text">Recurring Days (0 = not used)</span>
                                    </label>
                                    <div class="pf-v5-c-form__group-control">
                                        <input type="number" min="0" id="itype-days" class="pf-v5-c-form-control" x-model="inspectionTypeForm.recurring_days">
                                    </div>
                                </div>
                            </div>
                        </template>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitInspectionType" :disabled="inspectionTypeSubmitting">
                        <span x-show="!inspectionTypeSubmitting" x-text="editingInspectionType ? 'Save Changes' : 'Create & Add'"></span>
                        <span x-show="inspectionTypeSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeInspectionTypeModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Fuel Record Modal -->
    <div class="pf-v5-c-backdrop" x-show="fuelModalOpen" x-cloak @click.self="closeFuelModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeFuelModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingFuelRecord ? 'Edit Fuel Record' : 'Add Fuel Record'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitFuelRecord" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-date">
                                <span class="pf-v5-c-form__label-text">Date</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="date" id="fuel-date" class="pf-v5-c-form-control" x-model="fuelForm.date" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-quantity">
                                <span class="pf-v5-c-form__label-text">Quantity Added (gallons)</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="fuel-quantity" class="pf-v5-c-form-control" x-model="fuelForm.quantity_added" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-level">
                                <span class="pf-v5-c-form__label-text">Level After (gallons, optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="fuel-level" class="pf-v5-c-form-control" x-model="fuelForm.level_after">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-hours">
                                <span class="pf-v5-c-form__label-text">Aircraft Hours</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="fuel-hours" class="pf-v5-c-form-control" x-model="fuelForm.flight_hours" :placeholder="formatHours(aircraft?.flight_time)">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-type">
                                <span class="pf-v5-c-form__label-text">Fuel Type (optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="text" id="fuel-type" class="pf-v5-c-form-control" x-model="fuelForm.consumable_type" placeholder="e.g. 100LL">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-notes">
                                <span class="pf-v5-c-form__label-text">Notes (optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="fuel-notes" class="pf-v5-c-form-control" rows="2" x-model="fuelForm.notes"></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitFuelRecord" :disabled="fuelSubmitting">
                        <span x-show="!fuelSubmitting" x-text="editingFuelRecord ? 'Save Changes' : 'Add Record'"></span>
                        <span x-show="fuelSubmitting">Saving...</span>
                    </button>
                    <template x-if="editingFuelRecord">
                        <button class="pf-v5-c-button pf-m-danger" @click="deleteFuelRecord" :disabled="fuelSubmitting">Delete</button>
                    </template>
                    <button class="pf-v5-c-button pf-m-link" @click="closeFuelModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Oil Analysis Report Modal -->
    <div class="pf-v5-c-backdrop" x-show="oilAnalysisModalOpen" x-cloak @click.self="closeOilAnalysisModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeOilAnalysisModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingOilAnalysisReport ? 'Edit Oil Analysis Report' : 'Add Oil Analysis Report'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitOilAnalysisReport" class="pf-v5-c-form pf-m-horizontal">
                        <!-- Component -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-component">
                                    <span class="pf-v5-c-form__label-text">Engine Component</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <select id="oa-component" class="pf-v5-c-form-control" x-model="oilAnalysisForm.component">
                                    <option value="">— none —</option>
                                    <template x-for="comp in oilAnalysisEngineComponents" :key="comp.id">
                                        <option :value="comp.id" x-text="comp.component_type_name + (comp.install_location ? ' (' + comp.install_location + ')' : '')"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        <!-- Sample Date / Analysis Date -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-sample-date">
                                    <span class="pf-v5-c-form__label-text">Sample Date</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <input type="date" id="oa-sample-date" class="pf-v5-c-form-control" x-model="oilAnalysisForm.sample_date" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-analysis-date">
                                    <span class="pf-v5-c-form__label-text">Analysis Date</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <input type="date" id="oa-analysis-date" class="pf-v5-c-form-control" x-model="oilAnalysisForm.analysis_date">
                            </div>
                        </div>
                        <!-- Lab / Lab Number -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-lab">
                                    <span class="pf-v5-c-form__label-text">Lab</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <input type="text" id="oa-lab" class="pf-v5-c-form-control" x-model="oilAnalysisForm.lab" placeholder="e.g. Blackstone Laboratories">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-lab-number">
                                    <span class="pf-v5-c-form__label-text">Lab Number</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <input type="text" id="oa-lab-number" class="pf-v5-c-form-control" x-model="oilAnalysisForm.lab_number">
                            </div>
                        </div>
                        <!-- Engine / Oil Hours -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-engine-hours">
                                    <span class="pf-v5-c-form__label-text">Engine Hours at Sample</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="oa-engine-hours" class="pf-v5-c-form-control" x-model="oilAnalysisForm.engine_hours">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-oil-hours">
                                    <span class="pf-v5-c-form__label-text">Oil Hours at Sample</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="oa-oil-hours" class="pf-v5-c-form-control" x-model="oilAnalysisForm.oil_hours">
                            </div>
                        </div>
                        <!-- Oil Type / Added -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-oil-type">
                                    <span class="pf-v5-c-form__label-text">Oil Type</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <input type="text" id="oa-oil-type" class="pf-v5-c-form-control" x-model="oilAnalysisForm.oil_type" placeholder="e.g. Phillips XC 20W/50">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-oil-added">
                                    <span class="pf-v5-c-form__label-text">Oil Added (qt)</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.01" min="0" id="oa-oil-added" class="pf-v5-c-form-control" x-model="oilAnalysisForm.oil_added_quarts">
                            </div>
                        </div>
                        <!-- Status -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-status">
                                    <span class="pf-v5-c-form__label-text">Lab Status</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <select id="oa-status" class="pf-v5-c-form-control" x-model="oilAnalysisForm.status">
                                    <option value="">— not set —</option>
                                    <option value="normal">Normal</option>
                                    <option value="monitor">Monitor</option>
                                    <option value="action_required">Action Required</option>
                                </select>
                            </div>
                        </div>
                        <!-- Elements PPM (JSON) -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-elements">
                                    <span class="pf-v5-c-form__label-text">Elements (PPM, JSON)</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="oa-elements" class="pf-v5-c-form-control" rows="4" x-model="oilAnalysisForm.elements_ppm" style="font-family: monospace; font-size: 0.85rem;" placeholder='{"iron": 15, "copper": 8, "chromium": 2}'></textarea>
                                <p class="pf-v5-u-font-size-sm pf-v5-u-color-200" style="margin-top: 0.25rem;">Enter element concentrations in PPM as a JSON object.</p>
                            </div>
                        </div>
                        <!-- Lab Comments -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-lab-comments">
                                    <span class="pf-v5-c-form__label-text">Lab Comments</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="oa-lab-comments" class="pf-v5-c-form-control" rows="3" x-model="oilAnalysisForm.lab_comments"></textarea>
                            </div>
                        </div>
                        <!-- Notes -->
                        <div class="pf-v5-c-form__group">
                            <div class="pf-v5-c-form__group-label">
                                <label class="pf-v5-c-form__label" for="oa-notes">
                                    <span class="pf-v5-c-form__label-text">Notes</span>
                                </label>
                            </div>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="oa-notes" class="pf-v5-c-form-control" rows="2" x-model="oilAnalysisForm.notes"></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitOilAnalysisReport" :disabled="oilAnalysisSubmitting">
                        <span x-show="!oilAnalysisSubmitting" x-text="editingOilAnalysisReport ? 'Save Changes' : 'Add Report'"></span>
                        <span x-show="oilAnalysisSubmitting">Saving...</span>
                    </button>
                    <template x-if="editingOilAnalysisReport">
                        <button class="pf-v5-c-button pf-m-danger" @click="deleteOilAnalysisReport" :disabled="oilAnalysisSubmitting">Delete</button>
                    </template>
                    <button class="pf-v5-c-button pf-m-link" @click="closeOilAnalysisModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Oil Analysis AI Extract Modal -->
    <div class="pf-v5-c-backdrop" x-show="oilAnalysisAiModalOpen" x-cloak @click.self="closeOilAnalysisAiModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeOilAnalysisAiModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Import Oil Analysis from PDF</h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <!-- Step 1: File upload -->
                    <template x-if="!oilAnalysisAiResults">
                        <div class="pf-v5-c-form">
                            <p style="margin-bottom: 1rem; color: var(--pf-v5-global--Color--200);">
                                Upload a PDF oil analysis report from Blackstone, AvLab, or similar labs. AI will extract all sample data.
                            </p>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="oilAnalysisAiFileInput">
                                    <span class="pf-v5-c-form__label-text">PDF File</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <input type="file" id="oilAnalysisAiFileInput" class="pf-v5-c-form-control" accept=".pdf">
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="oa-ai-model">
                                    <span class="pf-v5-c-form__label-text">Model</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <select id="oa-ai-model" class="pf-v5-c-form-control"
                                            x-model="oilAnalysisAiModel"
                                            x-init="if (!oilAnalysisAiModel) oilAnalysisAiModel = '{{ import_default_model }}'">
                                        {% for model in import_models %}
                                        <option value="{{ model.id }}" data-provider="{{ model.provider }}">{{ model.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Step 2: Review extracted samples -->
                    <template x-if="oilAnalysisAiResults">
                        <div>
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--pf-v5-global--BackgroundColor--200); border-radius: 4px;">
                                <strong x-text="(oilAnalysisAiResults.samples || []).length + ' sample(s) extracted'"></strong>
                                <span x-show="oilAnalysisAiResults.lab" style="margin-left: 0.5rem; color: var(--pf-v5-global--Color--200);" x-text="'from ' + oilAnalysisAiResults.lab"></span>
                                <span x-show="oilAnalysisAiResults.tail_number" style="margin-left: 0.5rem; color: var(--pf-v5-global--Color--200);" x-text="'— ' + oilAnalysisAiResults.tail_number"></span>
                            </div>

                            <div style="max-height: 60vh; overflow-y: auto;">
                                <template x-for="(sample, idx) in (oilAnalysisAiResults.samples || [])" :key="idx">
                                    <div class="pf-v5-c-card" style="margin-bottom: 1rem;">
                                        <div class="pf-v5-c-card__header" style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem;">
                                            <input type="checkbox" :id="'oa-include-' + idx" x-model="oilAnalysisAiSampleIncludes[idx]" style="cursor: pointer;">
                                            <label :for="'oa-include-' + idx" style="font-weight: 600; cursor: pointer;" x-text="'Sample: ' + (sample.sample_date || 'unknown date')"></label>
                                            <template x-if="sample.status">
                                                <span class="pf-v5-c-label" :class="oilAnalysisStatusClass(sample.status)">
                                                    <span class="pf-v5-c-label__content" x-text="oilAnalysisStatusLabel(sample.status)"></span>
                                                </span>
                                            </template>
                                        </div>
                                        <div class="pf-v5-c-card__body">
                                            <!-- Component assignment -->
                                            <div style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                                <label style="font-size: 0.875rem; min-width: 120px;">Engine component:</label>
                                                <select class="pf-v5-c-form-control" style="max-width: 280px;" x-model="oilAnalysisAiSampleComponents[idx]">
                                                    <option value="">— none —</option>
                                                    <template x-for="comp in oilAnalysisEngineComponents" :key="comp.id">
                                                        <option :value="comp.id" x-text="comp.component_type_name + (comp.install_location ? ' (' + comp.install_location + ')' : '')"></option>
                                                    </template>
                                                </select>
                                            </div>
                                            <!-- Hours info -->
                                            <div style="font-size: 0.875rem; color: var(--pf-v5-global--Color--200); margin-bottom: 0.5rem;">
                                                <span x-show="sample.engine_hours != null">Engine: <strong x-text="sample.engine_hours + ' hrs'"></strong> &nbsp;</span>
                                                <span x-show="sample.oil_hours != null">Oil: <strong x-text="sample.oil_hours + ' hrs'"></strong> &nbsp;</span>
                                                <span x-show="sample.oil_added_quarts != null">Added: <strong x-text="sample.oil_added_quarts + ' qt'"></strong></span>
                                            </div>
                                            <!-- Elements grid -->
                                            <template x-if="sample.elements_ppm && Object.keys(sample.elements_ppm).length > 0">
                                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.35rem; margin-bottom: 0.75rem;">
                                                    <template x-for="[el, val] in Object.entries(sample.elements_ppm).filter(([k,v]) => v !== null)" :key="el">
                                                        <div style="background: var(--pf-v5-global--BackgroundColor--200); border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.8rem;">
                                                            <span style="text-transform: capitalize; font-weight: 500;" x-text="el"></span>: <span x-text="val"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                            <!-- Lab comments -->
                                            <template x-if="sample.lab_comments">
                                                <p style="font-size: 0.875rem; font-style: italic; color: var(--pf-v5-global--Color--200); margin: 0;" x-text="sample.lab_comments"></p>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Loading state -->
                    <template x-if="oilAnalysisAiExtracting">
                        <div class="pf-v5-c-empty-state" style="margin: 1rem 0;">
                            <div class="pf-v5-c-empty-state__content">
                                <div class="loading-spinner" style="width: 2rem; height: 2rem; margin: 0 auto 0.5rem;"></div>
                                <p>Extracting data from PDF... this may take a moment.</p>
                            </div>
                        </div>
                    </template>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <template x-if="!oilAnalysisAiResults">
                        <button class="pf-v5-c-button pf-m-primary" @click="submitOilAnalysisAiFile" :disabled="oilAnalysisAiExtracting">
                            <span x-show="!oilAnalysisAiExtracting"><i class="fas fa-magic"></i> Extract Data</span>
                            <span x-show="oilAnalysisAiExtracting">Extracting...</span>
                        </button>
                    </template>
                    <template x-if="oilAnalysisAiResults">
                        <button class="pf-v5-c-button pf-m-primary" @click="saveOilAnalysisAiResults" :disabled="oilAnalysisAiExtracting">
                            <i class="fas fa-save"></i> Save Selected Samples
                        </button>
                    </template>
                    <button class="pf-v5-c-button pf-m-link" @click="closeOilAnalysisAiModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Collection Modal -->
    <div class="pf-v5-c-backdrop" x-show="collectionModalOpen" x-cloak @click.self="closeCollectionModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeCollectionModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingCollection ? 'Edit Collection' : 'Add Collection'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitCollection" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="collection-name">
                                <span class="pf-v5-c-form__label-text">Name</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input id="collection-name" class="pf-v5-c-form-control" type="text" x-model="collectionForm.name" required placeholder="e.g. Engine Logbook" x-effect="if (collectionModalOpen) $nextTick(() => $el.focus())">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="collection-description">
                                <span class="pf-v5-c-form__label-text">Description</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="collection-description" class="pf-v5-c-form-control" rows="3" x-model="collectionForm.description" placeholder="Optional description..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitCollection" :disabled="collectionSubmitting">
                        <span x-show="!collectionSubmitting" x-text="editingCollection ? 'Save Changes' : 'Create Collection'"></span>
                        <span x-show="collectionSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeCollectionModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div class="pf-v5-c-backdrop" x-show="documentModalOpen" x-cloak @click.self="closeDocumentModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeDocumentModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingDocument ? 'Edit Document' : 'Add Document'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitDocument" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="doc-name">
                                <span class="pf-v5-c-form__label-text">Name</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input id="doc-name" class="pf-v5-c-form-control" type="text" x-model="documentForm.name" required placeholder="e.g. Annual Inspection 2024">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="doc-type">
                                    <span class="pf-v5-c-form__label-text">Document Type</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <select id="doc-type" class="pf-v5-c-form-control" x-model="documentForm.doc_type" required>
                                        <template x-for="dt in documentTypes" :key="dt.value">
                                            <option :value="dt.value" x-text="dt.label"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="doc-collection">
                                    <span class="pf-v5-c-form__label-text">Collection</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <select id="doc-collection" class="pf-v5-c-form-control" x-model="documentForm.collection">
                                        <option value="">-- None --</option>
                                        <template x-for="col in [...documentCollections].sort((a, b) => a.name.localeCompare(b.name))" :key="col.id">
                                            <option :value="col.id" x-text="col.name"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="doc-description">
                                <span class="pf-v5-c-form__label-text">Description</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="doc-description" class="pf-v5-c-form-control" rows="2" x-model="documentForm.description" placeholder="Optional description..."></textarea>
                            </div>
                        </div>

                        <!-- Existing images (edit mode) -->
                        <template x-if="editingDocument && editingDocument.images && editingDocument.images.length > 0">
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label">
                                    <span class="pf-v5-c-form__label-text">Existing Images</span>
                                </label>
                                <div class="pf-v5-c-form__group-control">
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <template x-for="img in editingDocument.images" :key="img.id">
                                            <div style="position: relative; width: 80px; height: 80px; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 4px; overflow: hidden;">
                                                <img :src="img.image" style="width: 100%; height: 100%; object-fit: cover;">
                                                <button type="button" class="pf-v5-c-button pf-m-plain" @click="deleteDocumentImage(img.id)"
                                                        style="position: absolute; top: 0; right: 0; padding: 0.125rem 0.25rem; background: rgba(0,0,0,0.6); color: white; font-size: 0.625rem; border-radius: 0 0 0 4px;"
                                                        title="Delete image">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="doc-images">
                                <span class="pf-v5-c-form__label-text" x-text="editingDocument ? 'Add More Images' : 'Images'"></span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input id="doc-images" type="file" class="pf-v5-c-form-control" multiple accept="image/*,.pdf,.txt,.text" @change="onDocumentFilesSelected($event)">
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitDocument" :disabled="documentSubmitting">
                        <span x-show="!documentSubmitting" x-text="editingDocument ? 'Save Changes' : 'Create Document'"></span>
                        <span x-show="documentSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeDocumentModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Logbook Picker Browse Modal (stacked over compliance/inspection/major record modals) -->
    <div class="pf-v5-c-backdrop" x-show="pickerBrowseOpen" x-cloak @click.self="pickerBrowseOpen = false" style="z-index: 1200;">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="pickerBrowseOpen = false" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>
                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Browse Logbook Entries</h1>
                </header>
                <div class="pf-v5-c-modal-box__body">
                    <!-- Filter row -->
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <input type="text" class="pf-v5-c-form-control" placeholder="Search by date, text, mechanic..." x-model="pickerBrowseSearch" @input="pickerBrowseApplyFilters()" style="flex: 1; min-width: 200px;">
                        <select class="pf-v5-c-form-control" x-model="pickerBrowseLogType" @change="pickerBrowseApplyFiltersImmediate()" style="width: auto;">
                            <option value="">All Books</option>
                            <option value="AC">Airframe</option>
                            <option value="ENG">Engine</option>
                            <option value="PROP">Propeller</option>
                            <option value="OTHER">Other</option>
                        </select>
                        <select class="pf-v5-c-form-control" x-model="pickerBrowseEntryType" @change="pickerBrowseApplyFiltersImmediate()" style="width: auto;">
                            <option value="">All Types</option>
                            <option value="MAINTENANCE">Maintenance</option>
                            <option value="INSPECTION">Inspection</option>
                            <option value="REPAIR">Repair</option>
                            <option value="OVERHAUL">Overhaul</option>
                            <option value="ALTERATION">Alteration</option>
                            <option value="AD_COMPLIANCE">AD Compliance</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    <!-- Loading -->
                    <div x-show="pickerBrowseLoading && pickerBrowseResults.length === 0" style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner" style="width: 2rem; height: 2rem; margin: 0 auto;"></div>
                        <p style="margin-top: 0.5rem; color: var(--pf-v5-global--Color--200);">Loading...</p>
                    </div>
                    <!-- Empty state -->
                    <div x-show="!pickerBrowseLoading && pickerBrowseResults.length === 0" style="text-align: center; padding: 2rem; color: var(--pf-v5-global--Color--200);">
                        <i class="fas fa-book" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p>No logbook entries found.</p>
                    </div>
                    <!-- Result list -->
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <template x-for="entry in pickerBrowseResults" :key="entry.id">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px; background: var(--pf-v5-global--BackgroundColor--100);">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.25rem;">
                                        <span style="font-weight: 600;" x-text="formatDate(entry.date)"></span>
                                        <span x-show="entry.aircraft_hours_at_entry" style="color: var(--pf-v5-global--Color--200);" x-text="formatHours(entry.aircraft_hours_at_entry)"></span>
                                        <span class="pf-v5-c-label pf-m-compact pf-m-blue" x-show="entry.entry_type"><span class="pf-v5-c-label__content" x-text="entry.entry_type"></span></span>
                                        <span class="pf-v5-c-label pf-m-compact pf-m-grey" x-show="entry.log_type"><span class="pf-v5-c-label__content" x-text="entry.log_type"></span></span>
                                    </div>
                                    <p x-text="entry.text" style="margin: 0; font-size: 0.9em;"></p>
                                    <div x-show="entry.signoff_person" style="margin-top: 0.25rem; font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                        <i class="fas fa-user"></i> <span x-text="entry.signoff_person"></span>
                                        <template x-if="entry.signoff_location">
                                            <span> — <span x-text="entry.signoff_location"></span></span>
                                        </template>
                                    </div>
                                </div>
                                <button class="pf-v5-c-button pf-m-secondary pf-m-sm" type="button" @click="pickerSelectEntry(entry)">Select</button>
                            </div>
                        </template>
                    </div>
                    <!-- Load more -->
                    <div x-show="pickerBrowseHasMore" style="text-align: center; margin-top: 1rem;">
                        <button class="pf-v5-c-button pf-m-secondary" type="button" @click="pickerBrowseLoadMore()" :disabled="pickerBrowseLoading">
                            <span x-show="!pickerBrowseLoading">Load More</span>
                            <span x-show="pickerBrowseLoading"><i class="fas fa-spinner fa-spin"></i> Loading...</span>
                        </button>
                    </div>
                    <p x-show="pickerBrowseTotal > 0" style="margin-top: 0.75rem; text-align: center; font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                        Showing <span x-text="pickerBrowseResults.length"></span> of <span x-text="pickerBrowseTotal"></span> entries
                    </p>
                </div>
                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-link" type="button" @click="pickerBrowseOpen = false">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Logbook Link Picker Modal (logbook-first workflow) -->
    <div class="pf-v5-c-backdrop" x-show="linkPickerOpen" x-cloak @click.self="linkPickerOpen = false" style="z-index: 1000;">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop style="max-height: 90vh; overflow-y: auto;">
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="linkPickerOpen = false" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>
                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Link Entry to Record</h1>
                </header>
                <div class="pf-v5-c-modal-box__body">
                    <!-- Entry being linked -->
                    <template x-if="linkPickerEntry">
                        <div style="padding: 0.75rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px; background: var(--pf-v5-global--BackgroundColor--200); margin-bottom: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.25rem;">
                                <span style="font-weight: 600;" x-text="formatDate(linkPickerEntry.date)"></span>
                                <span x-show="linkPickerEntry.aircraft_hours_at_entry" style="color: var(--pf-v5-global--Color--200);" x-text="formatHours(linkPickerEntry.aircraft_hours_at_entry)"></span>
                                <span class="pf-v5-c-label pf-m-compact pf-m-blue" x-show="linkPickerEntry.entry_type"><span class="pf-v5-c-label__content" x-text="linkPickerEntry.entry_type"></span></span>
                            </div>
                            <p x-text="(linkPickerEntry.text || '').substring(0, 120)" style="margin: 0; font-size: 0.9em;"></p>
                        </div>
                    </template>
                    <!-- Tabs -->
                    <nav class="pf-v5-c-tabs" style="margin-bottom: 1rem;">
                        <ul class="pf-v5-c-tabs__list">
                            <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': linkPickerTab === 'inspections' }">
                                <button class="pf-v5-c-tabs__link" @click="linkPickerTab = 'inspections'">
                                    <span class="pf-v5-c-tabs__item-text">Inspections (<span x-text="linkableInspections.length"></span>)</span>
                                </button>
                            </li>
                            <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': linkPickerTab === 'ads' }">
                                <button class="pf-v5-c-tabs__link" @click="linkPickerTab = 'ads'">
                                    <span class="pf-v5-c-tabs__item-text">AD Compliance (<span x-text="linkableAdCompliances.length"></span>)</span>
                                </button>
                            </li>
                            <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': linkPickerTab === 'major_records' }">
                                <button class="pf-v5-c-tabs__link" @click="linkPickerTab = 'major_records'">
                                    <span class="pf-v5-c-tabs__item-text">Major Records (<span x-text="linkableMajorRecords.length"></span>)</span>
                                </button>
                            </li>
                        </ul>
                    </nav>
                    <!-- Inspections tab -->
                    <div x-show="linkPickerTab === 'inspections'">
                        <div x-show="!inspectionsLoaded" style="text-align: center; padding: 1.5rem; color: var(--pf-v5-global--Color--200);"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                        <div x-show="inspectionsLoaded && linkableInspections.length === 0" style="text-align: center; padding: 1.5rem; color: var(--pf-v5-global--Color--200);">
                            All inspection records already have a logbook entry linked.
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <template x-for="record in linkableInspections" :key="record.id">
                                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 500;" x-text="record.label"></div>
                                        <div style="font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                            <span x-text="formatDate(record.date)"></span>
                                            <template x-if="record.hours"><span> · <span x-text="formatHours(record.hours)"></span></span></template>
                                        </div>
                                    </div>
                                    <button class="pf-v5-c-button pf-m-primary pf-m-sm" type="button" @click="linkEntryTo(record)" :disabled="linkPickerSubmitting">Link</button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- AD Compliance tab -->
                    <div x-show="linkPickerTab === 'ads'">
                        <div x-show="!adsLoaded" style="text-align: center; padding: 1.5rem; color: var(--pf-v5-global--Color--200);"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                        <div x-show="adsLoaded && linkableAdCompliances.length === 0" style="text-align: center; padding: 1.5rem; color: var(--pf-v5-global--Color--200);">
                            All AD compliance records already have a logbook entry linked.
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <template x-for="record in linkableAdCompliances" :key="record.id">
                                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 500;" x-text="record.label"></div>
                                        <div style="font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                            <span x-text="formatDate(record.date)"></span>
                                            <template x-if="record.hours"><span> · <span x-text="formatHours(record.hours)"></span></span></template>
                                        </div>
                                    </div>
                                    <button class="pf-v5-c-button pf-m-primary pf-m-sm" type="button" @click="linkEntryTo(record)" :disabled="linkPickerSubmitting">Link</button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- Major Records tab -->
                    <div x-show="linkPickerTab === 'major_records'">
                        <div x-show="!majorRecordsLoaded" style="text-align: center; padding: 1.5rem; color: var(--pf-v5-global--Color--200);"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                        <div x-show="majorRecordsLoaded && linkableMajorRecords.length === 0" style="text-align: center; padding: 1.5rem; color: var(--pf-v5-global--Color--200);">
                            All major repair/alteration records already have a logbook entry linked.
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <template x-for="record in linkableMajorRecords" :key="record.id">
                                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--pf-v5-global--BorderColor--100); border-radius: 3px;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 500;" x-text="record.label"></div>
                                        <div style="font-size: 0.85em; color: var(--pf-v5-global--Color--200);">
                                            <span x-text="formatDate(record.date)"></span>
                                            <template x-if="record.hours"><span> · <span x-text="formatHours(record.hours)"></span></span></template>
                                        </div>
                                    </div>
                                    <button class="pf-v5-c-button pf-m-primary pf-m-sm" type="button" @click="linkEntryTo(record)" :disabled="linkPickerSubmitting">Link</button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-link" type="button" @click="linkPickerOpen = false">Close</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Aircraft Modal -->
    {% include 'includes/aircraft_modal.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/tab-scroller.js' %}"></script>
<script src="{% static 'js/aircraft-detail-components.js' %}"></script>
<script src="{% static 'js/aircraft-detail-squawks.js' %}"></script>
<script src="{% static 'js/aircraft-detail-notes.js' %}"></script>
<script src="{% static 'js/aircraft-detail-consumables.js' %}"></script>
<script src="{% static 'js/aircraft-detail-oil.js' %}"></script>
<script src="{% static 'js/aircraft-detail-fuel.js' %}"></script>
<script src="{% static 'js/aircraft-detail-oil-analysis.js' %}"></script>
<script src="{% static 'js/aircraft-detail-logbook.js' %}"></script>
<script src="{% static 'js/aircraft-detail-logbook-picker.js' %}"></script>
<script src="{% static 'js/aircraft-detail-logbook-link.js' %}"></script>
<script src="{% static 'js/aircraft-detail-ads.js' %}"></script>
<script src="{% static 'js/aircraft-detail-inspections.js' %}"></script>
<script src="{% static 'js/aircraft-detail-major-records.js' %}"></script>
<script src="{% static 'js/aircraft-detail-documents.js' %}"></script>
<script src="{% static 'js/aircraft-detail-events.js' %}"></script>
<script src="{% static 'js/aircraft-detail-roles.js' %}"></script>
<script src="{% static 'js/aircraft-switcher.js' %}"></script>
<script src="{% static 'js/aircraft-detail.js' %}"></script>
<script src="{% static 'js/aircraft-modal.js' %}"></script>
{% endblock %}
