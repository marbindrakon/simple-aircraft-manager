{% extends "base.html" %}
{% load static %}

{% block content %}
<div x-data="aircraftDetail('{{ aircraft_id }}')" @aircraft-updated.window="loadData()">
    <!-- Page Header -->
    <div class="pf-v5-c-page__main-section pf-m-light">
        <div class="pf-v5-c-content">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div>
                        <h1 x-text="aircraft?.tail_number || 'Loading...'"></h1>
                        <p x-show="aircraft">
                            <span x-text="aircraft?.make"></span>
                            <span x-text="aircraft?.model"></span>
                        </p>
                    </div>
                    <!-- Airworthiness Status Badge -->
                    <div x-show="aircraft" x-cloak
                         class="airworthiness-badge"
                         :class="getAirworthinessClass()"
                         :title="getAirworthinessTooltip()">
                        <span class="status-icon">
                            <template x-if="aircraft?.airworthiness?.status === 'GREEN'">
                                <i class="fas fa-check-circle"></i>
                            </template>
                            <template x-if="aircraft?.airworthiness?.status === 'ORANGE'">
                                <i class="fas fa-exclamation-triangle"></i>
                            </template>
                            <template x-if="aircraft?.airworthiness?.status === 'RED'">
                                <i class="fas fa-times-circle"></i>
                            </template>
                        </span>
                        <span class="status-text" x-text="getAirworthinessText()"></span>
                    </div>
                </div>
                <div x-show="aircraft" x-cloak>
                    <button class="pf-v5-c-button pf-m-primary"
                            @click="openHoursModal()"
                            :disabled="aircraft?.airworthiness?.status === 'RED'">
                        Update Hours
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="pf-v5-c-page__main-section" x-show="loading" x-cloak>
        <div class="pf-v5-c-empty-state">
            <div class="pf-v5-c-empty-state__content">
                <div class="loading-spinner" style="width: 3rem; height: 3rem;"></div>
                <h2 class="pf-v5-c-title pf-m-lg">Loading aircraft data...</h2>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="pf-v5-c-page__main-section" x-show="!loading && aircraft" x-cloak>
        <div class="pf-v5-c-tabs" role="region">
            <ul class="pf-v5-c-tabs__list">
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activeTab === 'overview' }">
                    <button class="pf-v5-c-tabs__link" @click="activeTab = 'overview'">
                        <span class="pf-v5-c-tabs__item-text">Overview</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activeTab === 'components' }">
                    <button class="pf-v5-c-tabs__link" @click="activeTab = 'components'">
                        <span class="pf-v5-c-tabs__item-text">Components</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activeTab === 'logbook' }">
                    <button class="pf-v5-c-tabs__link" @click="activeTab = 'logbook'">
                        <span class="pf-v5-c-tabs__item-text">Logbook</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activeTab === 'squawks' }">
                    <button class="pf-v5-c-tabs__link" @click="activeTab = 'squawks'">
                        <span class="pf-v5-c-tabs__item-text">Squawks</span>
                        <template x-if="activeSquawks.length > 0">
                            <span class="pf-v5-c-badge pf-m-unread" style="margin-left: 0.5rem;" x-text="activeSquawks.length"></span>
                        </template>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activeTab === 'oil' }">
                    <button class="pf-v5-c-tabs__link" @click="activeTab = 'oil'">
                        <span class="pf-v5-c-tabs__item-text">Oil</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activeTab === 'fuel' }">
                    <button class="pf-v5-c-tabs__link" @click="activeTab = 'fuel'">
                        <span class="pf-v5-c-tabs__item-text">Fuel</span>
                    </button>
                </li>
                <li class="pf-v5-c-tabs__item" :class="{ 'pf-m-current': activeTab === 'documents' }">
                    <button class="pf-v5-c-tabs__link" @click="activeTab = 'documents'">
                        <span class="pf-v5-c-tabs__item-text">Documents</span>
                    </button>
                </li>
            </ul>
        </div>

        <!-- Overview Tab -->
        <div x-show="activeTab === 'overview'" class="pf-v5-c-page__main-section">
            <div class="pf-l-gallery pf-m-gutter">
                <!-- Aircraft Info Card -->
                <div class="pf-v5-c-card">
                    <div class="pf-v5-c-card__title">
                        <h2>Aircraft Information</h2>
                    </div>
                    <div class="pf-v5-c-card__body">
                        <dl>
                            <dt>Tail Number:</dt>
                            <dd x-text="aircraft?.tail_number"></dd>
                            <dt>Make:</dt>
                            <dd x-text="aircraft?.make"></dd>
                            <dt>Model:</dt>
                            <dd x-text="aircraft?.model"></dd>
                            <dt>Status:</dt>
                            <dd>
                                <span class="pf-v5-c-label pf-m-blue" x-text="aircraft?.status"></span>
                            </dd>
                        </dl>
                    </div>
                </div>

                <!-- Hours Card -->
                <div class="pf-v5-c-card">
                    <div class="pf-v5-c-card__title">
                        <h2>Flight Hours</h2>
                    </div>
                    <div class="pf-v5-c-card__body">
                        <div style="text-align: center;">
                            <div class="hours-display" x-text="formatHours(aircraft?.flight_time)"></div>
                            <p>Total Hours</p>
                        </div>
                    </div>
                </div>

                <!-- Notes Card -->
                <div class="pf-v5-c-card">
                    <div class="pf-v5-c-card__header">
                        <div class="pf-v5-c-card__header-main">
                            <div class="pf-v5-c-card__title">
                                <h2>Notes</h2>
                            </div>
                        </div>
                        <div class="pf-v5-c-card__actions">
                            <button class="pf-v5-c-button pf-m-plain" @click="openNoteModal()" title="Add Note">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pf-v5-c-card__body">
                        <template x-if="aircraftNotes.length === 0">
                            <p style="color: var(--pf-v5-global--Color--200);">No notes yet</p>
                        </template>
                        <template x-if="aircraftNotes.length > 0">
                            <div class="notes-list">
                                <template x-for="note in aircraftNotes.slice(0, 3)" :key="note.id">
                                    <div class="note-item" @click="editNote(note)">
                                        <p class="note-text" x-text="note.text"></p>
                                        <div class="note-meta">
                                            <span x-text="formatDate(note.added_timestamp)"></span>
                                            <template x-if="note.added_by_username">
                                                <span> - <span x-text="note.added_by_username"></span></span>
                                            </template>
                                            <template x-if="note.edited_timestamp">
                                                <span class="note-edited">(edited)</span>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="aircraftNotes.length > 3">
                                    <p style="text-align: center; margin-top: 0.5rem;">
                                        <a href="#" @click.prevent="showAllNotes = true" class="pf-v5-c-button pf-m-link pf-m-inline">
                                            View all <span x-text="aircraftNotes.length"></span> notes
                                        </a>
                                    </p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Airworthiness Issues Section -->
            <template x-if="aircraft?.airworthiness?.issue_count > 0">
                <div class="pf-v5-c-card" style="margin-top: 1.5rem;"
                     :class="{ 'card-border-red': aircraft?.airworthiness?.status === 'RED', 'card-border-orange': aircraft?.airworthiness?.status === 'ORANGE' }">
                    <div class="pf-v5-c-card__header">
                        <div class="pf-v5-c-card__header-main">
                            <div class="pf-v5-c-card__title">
                                <h2>Airworthiness Issues</h2>
                            </div>
                        </div>
                        <div class="pf-v5-c-card__actions">
                            <template x-if="aircraft?.airworthiness?.red_count > 0">
                                <span class="pf-v5-c-label pf-m-red">
                                    <span x-text="aircraft.airworthiness.red_count"></span> Grounding
                                </span>
                            </template>
                            <template x-if="aircraft?.airworthiness?.orange_count > 0">
                                <span class="pf-v5-c-label pf-m-orange" style="margin-left: 0.5rem;">
                                    <span x-text="aircraft.airworthiness.orange_count"></span> Upcoming
                                </span>
                            </template>
                        </div>
                    </div>
                    <div class="pf-v5-c-card__body">
                        <div class="airworthiness-issues">
                            <template x-for="issue in aircraft?.airworthiness?.issues || []" :key="issue.item_id">
                                <div class="issue-item" :class="'issue-severity-' + issue.severity.toLowerCase()">
                                    <div class="issue-icon" :class="'icon-' + issue.severity.toLowerCase()">
                                        <template x-if="issue.severity === 'RED'">
                                            <i class="fas fa-times-circle"></i>
                                        </template>
                                        <template x-if="issue.severity === 'ORANGE'">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </template>
                                    </div>
                                    <div class="issue-content">
                                        <div class="issue-category" x-text="issue.category"></div>
                                        <div class="issue-title" x-text="issue.title"></div>
                                        <div class="issue-description" x-text="issue.description"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Components Tab -->
        <div x-show="activeTab === 'components'" class="pf-v5-c-page__main-section">
            <table class="pf-v5-c-table pf-m-grid-md">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Manufacturer/Model</th>
                        <th>Location</th>
                        <th>Hours</th>
                        <th>Interval</th>
                        <th>Remaining</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-if="components.length === 0">
                        <tr>
                            <td colspan="8" style="text-align: center;">No components found</td>
                        </tr>
                    </template>
                    <template x-for="component in components" :key="component.id">
                        <tr>
                            <td>
                                <span x-text="getComponentTypeName(component)"></span>
                                <template x-if="component.replacement_critical">
                                    <span class="pf-v5-c-label pf-m-compact pf-m-purple" style="margin-left: 0.25rem;" title="Replacement item">
                                        <i class="fas fa-sync-alt"></i>
                                    </span>
                                </template>
                            </td>
                            <td x-text="`${component.manufacturer} ${component.model}`"></td>
                            <td x-text="component.install_location"></td>
                            <td x-text="formatHours(getComponentCurrentHours(component))"></td>
                            <td x-text="getComponentInterval(component)"></td>
                            <td :class="getHoursRemainingClass(component)" x-text="calculateHoursRemaining(component)"></td>
                            <td>
                                <span class="pf-v5-c-label"
                                      :class="getStatusClass(component)"
                                      x-text="component.status"></span>
                            </td>
                            <td>
                                <template x-if="component.replacement_critical && component.status === 'IN-USE'">
                                    <button class="pf-v5-c-button pf-m-plain"
                                            @click="resetComponentService(component)"
                                            :title="'Reset ' + getComponentTypeName(component) + ' service time'">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </template>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Logbook Tab -->
        <div x-show="activeTab === 'logbook'" class="pf-v5-c-page__main-section">
            <template x-if="recentLogs.length === 0">
                <div class="pf-v5-c-empty-state">
                    <div class="pf-v5-c-empty-state__content">
                        <h2 class="pf-v5-c-title pf-m-lg">No logbook entries</h2>
                    </div>
                </div>
            </template>
            <template x-if="recentLogs.length > 0">
                <div class="pf-v5-l-stack pf-m-gutter">
                    <template x-for="log in recentLogs" :key="log.id">
                        <div class="pf-v5-c-card">
                            <div class="pf-v5-c-card__title">
                                <div style="display: flex; justify-content: space-between;">
                                    <h3 x-text="formatDate(log.date)"></h3>
                                    <span class="pf-v5-c-label pf-m-blue" x-text="log.entry_type || log.log_type"></span>
                                </div>
                            </div>
                            <div class="pf-v5-c-card__body">
                                <p x-text="log.text"></p>
                                <template x-if="log.aircraft_hours_at_entry">
                                    <p style="margin-top: 0.5rem;">
                                        <strong>Aircraft Hours:</strong>
                                        <span x-text="formatHours(log.aircraft_hours_at_entry)"></span>
                                    </p>
                                </template>
                                <template x-if="log.signoff_person">
                                    <p style="margin-top: 0.5rem;">
                                        <strong>Signed by:</strong>
                                        <span x-text="log.signoff_person"></span>
                                    </p>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <!-- Squawks Tab -->
        <div x-show="activeTab === 'squawks'" class="pf-v5-c-page__main-section">
            <!-- Header with Add Button -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Active Squawks</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <a :href="`/aircraft/${aircraftId}/squawks/history/`" class="pf-v5-c-button pf-m-secondary">
                        <i class="fas fa-history"></i> View History
                    </a>
                    <button class="pf-v5-c-button pf-m-primary" @click="openSquawkModal()">
                        <i class="fas fa-plus"></i> New Squawk
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <template x-if="activeSquawks.length === 0">
                <div class="pf-v5-c-empty-state">
                    <div class="pf-v5-c-empty-state__content">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--pf-v5-global--success-color--100);"></i>
                        <h2 class="pf-v5-c-title pf-m-lg">No Active Squawks</h2>
                        <div class="pf-v5-c-empty-state__body">
                            This aircraft has no open maintenance issues.
                        </div>
                    </div>
                </div>
            </template>

            <!-- Squawk List -->
            <div class="pf-v5-l-stack pf-m-gutter" x-show="activeSquawks.length > 0">
                <template x-for="squawk in activeSquawks" :key="squawk.id">
                    <div class="pf-v5-c-card squawk-card" :class="getSquawkCardClass(squawk)">
                        <div class="pf-v5-c-card__header">
                            <div class="pf-v5-c-card__header-main">
                                <div class="pf-v5-c-card__title">
                                    <span class="pf-v5-c-label" :class="getSquawkPriorityClass(squawk)" x-text="squawk.priority_display"></span>
                                    <template x-if="squawk.component_name">
                                        <span class="pf-v5-c-label pf-m-blue" style="margin-left: 0.5rem;" x-text="squawk.component_name"></span>
                                    </template>
                                </div>
                            </div>
                            <div class="pf-v5-c-card__actions">
                                <button class="pf-v5-c-button pf-m-plain" @click="editSquawk(squawk)" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="pf-v5-c-button pf-m-plain pf-m-success" @click="resolveSquawk(squawk)" title="Mark Resolved">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                        <div class="pf-v5-c-card__body">
                            <p x-text="squawk.issue_reported"></p>
                            <template x-if="squawk.notes">
                                <p style="margin-top: 0.5rem; color: var(--pf-v5-global--Color--200);">
                                    <strong>Notes:</strong> <span x-text="squawk.notes"></span>
                                </p>
                            </template>
                        </div>
                        <div class="pf-v5-c-card__footer" style="font-size: 0.875rem; color: var(--pf-v5-global--Color--200);">
                            <span>Reported <span x-text="formatDateTime(squawk.created_at)"></span></span>
                            <template x-if="squawk.reported_by_username">
                                <span> by <span x-text="squawk.reported_by_username"></span></span>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Oil Tab -->
        <div x-show="activeTab === 'oil'" class="pf-v5-c-page__main-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Oil Consumption</h2>
                <button class="pf-v5-c-button pf-m-primary" @click="openOilModal()">
                    <i class="fas fa-plus"></i> Add Oil Record
                </button>
            </div>

            <!-- Loading -->
            <div x-show="!oilLoaded" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading oil records...</h2>
                </div>
            </div>

            <div x-show="oilLoaded" x-cloak>
                <!-- Empty State -->
                <template x-if="oilRecords.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-oil-can" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No oil records</h2>
                            <div class="pf-v5-c-empty-state__body">
                                Track oil consumption by adding records each time you add oil.
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Oil Chart -->
                <template x-if="oilRecords.length >= 2">
                    <div class="pf-v5-c-card" style="margin-bottom: 1rem;">
                        <div class="pf-v5-c-card__title"><h3>Oil Consumption Trend (Hours per Quart)</h3></div>
                        <div class="pf-v5-c-card__body">
                            <canvas id="oilChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </template>

                <!-- Oil Records Table -->
                <template x-if="oilRecords.length > 0">
                    <table class="pf-v5-c-table pf-m-grid-md">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Hours</th>
                                <th>Qty (qt)</th>
                                <th>Level After</th>
                                <th>Type</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="record in oilRecords" :key="record.id">
                                <tr>
                                    <td x-text="formatDate(record.date)"></td>
                                    <td x-text="formatHours(record.flight_hours)"></td>
                                    <td x-text="record.quantity_added"></td>
                                    <td x-text="record.level_after || '-'"></td>
                                    <td x-text="record.oil_type || '-'"></td>
                                    <td x-text="record.notes || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </template>
            </div>
        </div>

        <!-- Fuel Tab -->
        <div x-show="activeTab === 'fuel'" class="pf-v5-c-page__main-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Fuel Consumption</h2>
                <button class="pf-v5-c-button pf-m-primary" @click="openFuelModal()">
                    <i class="fas fa-plus"></i> Add Fuel Record
                </button>
            </div>

            <!-- Loading -->
            <div x-show="!fuelLoaded" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading fuel records...</h2>
                </div>
            </div>

            <div x-show="fuelLoaded" x-cloak>
                <!-- Empty State -->
                <template x-if="fuelRecords.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-gas-pump" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No fuel records</h2>
                            <div class="pf-v5-c-empty-state__body">
                                Track fuel consumption by adding records each time you refuel.
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Fuel Chart -->
                <template x-if="fuelRecords.length >= 2">
                    <div class="pf-v5-c-card" style="margin-bottom: 1rem;">
                        <div class="pf-v5-c-card__title"><h3>Fuel Consumption Trend (Gallons per Hour)</h3></div>
                        <div class="pf-v5-c-card__body">
                            <canvas id="fuelChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </template>

                <!-- Fuel Records Table -->
                <template x-if="fuelRecords.length > 0">
                    <table class="pf-v5-c-table pf-m-grid-md">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Hours</th>
                                <th>Qty (gal)</th>
                                <th>Level After</th>
                                <th>Type</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="record in fuelRecords" :key="record.id">
                                <tr>
                                    <td x-text="formatDate(record.date)"></td>
                                    <td x-text="formatHours(record.flight_hours)"></td>
                                    <td x-text="record.quantity_added"></td>
                                    <td x-text="record.level_after || '-'"></td>
                                    <td x-text="record.fuel_type || '-'"></td>
                                    <td x-text="record.notes || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </template>
            </div>
        </div>

        <!-- Documents Tab -->
        <div x-show="activeTab === 'documents'" class="pf-v5-c-page__main-section">
            <!-- Loading State for Documents -->
            <div x-show="documentsLoading" class="pf-v5-c-empty-state">
                <div class="pf-v5-c-empty-state__content">
                    <div class="loading-spinner" style="width: 2rem; height: 2rem;"></div>
                    <h2 class="pf-v5-c-title pf-m-lg">Loading documents...</h2>
                </div>
            </div>

            <!-- Documents Content -->
            <div x-show="!documentsLoading" x-cloak>
                <!-- Empty State -->
                <template x-if="documentCollections.length === 0 && uncollectedDocuments.length === 0">
                    <div class="pf-v5-c-empty-state">
                        <div class="pf-v5-c-empty-state__content">
                            <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                            <h2 class="pf-v5-c-title pf-m-lg">No documents</h2>
                            <div class="pf-v5-c-empty-state__body">
                                No documents have been uploaded for this aircraft yet.
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Document Collections -->
                <div class="pf-v5-l-stack pf-m-gutter" x-show="documentCollections.length > 0 || uncollectedDocuments.length > 0">
                    <!-- Collections -->
                    <template x-for="collection in documentCollections" :key="collection.id">
                        <div class="pf-v5-c-card">
                            <div class="pf-v5-c-card__header">
                                <div class="pf-v5-c-card__header-main">
                                    <div class="pf-v5-c-card__title">
                                        <h2 x-text="collection.name"></h2>
                                    </div>
                                </div>
                                <div class="pf-v5-c-card__actions">
                                    <span class="pf-v5-c-label pf-m-blue">
                                        <span x-text="collection.document_count"></span> pages
                                    </span>
                                </div>
                            </div>
                            <template x-if="collection.description">
                                <div class="pf-v5-c-card__body">
                                    <p x-text="collection.description" style="color: var(--pf-v5-global--Color--200);"></p>
                                </div>
                            </template>
                            <div class="pf-v5-c-card__body">
                                <div class="document-grid">
                                    <template x-for="doc in collection.documents" :key="doc.id">
                                        <div class="document-item" @click="openDocumentViewer(doc, collection.name)">
                                            <div class="document-thumbnail">
                                                <template x-if="doc.images && doc.images.length > 0">
                                                    <img :src="doc.images[0].image" :alt="doc.name">
                                                </template>
                                                <template x-if="!doc.images || doc.images.length === 0">
                                                    <div class="document-placeholder">
                                                        <i class="fas fa-file-alt"></i>
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="document-info">
                                                <span class="document-name" x-text="doc.name"></span>
                                                <span class="document-type" x-text="doc.doc_type_display"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Uncollected Documents -->
                    <template x-if="uncollectedDocuments.length > 0">
                        <div class="pf-v5-c-card">
                            <div class="pf-v5-c-card__header">
                                <div class="pf-v5-c-card__header-main">
                                    <div class="pf-v5-c-card__title">
                                        <h2>Other Documents</h2>
                                    </div>
                                </div>
                                <div class="pf-v5-c-card__actions">
                                    <span class="pf-v5-c-label pf-m-grey">
                                        <span x-text="uncollectedDocuments.length"></span> documents
                                    </span>
                                </div>
                            </div>
                            <div class="pf-v5-c-card__body">
                                <div class="document-grid">
                                    <template x-for="doc in uncollectedDocuments" :key="doc.id">
                                        <div class="document-item" @click="openDocumentViewer(doc, 'Other Documents')">
                                            <div class="document-thumbnail">
                                                <template x-if="doc.images && doc.images.length > 0">
                                                    <img :src="doc.images[0].image" :alt="doc.name">
                                                </template>
                                                <template x-if="!doc.images || doc.images.length === 0">
                                                    <div class="document-placeholder">
                                                        <i class="fas fa-file-alt"></i>
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="document-info">
                                                <span class="document-name" x-text="doc.name"></span>
                                                <span class="document-type" x-text="doc.doc_type_display"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div class="pf-v5-c-backdrop" x-show="viewerOpen" x-cloak @click.self="closeDocumentViewer()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg document-viewer-modal" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeDocumentViewer()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="viewerDocument?.name"></h1>
                    <div class="pf-v5-c-modal-box__description">
                        <span x-text="viewerCollectionName"></span>
                        <span class="pf-v5-c-label pf-m-blue pf-m-compact" style="margin-left: 0.5rem;" x-text="viewerDocument?.doc_type_display"></span>
                    </div>
                </header>

                <div class="pf-v5-c-modal-box__body document-viewer-body">
                    <template x-if="viewerDocument?.description">
                        <p style="margin-bottom: 1rem; color: var(--pf-v5-global--Color--200);" x-text="viewerDocument.description"></p>
                    </template>

                    <!-- Image Navigation -->
                    <template x-if="viewerDocument?.images && viewerDocument.images.length > 0">
                        <div class="document-viewer-images">
                            <!-- Image Counter -->
                            <div class="image-counter" x-show="viewerDocument.images.length > 1">
                                <span x-text="viewerImageIndex + 1"></span> / <span x-text="viewerDocument.images.length"></span>
                            </div>

                            <!-- Main Image -->
                            <div class="viewer-image-container">
                                <button class="nav-button nav-prev" @click="prevImage()" x-show="viewerDocument.images.length > 1 && viewerImageIndex > 0">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <img :src="viewerDocument.images[viewerImageIndex]?.image" :alt="viewerDocument.name" class="viewer-image">
                                <button class="nav-button nav-next" @click="nextImage()" x-show="viewerDocument.images.length > 1 && viewerImageIndex < viewerDocument.images.length - 1">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>

                            <!-- Image Notes -->
                            <template x-if="viewerDocument.images[viewerImageIndex]?.notes">
                                <p class="image-notes" x-text="viewerDocument.images[viewerImageIndex].notes"></p>
                            </template>

                            <!-- Thumbnail Strip -->
                            <div class="thumbnail-strip" x-show="viewerDocument.images.length > 1">
                                <template x-for="(img, idx) in viewerDocument.images" :key="img.id">
                                    <div class="thumbnail"
                                         :class="{ 'active': idx === viewerImageIndex }"
                                         @click="viewerImageIndex = idx">
                                        <img :src="img.image" :alt="`Page ${idx + 1}`">
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template x-if="!viewerDocument?.images || viewerDocument.images.length === 0">
                        <div class="pf-v5-c-empty-state">
                            <div class="pf-v5-c-empty-state__content">
                                <i class="fas fa-image" style="font-size: 3rem; color: var(--pf-v5-global--disabled-color--100);"></i>
                                <h2 class="pf-v5-c-title pf-m-lg">No images</h2>
                                <div class="pf-v5-c-empty-state__body">
                                    This document has no attached images.
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Squawk Modal -->
    <div class="pf-v5-c-backdrop" x-show="squawkModalOpen" x-cloak @click.self="closeSquawkModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeSquawkModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingSquawk ? 'Edit Squawk' : 'New Squawk'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitSquawk" class="pf-v5-c-form">
                        <!-- Priority -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="squawk-priority">
                                <span class="pf-v5-c-form__label-text">Priority</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select id="squawk-priority" class="pf-v5-c-form-control" x-model="squawkForm.priority" required>
                                    <option value="0">Ground Aircraft</option>
                                    <option value="1">Fix Soon</option>
                                    <option value="2">Fix at Next Inspection</option>
                                    <option value="3">Fix Eventually</option>
                                </select>
                            </div>
                        </div>

                        <!-- Component (Optional) -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="squawk-component">
                                <span class="pf-v5-c-form__label-text">Component (Optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <select id="squawk-component" class="pf-v5-c-form-control" x-model="squawkForm.component">
                                    <option value="">-- No specific component --</option>
                                    <template x-for="comp in components" :key="comp.id">
                                        <option :value="comp.id" x-text="getComponentTypeName(comp) + (comp.install_location ? ' (' + comp.install_location + ')' : '')"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Issue Reported -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="squawk-issue">
                                <span class="pf-v5-c-form__label-text">Issue Description</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="squawk-issue" class="pf-v5-c-form-control" rows="3" x-model="squawkForm.issue_reported" required placeholder="Describe the issue..."></textarea>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="squawk-notes">
                                <span class="pf-v5-c-form__label-text">Notes (Optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="squawk-notes" class="pf-v5-c-form-control" rows="2" x-model="squawkForm.notes" placeholder="Additional notes..."></textarea>
                            </div>
                        </div>

                        <!-- Grounding Warning -->
                        <template x-if="squawkForm.priority === '0' || squawkForm.priority === 0">
                            <div class="pf-v5-c-alert pf-m-warning pf-m-inline" role="alert">
                                <div class="pf-v5-c-alert__icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="pf-v5-c-alert__description">
                                    This squawk will ground the aircraft until resolved.
                                </div>
                            </div>
                        </template>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitSquawk" :disabled="squawkSubmitting">
                        <span x-show="!squawkSubmitting" x-text="editingSquawk ? 'Save Changes' : 'Create Squawk'"></span>
                        <span x-show="squawkSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeSquawkModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="pf-v5-c-backdrop" x-show="noteModalOpen" x-cloak @click.self="closeNoteModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeNoteModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title" x-text="editingNote ? 'Edit Note' : 'Add Note'"></h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitNote" class="pf-v5-c-form">
                        <!-- Note Text -->
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="note-text">
                                <span class="pf-v5-c-form__label-text">Note</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="note-text" class="pf-v5-c-form-control" rows="5" x-model="noteForm.text" required placeholder="Enter your note..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitNote" :disabled="noteSubmitting">
                        <span x-show="!noteSubmitting" x-text="editingNote ? 'Save Changes' : 'Add Note'"></span>
                        <span x-show="noteSubmitting">Saving...</span>
                    </button>
                    <template x-if="editingNote">
                        <button class="pf-v5-c-button pf-m-danger" @click="deleteNote" :disabled="noteSubmitting">
                            Delete
                        </button>
                    </template>
                    <button class="pf-v5-c-button pf-m-link" @click="closeNoteModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- All Notes Modal -->
    <div class="pf-v5-c-backdrop" x-show="showAllNotes" x-cloak @click.self="showAllNotes = false">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-lg" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="showAllNotes = false" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">All Notes</h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <div class="notes-list notes-list-full">
                        <template x-for="note in aircraftNotes" :key="note.id">
                            <div class="note-item" @click="editNote(note); showAllNotes = false;">
                                <p class="note-text" x-text="note.text"></p>
                                <div class="note-meta">
                                    <span x-text="formatDate(note.added_timestamp)"></span>
                                    <template x-if="note.added_by_username">
                                        <span> - <span x-text="note.added_by_username"></span></span>
                                    </template>
                                    <template x-if="note.edited_timestamp">
                                        <span class="note-edited">(edited)</span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="openNoteModal(); showAllNotes = false;">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="showAllNotes = false">Close</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Oil Record Modal -->
    <div class="pf-v5-c-backdrop" x-show="oilModalOpen" x-cloak @click.self="closeOilModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeOilModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Add Oil Record</h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitOilRecord" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-date">
                                <span class="pf-v5-c-form__label-text">Date</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="date" id="oil-date" class="pf-v5-c-form-control" x-model="oilForm.date" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-quantity">
                                <span class="pf-v5-c-form__label-text">Quantity Added (quarts)</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.25" min="0" id="oil-quantity" class="pf-v5-c-form-control" x-model="oilForm.quantity_added" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-level">
                                <span class="pf-v5-c-form__label-text">Level After (quarts, optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.25" min="0" id="oil-level" class="pf-v5-c-form-control" x-model="oilForm.level_after">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-hours">
                                <span class="pf-v5-c-form__label-text">Aircraft Hours</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="oil-hours" class="pf-v5-c-form-control" x-model="oilForm.flight_hours" :placeholder="formatHours(aircraft?.flight_time)">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-type">
                                <span class="pf-v5-c-form__label-text">Oil Type (optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="text" id="oil-type" class="pf-v5-c-form-control" x-model="oilForm.oil_type" placeholder="e.g. Aeroshell W100">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="oil-notes">
                                <span class="pf-v5-c-form__label-text">Notes (optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="oil-notes" class="pf-v5-c-form-control" rows="2" x-model="oilForm.notes"></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitOilRecord" :disabled="oilSubmitting">
                        <span x-show="!oilSubmitting">Add Record</span>
                        <span x-show="oilSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeOilModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Fuel Record Modal -->
    <div class="pf-v5-c-backdrop" x-show="fuelModalOpen" x-cloak @click.self="closeFuelModal()">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="closeFuelModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Add Fuel Record</h1>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submitFuelRecord" class="pf-v5-c-form">
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-date">
                                <span class="pf-v5-c-form__label-text">Date</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="date" id="fuel-date" class="pf-v5-c-form-control" x-model="fuelForm.date" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-quantity">
                                <span class="pf-v5-c-form__label-text">Quantity Added (gallons)</span>
                                <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="fuel-quantity" class="pf-v5-c-form-control" x-model="fuelForm.quantity_added" required>
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-level">
                                <span class="pf-v5-c-form__label-text">Level After (gallons, optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="fuel-level" class="pf-v5-c-form-control" x-model="fuelForm.level_after">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-hours">
                                <span class="pf-v5-c-form__label-text">Aircraft Hours</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="number" step="0.1" min="0" id="fuel-hours" class="pf-v5-c-form-control" x-model="fuelForm.flight_hours" :placeholder="formatHours(aircraft?.flight_time)">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-type">
                                <span class="pf-v5-c-form__label-text">Fuel Type (optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <input type="text" id="fuel-type" class="pf-v5-c-form-control" x-model="fuelForm.fuel_type" placeholder="e.g. 100LL">
                            </div>
                        </div>
                        <div class="pf-v5-c-form__group">
                            <label class="pf-v5-c-form__label" for="fuel-notes">
                                <span class="pf-v5-c-form__label-text">Notes (optional)</span>
                            </label>
                            <div class="pf-v5-c-form__group-control">
                                <textarea id="fuel-notes" class="pf-v5-c-form-control" rows="2" x-model="fuelForm.notes"></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary" @click="submitFuelRecord" :disabled="fuelSubmitting">
                        <span x-show="!fuelSubmitting">Add Record</span>
                        <span x-show="fuelSubmitting">Saving...</span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link" @click="closeFuelModal()">Cancel</button>
                </footer>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/aircraft-detail.js' %}"></script>
{% endblock %}
