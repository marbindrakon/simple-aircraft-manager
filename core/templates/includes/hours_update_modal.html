<div x-data="hoursUpdateModal()" @open-hours-modal.window="open($event.detail.aircraft)" x-cloak>
    <div class="pf-v5-c-backdrop" x-show="isOpen" @click.self="close">
        <div class="pf-v5-l-bullseye">
            <div class="pf-v5-c-modal-box pf-m-md" @click.stop>
                <button class="pf-v5-c-button pf-m-plain" type="button" aria-label="Close" @click="close" style="position: absolute; top: 1rem; right: 1rem;">
                    <i class="fas fa-times"></i>
                </button>

                <header class="pf-v5-c-modal-box__header">
                    <h1 class="pf-v5-c-modal-box__title">Update Aircraft Hours</h1>
                    <div class="pf-v5-c-modal-box__description" x-show="aircraft">
                        <span x-text="aircraft?.tail_number"></span>
                    </div>
                </header>

                <div class="pf-v5-c-modal-box__body">
                    <form @submit.prevent="submit">
                        <div class="pf-v5-c-form">
                            <!-- Current Hours (Read-only) -->
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label">
                                    <span class="pf-v5-c-form__label-text">Current Hours:</span>
                                </label>
                                <p class="pf-v5-u-font-size-2xl pf-v5-u-font-weight-bold" x-text="currentHours"></p>
                            </div>

                            <!-- New Hours Input -->
                            <div class="pf-v5-c-form__group">
                                <label class="pf-v5-c-form__label" for="new-hours">
                                    <span class="pf-v5-c-form__label-text">New Hours:</span>
                                    <span class="pf-v5-c-form__label-required" aria-hidden="true">*</span>
                                </label>
                                <input type="number"
                                       id="new-hours"
                                       class="pf-v5-c-form-control"
                                       x-model="newHours"
                                       step="0.1"
                                       :min="currentHours"
                                       required>
                            </div>

                            <!-- Hours Added (Calculated) -->
                            <div class="pf-v5-c-form__group" x-show="hoursAdded > 0">
                                <label class="pf-v5-c-form__label">
                                    <span class="pf-v5-c-form__label-text">Hours Added:</span>
                                </label>
                                <p class="pf-v5-u-font-size-xl pf-v5-u-font-weight-bold pf-v5-u-success-color-100"
                                   x-text="`+${hoursAdded}`"></p>
                            </div>

                            <!-- Info: Components auto-update -->
                            <div class="pf-v5-c-alert pf-m-info pf-m-inline" role="alert">
                                <div class="pf-v5-c-alert__icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="pf-v5-c-alert__description">
                                    All in-service components will be automatically updated with these hours.
                                </div>
                            </div>

                            <!-- Error message -->
                            <div class="pf-v5-c-alert pf-m-danger pf-m-inline" role="alert" x-show="errorMessage" x-cloak>
                                <div class="pf-v5-c-alert__icon">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="pf-v5-c-alert__description" x-text="errorMessage"></div>
                            </div>
                        </div>
                    </form>
                </div>

                <footer class="pf-v5-c-modal-box__footer">
                    <button class="pf-v5-c-button pf-m-primary"
                            @click="submit"
                            :disabled="submitting || !canSubmit">
                        <span x-show="!submitting">Update Hours</span>
                        <span x-show="submitting">
                            <span class="loading-spinner"></span>
                            Updating...
                        </span>
                    </button>
                    <button class="pf-v5-c-button pf-m-link"
                            @click="close"
                            :disabled="submitting">
                        Cancel
                    </button>
                </footer>
            </div>
        </div>
    </div>
</div>

<script>
function hoursUpdateModal() {
    return {
        isOpen: false,
        aircraft: null,
        currentHours: 0,
        newHours: 0,
        submitting: false,
        errorMessage: '',

        get hoursAdded() {
            const delta = this.newHours - this.currentHours;
            return delta > 0 ? delta.toFixed(1) : 0;
        },

        get canSubmit() {
            return this.newHours >= this.currentHours && !this.submitting;
        },

        open(aircraft) {
            this.aircraft = aircraft;
            this.currentHours = parseFloat(aircraft.flight_time) || 0;
            this.newHours = this.currentHours;
            this.errorMessage = '';
            this.isOpen = true;
        },

        close() {
            this.isOpen = false;
            this.reset();
        },

        reset() {
            setTimeout(() => {
                this.aircraft = null;
                this.currentHours = 0;
                this.newHours = 0;
                this.submitting = false;
                this.errorMessage = '';
            }, 300);
        },

        async submit() {
            if (this.submitting || !this.canSubmit) return;

            this.submitting = true;
            this.errorMessage = '';

            try {
                const response = await fetch(
                    `/api/aircraft/${this.aircraft.id}/update_hours/`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            new_hours: this.newHours
                        })
                    }
                );

                const data = await response.json();

                if (data.success) {
                    showNotification(
                        `Hours updated to ${data.aircraft_hours} (+${data.hours_added} hours, ${data.components_updated} components updated)`,
                        'success'
                    );

                    // Notify other components to refresh
                    window.dispatchEvent(new CustomEvent('aircraft-updated'));

                    this.close();
                } else {
                    this.errorMessage = data.error || 'Update failed';
                }
            } catch (error) {
                console.error('Error updating hours:', error);
                this.errorMessage = 'Network error occurred';
            } finally {
                this.submitting = false;
            }
        }
    }
}
</script>
