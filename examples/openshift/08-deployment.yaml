# Application Deployment
# Multi-container pod: Django app + nginx sidecar
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sam
  namespace: sam
  annotations:
    # Uncomment if using ArgoCD
    # argocd.argoproj.io/sync-wave: '3'
spec:
  replicas: 1  # Increase for HA (requires RWX media storage)
  selector:
    matchLabels:
      app: sam
  template:
    metadata:
      labels:
        app: sam
    spec:
      # Init Container: Copy static files to shared volume
      # Runs before main containers start
      initContainers:
      - name: collect-static
        # IMPORTANT: Update to your container registry and image
        image: quay.io/your-org/simple-aircraft-manager:latest
        imagePullPolicy: Always  # Always pull to get latest image
        command: ['sh', '-c', 'cp -r /opt/app-root/src/staticfiles/. /mnt/static/']
        volumeMounts:
        - name: staticfiles
          mountPath: /mnt/static

      containers:
      # Main Container: Django Application (Gunicorn)
      - name: sam
        # IMPORTANT: Update to your container registry and image
        image: quay.io/your-org/simple-aircraft-manager:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8000
          name: gunicorn

        # Environment Configuration
        envFrom:
        # Load non-sensitive config from ConfigMap
        - configMapRef:
            name: sam-config
        # Load sensitive secrets
        - secretRef:
            name: sam

        # Database Connection (from PGO-generated secret)
        env:
        - name: DATABASE_HOST
          valueFrom:
            secretKeyRef:
              name: sam-db-pguser-sam-db
              key: host
        - name: DATABASE_PORT
          valueFrom:
            secretKeyRef:
              name: sam-db-pguser-sam-db
              key: port
        - name: DATABASE_NAME
          valueFrom:
            secretKeyRef:
              name: sam-db-pguser-sam-db
              key: dbname
        - name: DATABASE_USER
          valueFrom:
            secretKeyRef:
              name: sam-db-pguser-sam-db
              key: user
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: sam-db-pguser-sam-db
              key: password

        # Volume Mounts
        volumeMounts:
        - name: media
          mountPath: /opt/app-root/src/mediafiles

        # Resource Limits
        # Note: AI-powered logbook import can use significant memory during
        # image processing. If using this feature, 2Gi limit is recommended.
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 2Gi  # Adjust based on workload

      # Sidecar Container: nginx (TLS + Static/Media Serving)
      - name: nginx
        image: registry.access.redhat.com/ubi9/nginx-124:latest
        imagePullPolicy: IfNotPresent
        command: ['nginx', '-g', 'daemon off;']
        ports:
        - containerPort: 8443
          name: https

        # Volume Mounts
        volumeMounts:
        - name: staticfiles
          mountPath: /opt/app-root/src/static
          readOnly: true
        - name: media
          mountPath: /opt/app-root/src/media
          readOnly: true
        - name: nginx-config
          mountPath: /opt/app-root/etc/nginx.d/sam.conf
          subPath: sam.conf
          readOnly: true
        - name: tls
          mountPath: /etc/nginx/tls
          readOnly: true

        # Health Checks
        livenessProbe:
          httpGet:
            path: /healthz/
            port: 8443
            scheme: HTTPS
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /healthz/
            port: 8443
            scheme: HTTPS
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5

        # Resource Limits
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            memory: 128Mi

      # Volumes
      volumes:
      # Media files (persistent, shared across pods)
      - name: media
        persistentVolumeClaim:
          claimName: sam-media
      # Static files (ephemeral, populated by init container)
      - name: staticfiles
        emptyDir: {}
      # nginx configuration
      - name: nginx-config
        configMap:
          name: sam-nginx-config
      # TLS certificate (auto-generated by OpenShift or cert-manager)
      - name: tls
        secret:
          secretName: sam-nginx-tls
