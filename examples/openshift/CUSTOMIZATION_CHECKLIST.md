# Deployment Customization Checklist

Use this checklist when deploying Simple Aircraft Manager to your OpenShift/Kubernetes cluster.

## ‚úÖ Pre-Deployment Checklist

### Prerequisites
- [ ] Crunchy Postgres Operator (PGO) v5.x installed
- [ ] External Secrets Operator installed (if using Vault/external secrets)
- [ ] Storage classes available (RWO for database, RWX for media files)
- [ ] Container image built and pushed to accessible registry
- [ ] Domain/hostname decided for the application

### Build and Push Container
- [ ] Built container image: `podman build -t <registry>/<image>:tag -f Containerfile .`
- [ ] Pushed to registry: `podman push <registry>/<image>:tag`
- [ ] Registry is accessible from cluster (auth configured if private)

## üìù Manifest Customization

### 01-namespace.yaml
- [ ] No changes needed (unless changing namespace name from `sam`)

### 02-configmap.yaml
- [ ] Update `DJANGO_ALLOWED_HOSTS` with your hostname
- [ ] Update `DJANGO_CSRF_TRUSTED_ORIGINS` with your full URL
- [ ] Configure OIDC settings (or set `OIDC_ENABLED: "false"`)
  - [ ] `OIDC_OP_DISCOVERY_ENDPOINT` updated with your IdP URL
  - [ ] Other OIDC claims/scopes customized if needed
- [ ] Configure logbook import AI (optional)
  - [ ] `OLLAMA_BASE_URL` set if using local Ollama models
  - [ ] `LOGBOOK_IMPORT_EXTRA_MODELS` configured for additional models
  - [ ] `LOGBOOK_IMPORT_DEFAULT_MODEL` set if changing default

### 03-nginx-config.yaml
- [ ] Update `server_name` with your hostname
- [ ] Update CSP `form-action` if using OIDC (add your IdP domain)
- [ ] Review security headers (adjust if needed)

### 04-externalsecret.yaml
**Choose one:**

**Option A: Using External Secrets Operator**
- [ ] Update `secretStoreRef.name` to your ClusterSecretStore
- [ ] Update `dataFrom.extract.key` to your Vault path
- [ ] Ensure Vault/secret backend contains:
  - `DJANGO_SECRET_KEY`
  - `DJANGO_SUPERUSER_USERNAME`
  - `DJANGO_SUPERUSER_PASSWORD`
  - `DJANGO_SUPERUSER_EMAIL`
  - `OIDC_RP_CLIENT_ID` (if OIDC enabled)
  - `OIDC_RP_CLIENT_SECRET` (if OIDC enabled)
  - `ANTHROPIC_API_KEY` (if using AI logbook import)

**Option B: Using Plain Kubernetes Secret**
- [ ] Comment out ExternalSecret resource
- [ ] Uncomment plain Secret example
- [ ] Generate Django secret key: `python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'`
- [ ] Update all secret values
- [ ] **Important:** Encode sensitive values or use `stringData`

### 05-pg-init-sql.yaml
- [ ] No changes needed

### 06-postgrescluster.yaml
- [ ] Adjust `instances.replicas` (1 for dev, 2+ for HA)
- [ ] Adjust storage sizes:
  - [ ] `dataVolumeClaimSpec.resources.requests.storage` (database)
  - [ ] `backups.pgbackrest.repos[0].volume.resources.requests.storage` (backups)
- [ ] Update storage class if needed (optional)

### 07-pvc.yaml
- [ ] **Required:** Update `storageClassName` to your RWX storage class
- [ ] Adjust `storage` size based on media upload needs

### 08-deployment.yaml
- [ ] **Required:** Update `image` in both `initContainers` and `containers.sam`
  - `image: your-registry/simple-aircraft-manager:latest`
- [ ] Review and adjust resource limits:
  - [ ] `containers.sam.resources`
  - [ ] `containers.nginx.resources`
- [ ] Adjust `replicas` for scaling (requires RWX media storage)

### 09-service.yaml
- [ ] Review certificate generation method:
  - **Option A:** Using OpenShift service-serving cert (annotation present)
  - **Option B:** Using cert-manager (remove annotation, create Certificate)
  - **Option C:** Manual cert (remove annotation, create TLS secret manually)
- [ ] Uncomment `sessionAffinity` if scaling without external session store

### 10-route.yaml
- [ ] **Required:** Update `spec.host` with your hostname
- [ ] Review TLS termination type (`reencrypt` vs `passthrough`)
- [ ] If using custom edge cert, uncomment and provide cert/key

## üîê Security Checklist

### Secrets Management
- [ ] All secrets stored securely (Vault, sealed secrets, or encrypted at rest)
- [ ] Django secret key is random and at least 50 characters
- [ ] Superuser password is strong and unique
- [ ] OIDC client secret is stored securely
- [ ] Database passwords auto-generated by PGO (no manual intervention)

### Network Security
- [ ] HTTPS enforced (`insecureEdgeTerminationPolicy: Redirect`)
- [ ] Security headers configured in nginx
- [ ] CSP configured appropriately for CDNs used
- [ ] NetworkPolicies applied (optional but recommended)

### OIDC Configuration
- [ ] OIDC client created in identity provider
- [ ] Redirect URIs registered: `https://your-app.example.com/oidc/callback/`
- [ ] Post-logout redirect URIs registered: `https://your-app.example.com/`
- [ ] Client scopes include: `openid`, `email`, `profile`
- [ ] Client type set to `confidential`
- [ ] Client secret copied to secrets

## üöÄ Deployment Steps

### 1. Create Namespace
```bash
oc apply -f 01-namespace.yaml
```

### 2. Create Configuration
```bash
oc apply -f 02-configmap.yaml
oc apply -f 03-nginx-config.yaml
oc apply -f 04-externalsecret.yaml  # Or your plain Secret
oc apply -f 05-pg-init-sql.yaml
```

### 3. Create Storage and Database
```bash
oc apply -f 06-postgrescluster.yaml
oc apply -f 07-pvc.yaml

# Wait for database to be ready (may take 2-5 minutes)
oc wait --for=condition=Ready postgrescluster/sam-db -n sam --timeout=300s
```

### 4. Deploy Application
```bash
oc apply -f 08-deployment.yaml
oc apply -f 09-service.yaml
oc apply -f 10-route.yaml
```

### 5. Verify Deployment
```bash
# Check pod status
oc get pods -n sam

# Check logs
oc logs -f deployment/sam -n sam -c sam
oc logs -f deployment/sam -n sam -c nginx

# Check database status
oc get postgrescluster -n sam

# Get route URL
oc get route sam -n sam -o jsonpath='{.spec.host}'
```

## ‚úÖ Post-Deployment Verification

### Application Health
- [ ] Pods are running: `oc get pods -n sam`
- [ ] No errors in logs: `oc logs deployment/sam -n sam -c sam`
- [ ] Health endpoint returns 200: `curl -k https://<your-host>/healthz/`

### Database Connectivity
- [ ] Database cluster is ready: `oc get postgrescluster sam-db -n sam`
- [ ] App can connect to database (check app logs)
- [ ] Migrations applied successfully (check app startup logs)

### Web Access
- [ ] Route is accessible: `https://<your-hostname>`
- [ ] HTTP redirects to HTTPS
- [ ] Login page loads
- [ ] Static files load (CSS/JS)
- [ ] Can log in with superuser credentials

### OIDC (if enabled)
- [ ] "Sign in with <Provider>" button visible
- [ ] OIDC redirect works
- [ ] Can authenticate via OIDC
- [ ] User created in Django after first OIDC login

### Media Uploads
- [ ] Can upload aircraft images
- [ ] Can upload squawk attachments
- [ ] Can upload logbook page images (if using AI import)
- [ ] Files persist after pod restart
- [ ] Images display correctly

### Logbook Import (if configured)
- [ ] AI model selector shows available models
- [ ] Can upload and process logbook page images
- [ ] Ollama models accessible (if configured)

## üîß Common Issues

### Pod CrashLoopBackOff
- Check logs: `oc logs deployment/sam -n sam -c sam`
- Common causes:
  - Missing required environment variables
  - Database not ready
  - Invalid secret key
  - ALLOWED_HOSTS mismatch

### Static Files Not Loading
- Check init container logs: `oc logs deployment/sam -n sam -c collect-static`
- Check nginx logs: `oc logs deployment/sam -n sam -c nginx`
- Verify staticfiles volume mounted correctly

### Database Connection Refused
- Check PGO cluster: `oc get postgrescluster -n sam`
- Check PGO pods: `oc get pods -l postgres-operator.crunchydata.com/cluster=sam-db -n sam`
- Verify secret exists: `oc get secret sam-db-pguser-sam-db -n sam`

### OIDC Login Fails
- Check OIDC config in logs: `oc logs deployment/sam -n sam -c sam | grep OIDC`
- Verify redirect URIs match in IdP
- Check CSP allows IdP domain: `curl -I https://<your-host>/ | grep Content-Security-Policy`
- Test discovery endpoint: `curl <OIDC_OP_DISCOVERY_ENDPOINT>`

### Media Files Not Persisting
- Check PVC status: `oc get pvc sam-media -n sam`
- Verify storage class supports RWX: `oc get storageclass`
- Check volume mounted: `oc describe pod <pod-name> -n sam`

## üìä Monitoring

### Recommended Metrics
- [ ] Pod CPU/memory usage
- [ ] Database connection pool stats
- [ ] HTTP response times
- [ ] Error rates (4xx/5xx)
- [ ] Media storage usage

### Log Aggregation
- [ ] Application logs forwarded to logging platform
- [ ] nginx access logs forwarded
- [ ] Database logs forwarded

## üîÑ Maintenance

### Regular Tasks
- [ ] Review and rotate secrets quarterly
- [ ] Monitor storage usage
- [ ] Review and update container images
- [ ] Test backup/restore procedures
- [ ] Review access logs for anomalies

### Scaling
- [ ] Horizontal pod autoscaling configured (optional)
- [ ] Database replica set up for HA (optional)
- [ ] Load testing performed

---

**Need help?** See the full [README.md](README.md) for detailed documentation.
